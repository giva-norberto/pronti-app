<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Aprovação Manual de Pagamentos - Pronti ADM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="style.css">
    <style>
        /* Seus estilos originais, sem alterações */
        body { display: flex; font-family: 'Poppins', sans-serif; margin: 0; background: #f4f5f7; min-height: 100vh; }
        #menu-container { width: 250px; min-width: 250px; flex-shrink: 0; }
        main.content { flex-grow: 1; padding: 40px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header-pagina { margin-bottom: 30px; }
        .header-pagina h1 { color: #1e293b; font-size: 2rem; font-weight: 700; margin: 0 0 10px 0; }
        .header-pagina p { color: #64748b; margin: 0; font-size: 1.1rem; }
        .lista-pagamentos { display: flex; flex-direction: column; gap: 12px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-radius: 8px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 15px; }
        .info p { margin: 0; line-height: 1.5; }
        .info .nome { font-weight: 600; color: #334155; font-size: 1.08em; }
        .info .doc-id { font-size: 0.75em; color: #94a3b8; font-family: monospace; margin-top: 2px; }
        .info .plano { font-size: 0.9em; color: #64748b; margin-top: 5px; }
        .info .metodo { font-size: 0.75em; font-weight: 700; padding: 3px 8px; border-radius: 12px; margin-left: 8px; text-transform: uppercase; vertical-align: middle; }
        .metodo.pix, .metodo.aguardando_liberacao { background-color: #fef9c3; color: #a16207; }
        .metodo.mercado_pago, .metodo.pendente_confirmacao { background-color: #dbeafe; color: #2563eb; }
        .acoes button { border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.9em; }
        .btn-aprovar { background-color: #10b981; color: #fff; }
        .btn-aprovar:hover:not(:disabled) { background-color: #0f9e70; }
        .btn-aprovar:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #loading-message, #empty-message { text-align: center; padding: 40px; color: #64748b; background: #fff; border-radius: 8px; }
    </style>
</head>
<body>
    <aside id="menu-container"></aside>
    <main class="content">
        <div class="container">
            <div class="header-pagina">
                <h1>Aprovação Manual de Pagamentos</h1>
                <p>Libere o acesso para pagamentos de Pix ou Mercado Pago que precisam de intervenção.</p>
            </div>
            <div id="lista-pagamentos" class="lista-pagamentos">
                <p id="loading-message">Carregando pagamentos pendentes...</p>
            </div>
        </div>
    </main>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import {
            collection,
            query,
            where,
            onSnapshot,
            doc,
            runTransaction,
            deleteField,
            Timestamp,
            updateDoc,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';

        const ADMIN_UID = "BX6Q7HrVMrcCBqe72r7K76EBPkX2";
        const listaPagamentosDiv = document.getElementById('lista-pagamentos');
        const loadingMessage = document.getElementById('loading-message');

        let unsubscribePagamentos = null;
        let unsubscribeEmpresasPendente = null;
        let unsubscribeEmpresasPlano = null;

        // Mantivemos o layout exatamente como pediu e acrescentei apenas a lógica necessária para:
        // - mostrar valor do plano (procurando no pagamentoPendentes ou no pagamentoPendente do documento da empresa)
        // - mostrar tipo do pagamento (PIX, Mercado Pago, etc.) em badge
        // - permitir aprovar (atualiza empresa e, quando aplicável, marca pagamento como aprovado_manual)

        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === ADMIN_UID) {
                ouvirTodasAsPendencias();
            } else {
                if (unsubscribePagamentos) unsubscribePagamentos();
                if (unsubscribeEmpresasPendente) unsubscribeEmpresasPendente();
                if (unsubscribeEmpresasPlano) unsubscribeEmpresasPlano();
                listaPagamentosDiv.innerHTML = '<p id="empty-message">Acesso restrito a administradores.</p>';
            }
        });

        function ouvirTodasAsPendencias() {
            let pendenciasDaColecao = [];
            let pendenciasDoCampo = [];
            let pendenciasDoPlano = [];

            // Fonte 1: pagamentosPendentes (documentos)
            const pagamentosRef = collection(db, 'pagamentosPendentes');
            const qPagamentos = query(pagamentosRef, where('status', 'in', ['pendente_confirmacao', 'aguardando_pagamento_mp', 'aguardando_liberacao']));
            unsubscribePagamentos = onSnapshot(qPagamentos, (snapshot) => {
                pendenciasDaColecao = snapshot.docs.map(d => ({ id: d.id, tipo: 'colecao', ...d.data() }));
                renderizarListaCombinada();
            }, (err) => console.error('Erro ao ouvir pagamentosPendentes:', err));

            // Fonte 2: empresas com pagamentoPendente.status == 'aguardando_liberacao'
            const empresasRef = collection(db, 'empresarios');
            const qEmpresasPendente = query(empresasRef, where('pagamentoPendente.status', '==', 'aguardando_liberacao'));
            unsubscribeEmpresasPendente = onSnapshot(qEmpresasPendente, (snapshot) => {
                pendenciasDoCampo = snapshot.docs.map(d => {
                    const empresaData = d.data() || {};
                    const pagamentoPendente = empresaData.pagamentoPendente || {};
                    return {
                        id: d.id,
                        tipo: 'campo',
                        clienteNome: empresaData.nomeFantasia || pagamentoPendente.nome || 'Cliente desconhecido',
                        planoNome: pagamentoPendente.plano ? `Plano para ${pagamentoPendente.plano} usuários` : 'Plano',
                        valor: pagamentoPendente.valor ?? 0,
                        metodo: pagamentoPendente.metodo || 'pix',
                        dataCriacao: pagamentoPendente.dataSolicitacao || pagamentoPendente.createdAt || empresaData.updatedAt || empresaData.createdAt || null,
                        donoId: empresaData.donoId,
                        empresaId: d.id
                    };
                });
                renderizarListaCombinada();
            }, (err) => console.error('Erro ao ouvir empresas (pagamentoPendente):', err));

            // Fonte 3: empresas com plano == 'aguardando_liberacao' (se seu fluxo gravou nesse campo)
            const qEmpresasPlano = query(empresasRef, where('plano', '==', 'aguardando_liberacao'));
            unsubscribeEmpresasPlano = onSnapshot(qEmpresasPlano, (snapshot) => {
                // enriquecemos cada empresa tentando localizar um pagamento na coleção (para obter valor e metodo)
                (async () => {
                    const list = await Promise.all(snapshot.docs.map(async d => {
                        const empresaData = d.data() || {};

                        // preferir pagamentoPendente dentro do documento da empresa
                        const pagamentoPendente = empresaData.pagamentoPendente || null;
                        if (pagamentoPendente && pagamentoPendente.valor) {
                            return {
                                id: d.id,
                                tipo: 'campo',
                                clienteNome: empresaData.nomeFantasia || pagamentoPendente.nome || 'Cliente desconhecido',
                                planoNome: pagamentoPendente.plano ? `Plano para ${pagamentoPendente.plano} usuários` : 'Plano',
                                valor: pagamentoPendente.valor ?? 0,
                                metodo: pagamentoPendente.metodo || 'pix',
                                dataCriacao: pagamentoPendente.dataSolicitacao || pagamentoPendente.createdAt || empresaData.updatedAt || empresaData.createdAt || null,
                                donoId: empresaData.donoId,
                                empresaId: d.id
                            };
                        }

                        // se não houver, procurar na coleção pagamentosPendentes por empresaId
                        try {
                            const q = query(
                                collection(db, "pagamentosPendentes"),
                                where("empresaId", "==", d.id),
                                where("status", "in", ['pendente_confirmacao', 'aguardando_pagamento_mp', 'aguardando_liberacao'])
                            );
                            const snapPag = await getDocs(q);
                            if (!snapPag.empty) {
                                const pdoc = snapPag.docs[0];
                                const pdata = pdoc.data() || {};
                                return {
                                    id: pdoc.id,
                                    tipo: 'colecao',
                                    clienteNome: empresaData.nomeFantasia || pdata.nome || 'Cliente desconhecido',
                                    planoNome: pdata.plano ? `Plano para ${pdata.plano} usuários` : 'Plano',
                                    valor: pdata.valor ?? pdata.amount ?? 0,
                                    metodo: pdata.metodo || pdata.paymentMethod || 'desconhecido',
                                    dataCriacao: pdata.createdAt || pdata.dataSolicitacao || null,
                                    donoId: empresaData.donoId,
                                    empresaId: d.id
                                };
                            }
                        } catch (err) {
                            console.warn('Erro buscando pagamentosPendentes para empresa', d.id, err);
                        }

                        // fallback: criar entrada genérica para o admin revisar (valor pode ser 0)
                        return {
                            id: d.id,
                            tipo: 'plano',
                            clienteNome: empresaData.nomeFantasia || 'Cliente desconhecido',
                            planoNome: 'Aguardando liberação (plano)',
                            valor: empresaData.valorPendencia ?? 0,
                            metodo: 'aguardando_liberacao',
                            dataCriacao: empresaData.updatedAt || empresaData.createdAt || null,
                            donoId: empresaData.donoId,
                            empresaId: d.id
                        };
                    }));
                    pendenciasDoPlano = list;
                    renderizarListaCombinada();
                })().catch(err => console.error('Erro ao processar empresas (plano aguardando):', err));
            }, (err) => console.error('Erro ao ouvir empresas (plano aguardando):', err));

            // utilitárias
            function normalizeDate(value) {
                if (!value) return null;
                if (typeof value.toDate === 'function') return value.toDate();
                if (value instanceof Date) return value;
                const parsed = new Date(value);
                return isNaN(parsed) ? null : parsed;
            }

            function safeCssClassForMetodo(metodo) {
                if (!metodo) return 'desconhecido';
                return String(metodo).toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_-]/g, '');
            }

            function metodoLabelHumanizado(metodo) {
                if (!metodo) return 'Desconhecido';
                const m = String(metodo).toLowerCase();
                if (m.includes('pix')) return 'PIX';
                if (m.includes('mercado') || m.includes('mercadopago') || m.includes('mp')) return 'Mercado Pago';
                if (m.includes('boleto')) return 'Boleto';
                if (m === 'aguardando_liberacao') return 'Aguardando liberação';
                return metodo;
            }

            function formatValor(valor) {
                const num = (typeof valor === 'number') ? valor : Number(valor);
                if (isNaN(num) || num === 0) return 'R$ 0,00';
                return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            // constrói lista única e renderiza
            function renderizarListaCombinada() {
                const mapByKey = new Map();

                pendenciasDaColecao.forEach(p => mapByKey.set(`pag#${p.id}`, p));
                pendenciasDoCampo.forEach(p => {
                    const key = `emp#${p.empresaId}`;
                    if (!mapByKey.has(key)) mapByKey.set(key, p);
                });
                pendenciasDoPlano.forEach(p => {
                    const key = `emp#${p.empresaId}`;
                    if (!mapByKey.has(key)) mapByKey.set(key, p);
                });

                const todasAsPendencias = Array.from(mapByKey.values());
                loadingMessage.style.display = 'none';

                if (todasAsPendencias.length === 0) {
                    listaPagamentosDiv.innerHTML = '<p id="empty-message">Nenhum pagamento pendente no momento.</p>';
                    return;
                }

                listaPagamentosDiv.innerHTML = '';
                todasAsPendencias.forEach(pagamento => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';

                    const metodoRaw = pagamento.metodo || pagamento.status || 'desconhecido';
                    const metodoClass = safeCssClassForMetodo(metodoRaw);
                    const metodoLabel = metodoLabelHumanizado(metodoRaw);
                    const dateObj = normalizeDate(pagamento.dataCriacao);
                    const dataFormatada = dateObj ? dateObj.toLocaleDateString('pt-BR') : 'Data indisponível';
                    const valorFormatado = formatValor(pagamento.valor ?? 0);
                    const clienteNome = pagamento.clienteNome || pagamento.nomeFantasia || 'Cliente desconhecido';
                    const docIdDisplay = pagamento.empresaId || pagamento.id || 'ID indisponível';
                    const planoNome = pagamento.planoNome || 'Plano';
                    const metodoTag = `<span class="metodo ${metodoClass}">${metodoLabel}</span>`;

                    // tipoBtn: 'colecao' (doc pagamentosPendentes) ou 'campo' (empresa)
                    const tipoBtn = (pagamento.tipo === 'colecao' || (pagamento.id && pagamento.tipo === 'colecao')) ? 'colecao' : 'campo';

                    itemDiv.innerHTML = `
                        <div class="info">
                            <p class="nome">${clienteNome}</p>
                            <p class="doc-id">ID da Empresa: ${docIdDisplay}</p>
                            <p class="plano">${planoNome} - ${valorFormatado} ${metodoTag} - ${dataFormatada}</p>
                        </div>
                        <div class="acoes">
                            <button class="btn-aprovar" data-id="${pagamento.id || pagamento.empresaId}" data-tipo="${tipoBtn}" data-empresa-id="${pagamento.empresaId || pagamento.id}">Aprovar</button>
                        </div>
                    `;
                    listaPagamentosDiv.appendChild(itemDiv);
                });
            }
        }

        // handler do botão Aprovar
        listaPagamentosDiv.addEventListener('click', async (e) => {
            if (!(e.target && e.target.classList.contains('btn-aprovar'))) return;
            const btn = e.target;
            const id = btn.dataset.id; // pagamento doc id ou empresaId
            const tipo = btn.dataset.tipo; // 'colecao' ou 'campo'
            const empresaId = btn.dataset.empresaId || id;

            if (!confirm(`Tem certeza de que deseja APROVAR este pagamento? Uma assinatura será iniciada.`)) return;

            btn.disabled = true;
            const previousText = btn.textContent;
            btn.textContent = 'Aprovando...';

            // validade padrão: +30 dias
            const dataFim = new Date();
            dataFim.setDate(dataFim.getDate() + 30);
            const proximoPagamentoTimestamp = Timestamp.fromDate(dataFim);

            try {
                if (tipo === 'colecao') {
                    // transação: atualiza empresa e marca pagamento em pagamentosPendentes
                    await runTransaction(db, async (transaction) => {
                        const pagRef = doc(db, "pagamentosPendentes", id);
                        const pagDoc = await transaction.get(pagRef);
                        if (!pagDoc.exists()) throw new Error("Documento do pagamento não existe mais.");

                        const dadosPagamento = pagDoc.data() || {};
                        const idEmpresaOriginal = dadosPagamento.empresaId;
                        if (!idEmpresaOriginal) throw new Error("empresaId faltando no documento de pagamento.");

                        const empresaRef = doc(db, "empresarios", idEmpresaOriginal);

                        transaction.update(empresaRef, {
                            plano: "pago",
                            status: "ativo",
                            assinaturaAtiva: true,
                            assinaturaValidaAte: proximoPagamentoTimestamp,
                            proximoPagamento: proximoPagamentoTimestamp,
                            freeEmDias: 0,
                            trialDisponivel: false,
                            pagamentoPendente: deleteField()
                        });

                        transaction.update(pagRef, { status: "aprovado_manual" });
                    });

                    alert('Pagamento aprovado! Acesso liberado por 30 dias.');
                    btn.textContent = 'Aprovado';
                    btn.disabled = true;
                    return;
                }

                // tipo 'campo' (empresa com pagamentoPendente ou plano aguardando)
                const empresaRef = doc(db, "empresarios", empresaId);

                await updateDoc(empresaRef, {
                    plano: "pago",
                    status: "ativo",
                    assinaturaAtiva: true,
                    assinaturaValidaAte: proximoPagamentoTimestamp,
                    proximoPagamento: proximoPagamentoTimestamp,
                    freeEmDias: 0,
                    trialDisponivel: false,
                    pagamentoPendente: deleteField()
                });

                // opcional: tentar marcar pagamentosPendentes relacionados como aprovados (não crítico)
                try {
                    const q = query(
                        collection(db, "pagamentosPendentes"),
                        where("empresaId", "==", empresaId),
                        where("status", "in", ['pendente_confirmacao', 'aguardando_pagamento_mp', 'aguardando_liberacao'])
                    );
                    const snap = await getDocs(q);
                    for (const pdoc of snap.docs) {
                        await updateDoc(doc(db, "pagamentosPendentes", pdoc.id), { status: "aprovado_manual" }).catch(()=>{});
                    }
                } catch (err) {
                    console.warn('Não foi possível atualizar pagamentosPendentes relacionados (opcional):', err);
                }

                alert('Pagamento aprovado! Acesso liberado por 30 dias.');
                btn.textContent = 'Aprovado';
                btn.disabled = true;
            } catch (error) {
                console.error("Erro ao aprovar pagamento:", error);
                alert('Falha ao aprovar: ' + (error?.message || error));
                btn.disabled = false;
                btn.textContent = previousText || 'Aprovar';
            }
        });
    </script>
</body>
</html>
