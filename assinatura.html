<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Assinatura Expirada - Pronti</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container-assinatura { background: #ffffff; border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); max-width: 450px; }
        .container-assinatura h1 { color: #1e293b; font-size: 2rem; margin-bottom: 15px; }
        .container-assinatura p { color: #64748b; font-size: 1.1rem; line-height: 1.6; margin-bottom: 30px; }
        .btn-assinar { display: block; width: 100%; background: #10b981; color: #fff; font-weight: 600; border: none; border-radius: 8px; padding: 15px 0; font-size: 1.1rem; cursor: pointer; text-decoration: none; }
        .btn-logout { background: none; border: none; color: #64748b; cursor: pointer; font-size: 1rem; text-decoration: underline; margin-top: 20px; }
        #loader { font-size: 1.2rem; color: #4f46e5; }
    </style>
</head>
<body>
    <div class="container-assinatura" id="assinatura-container" style="display:none;">
        <h1>Seu período de teste terminou!</h1>
        <p>Para continuar a usar nossos serviços, por favor, escolha um plano.</p>
        <!-- CORREÇÃO: O link agora tem um ID para ser modificado pelo JavaScript -->
        <a href="pagamento.html" id="btn-assinar" class="btn-assinar">Ver Planos e Assinar</a>
        <button id="btn-logout" class="btn-logout">Sair da conta</button>
    </div>
    <div id="loader"><p>Verificando sua assinatura...</p></div>

    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

        const container = document.getElementById('assinatura-container');
        const loader = document.getElementById('loader');
        const btnLogout = document.getElementById('btn-logout');
        // CORREÇÃO: Pegamos a referência do botão de assinar.
        const btnAssinar = document.getElementById('btn-assinar');

        async function checkStatusRapido() {
            return new Promise((resolve) => {
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        window.location.href = 'login.html';
                        return;
                    }
                    try {
                        const empresaAtivaId = localStorage.getItem('empresaAtivaId');
                        if (!empresaAtivaId) {
                            window.location.href = 'selecionar-empresa.html';
                            return;
                        }
                        
                        // ====================================================================
                        // CORREÇÃO: Atualiza a URL do botão com o ID da empresa ativa
                        // ====================================================================
                        btnAssinar.href = `pagamento.html?empresaId=${empresaAtivaId}`;

                        const empresaRef = doc(db, "empresarios", empresaAtivaId);
                        const empresaSnap = await getDoc(empresaRef);
                        if (!empresaSnap.exists()) {
                           window.location.href = 'selecionar-empresa.html';
                           return;
                        }
                        const empresaData = empresaSnap.data();
                        const userRef = doc(db, "usuarios", empresaData.donoId);
                        const userSnap = await getDoc(userRef);
                        if (!userSnap.exists() || userSnap.data().isPremium) {
                            resolve(true); // Está ativo
                            return;
                        }
                        const trialDays = empresaData.freeEmDias ?? 0;
                        if (trialDays > 0) {
                            const trialStart = userSnap.data().trialStart;
                            if (trialStart?.seconds) {
                                const startDate = new Date(trialStart.seconds * 1000);
                                const endDate = new Date(startDate);
                                endDate.setDate(startDate.getDate() + trialDays);
                                const hoje = new Date();
                                hoje.setHours(0, 0, 0, 0);
                                resolve(endDate >= hoje); // Resolve com true se ativo
                                return;
                            }
                        }
                        resolve(false); // Resolve com false se expirado
                    } catch (e) {
                        console.error("Erro ao verificar status:", e);
                        resolve(false); // Em caso de erro, assume que expirou
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const isAtivo = await checkStatusRapido();
            if (isAtivo) {
                window.location.href = 'index.html';
            } else {
                loader.style.display = 'none';
                container.style.display = 'block';
            }
        });

        btnLogout.addEventListener('click', async () => {
            await signOut(auth);
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>
