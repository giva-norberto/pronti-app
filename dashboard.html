<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Completo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      background: #f5f9ff;
      color: #222;
    }
    h2 {
      margin-top: 2rem;
      color: #0d6efd;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 1rem;
    }
    .resumo-card {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
      max-width: 500px;
    }
    .resumo-metricas {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .metrica {
      flex: 1;
      background: #e9f0ff;
      padding: 0.5rem;
      border-radius: 4px;
      text-align: center;
    }
    .resumo-footer {
      margin-top: 1rem;
      font-style: italic;
      color: #666;
    }
    canvas {
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
      max-width: 100%;
      height: 320px;
    }
    .filtros {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .filtros label {
      font-weight: bold;
      margin-right: 0.25rem;
    }
    select {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
    }
    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
  </style>
</head>
<body>

  <h1>Dashboard Completo</h1>

  <section id="resumo-diario-container" class="resumo-card">
    <div class="loading">ðŸ”„ Carregando dados...</div>
  </section>

  <h2>GrÃ¡fico de ServiÃ§os</h2>
  <canvas id="graficoServicos" aria-label="GrÃ¡fico de nÃºmero de agendamentos por serviÃ§o" role="img"></canvas>

  <h2>GrÃ¡fico de Faturamento</h2>
  <canvas id="graficoFaturamento" aria-label="GrÃ¡fico de faturamento por serviÃ§o" role="img"></canvas>

  <h2>GrÃ¡fico Mensal</h2>
  <div class="filtros">
    <label for="filtro-mes-inicio">MÃªs InÃ­cio:</label>
    <select id="filtro-mes-inicio" aria-label="MÃªs de inÃ­cio do filtro">
      <option value="0">Jan</option>
      <option value="1">Fev</option>
      <option value="2">Mar</option>
      <option value="3">Abr</option>
      <option value="4">Mai</option>
      <option value="5">Jun</option>
      <option value="6">Jul</option>
      <option value="7">Ago</option>
      <option value="8">Set</option>
      <option value="9">Out</option>
      <option value="10">Nov</option>
      <option value="11">Dez</option>
    </select>

    <label for="filtro-ano-inicio">Ano InÃ­cio:</label>
    <select id="filtro-ano-inicio" aria-label="Ano de inÃ­cio do filtro"></select>

    <label for="filtro-mes-fim">MÃªs Fim:</label>
    <select id="filtro-mes-fim" aria-label="MÃªs de fim do filtro">
      <option value="0">Jan</option>
      <option value="1">Fev</option>
      <option value="2">Mar</option>
      <option value="3">Abr</option>
      <option value="4">Mai</option>
      <option value="5">Jun</option>
      <option value="6">Jul</option>
      <option value="7">Ago</option>
      <option value="8">Set</option>
      <option value="9">Out</option>
      <option value="10">Nov</option>
      <option value="11">Dez</option>
    </select>

    <label for="filtro-ano-fim">Ano Fim:</label>
    <select id="filtro-ano-fim" aria-label="Ano de fim do filtro"></select>
  </div>
  <canvas id="graficoMensal" aria-label="GrÃ¡fico mensal de agendamentos" role="img"></canvas>

  <!-- Bibliotecas globais -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // ImportaÃ§Ãµes do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ConfiguraÃ§Ã£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCnGK3j90_UpBdRpu5nhSs-nY84I_e0cAk",
      authDomain: "pronti-app-37c6e.firebaseapp.com",
      projectId: "pronti-app-37c6e",
      storageBucket: "pronti-app-37c6e.firebasestorage.app",
      messagingSenderId: "736700619274",
      appId: "1:736700619274:web:557aa247905e56fa7e5df3"
    };

    // InicializaÃ§Ã£o do Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // VariÃ¡vel global para o grÃ¡fico mensal
    let graficoMensalInstance = null;

    // FunÃ§Ã£o principal de inicializaÃ§Ã£o
    document.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          carregarDashboard(user.uid);
        } else {
          // Para teste, vamos simular dados em vez de redirecionar
          console.log('UsuÃ¡rio nÃ£o autenticado, carregando dados de teste...');
          carregarDadosTeste();
        }
      });
    });

    // FunÃ§Ã£o para carregar dados reais do Firebase
    async function carregarDashboard(uid) {
      try {
        const servicosCollection = collection(db, "users", uid, "servicos");
        const agendamentosCollection = collection(db, "users", uid, "agendamentos");

        const [servicosSnapshot, agendamentosSnapshot] = await Promise.all([
          getDocs(servicosCollection),
          getDocs(agendamentosCollection)
        ]);

        const agendamentos = agendamentosSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const servicosMap = new Map();
        servicosSnapshot.forEach(doc => {
          servicosMap.set(doc.id, doc.data());
        });

        processarResumoIA(agendamentos, servicosMap);

        if(document.getElementById('graficoServicos')) gerarGraficoServicos(servicosMap, agendamentos);
        if(document.getElementById('graficoFaturamento')) gerarGraficoFaturamento(servicosMap, agendamentos);
        if(document.getElementById('graficoMensal')) gerarGraficoMensal(agendamentos);

      } catch (error) {
        console.error("Erro ao carregar dados do dashboard:", error);
        mostrarErro("NÃ£o foi possÃ­vel carregar os dados do dashboard. Verifique sua conexÃ£o com o Firebase.");
      }
    }

    // FunÃ§Ã£o para carregar dados de teste (para demonstraÃ§Ã£o)
    function carregarDadosTeste() {
      console.log('Carregando dados de teste...');
      
      // Dados de teste
      const servicosMap = new Map([
        ['1', { nome: 'Corte de Cabelo', preco: 30, duracao: 30 }],
        ['2', { nome: 'Barba', preco: 20, duracao: 20 }],
        ['3', { nome: 'Corte + Barba', preco: 45, duracao: 50 }]
      ]);

      const agendamentos = [
        { id: '1', servicoId: '1', clienteNome: 'JoÃ£o Silva', horario: { toDate: () => new Date() } },
        { id: '2', servicoId: '2', clienteNome: 'Maria Santos', horario: { toDate: () => new Date(Date.now() + 3600000) } },
        { id: '3', servicoId: '3', clienteNome: 'Pedro Costa', horario: { toDate: () => new Date(Date.now() + 7200000) } }
      ];

      processarResumoIA(agendamentos, servicosMap);
      gerarGraficoServicos(servicosMap, agendamentos);
      gerarGraficoFaturamento(servicosMap, agendamentos);
      gerarGraficoMensal(agendamentos);
    }

    // FunÃ§Ã£o para mostrar erro
    function mostrarErro(mensagem) {
      const container = document.querySelector('.dashboard-grid') || document.querySelector('.main-content') || document.body;
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `<strong>Erro:</strong> ${mensagem}`;
      container.appendChild(errorDiv);
    }

    // FunÃ§Ã£o para processar resumo IA
    function processarResumoIA(todosAgendamentos, servicosMap) {
      const container = document.getElementById('resumo-diario-container');
      if (!container) return;

      container.innerHTML = '<p>ðŸ§  Analisando seu dia...</p>';

      const hoje = new Date();
      const inicioDoDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 0, 0, 0, 0);
      const fimDoDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59, 999);

      const agendamentosDeHoje = todosAgendamentos.filter(ag => {
        if (!ag.horario || typeof ag.horario.toDate !== 'function') {
          return false;
        }
        const dataAgendamento = ag.horario.toDate();
        return dataAgendamento >= inicioDoDia && dataAgendamento <= fimDoDia;
      });

      const agendamentosEnriquecidos = agendamentosDeHoje.map(ag => {
        const servico = servicosMap.get(ag.servicoId);
        if (!servico) return null;
        const inicio = ag.horario.toDate();
        const fim = new Date(inicio.getTime() + (servico.duracao || 30) * 60000);
        return {
          id: ag.id,
          cliente: { nome: ag.clienteNome || 'Cliente' },
          servico: { nome: servico.nome || 'ServiÃ§o', preco: servico.preco || 0 },
          inicio,
          fim
        };
      }).filter(Boolean);

      const resumo = gerarResumoDiarioInteligente(agendamentosEnriquecidos);
      container.innerHTML = criarHTMLDoResumo(resumo);
    }

    // FunÃ§Ã£o IA para gerar resumo
    function gerarResumoDiarioInteligente(agendamentos) {
      if (!Array.isArray(agendamentos) || agendamentos.length === 0) {
        return { totalAtendimentos: 0, mensagem: "Nenhum agendamento para hoje." };
      }
      const ord = [...agendamentos].sort((a, b) => a.inicio - b.inicio);
      const total = ord.length;
      let faturamentoEstimado = 0;
      ord.forEach(a => faturamentoEstimado += Number(a.servico.preco) || 0);

      const primeiro = {
        horario: formatHora(ord[0].inicio),
        servico: ord[0].servico.nome,
        cliente: ord[0].cliente.nome
      };
      const ultimo = {
        horario: formatHora(ord[ord.length - 1].inicio),
        servico: ord[ord.length - 1].servico.nome,
        cliente: ord[ord.length - 1].cliente.nome
      };

      let maiorIntervalo = null;
      for (let i = 0; i < ord.length - 1; i++) {
        const fimAtual = ord[i].fim, inicioProx = ord[i + 1].inicio;
        const durMin = Math.round((inicioProx - fimAtual) / 60000);
        if (durMin > 0 && (!maiorIntervalo || durMin > maiorIntervalo.duracaoMinutos)) {
          maiorIntervalo = {
            duracaoMinutos: durMin,
            inicio: formatHora(fimAtual),
            fim: formatHora(inicioProx)
          };
        }
      }
      return {
        totalAtendimentos: total,
        mensagem: `VocÃª tem ${total} atendimentos hoje. Faturamento estimado: R$ ${faturamentoEstimado.toFixed(2).replace('.',',')}.`,
        primeiro, ultimo, faturamentoEstimado, maiorIntervalo
      };
    }

    function formatHora(date) {
      return date instanceof Date ? String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0') : '';
    }

    function criarHTMLDoResumo(resumo) {
      if (resumo.totalAtendimentos === 0) {
        return `<div class="resumo-card"><h3>Resumo do Dia</h3><p>${resumo.mensagem}</p></div>`;
      }
      let html = `
        <div class="resumo-card">
          <h3>Resumo DiÃ¡rio Inteligente</h3>
          <p>Hoje vocÃª tem <strong>${resumo.totalAtendimentos}</strong> atendimentos agendados:</p>
          <ul>
            <li><strong>Primeiro:</strong> ${resumo.primeiro.horario} â€” ${resumo.primeiro.servico} com ${resumo.primeiro.cliente}</li>
            <li><strong>Ãšltimo:</strong> ${resumo.ultimo.horario} â€” ${resumo.ultimo.servico} com ${resumo.ultimo.cliente}</li>
          </ul>
          <div class="resumo-metricas">
            <div class="metrica">
              <span>ðŸ’° Faturamento Estimado</span>
              <strong>R$ ${resumo.faturamentoEstimado.toFixed(2).replace('.', ',')}</strong>
            </div>`;
      if (resumo.maiorIntervalo) {
        html += `<div class="metrica">
          <span>ðŸ•“ Maior Intervalo</span>
          <strong>${resumo.maiorIntervalo.inicio} - ${resumo.maiorIntervalo.fim} (${resumo.maiorIntervalo.duracaoMinutos} min)</strong>
        </div>`;
      }
      html += `</div><p class="resumo-footer">Boa sorte com seu dia! ðŸ’ª</p></div>`;
      return html;
    }

    // FunÃ§Ã£o para gerar grÃ¡fico mensal
    function gerarGraficoMensal(agendamentos) {
      const filtroMesInicio = document.getElementById('filtro-mes-inicio');
      const filtroAnoInicio = document.getElementById('filtro-ano-inicio');
      const filtroMesFim = document.getElementById('filtro-mes-fim');
      const filtroAnoFim = document.getElementById('filtro-ano-fim');

      if (!filtroMesInicio || !filtroAnoInicio || !filtroMesFim || !filtroAnoFim) return;

      const anos = [...new Set(
        agendamentos
          .filter(ag => ag.horario && typeof ag.horario.toDate === 'function')
          .map(ag => ag.horario.toDate().getFullYear())
      )];
      anos.sort((a, b) => b - a);

      // Se nÃ£o hÃ¡ anos nos dados, usar o ano atual
      if (anos.length === 0) {
        anos.push(new Date().getFullYear());
      }

      filtroAnoInicio.innerHTML = '';
      filtroAnoFim.innerHTML = '';
      anos.forEach(ano => {
        const option1 = document.createElement('option');
        option1.value = ano;
        option1.textContent = ano;
        filtroAnoInicio.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = ano;
        option2.textContent = ano;
        filtroAnoFim.appendChild(option2);
      });

      filtroMesInicio.value = '0';
      filtroAnoInicio.value = anos[0] || new Date().getFullYear();
      filtroMesFim.value = '11';
      filtroAnoFim.value = anos[0] || new Date().getFullYear();

      const atualizarGrafico = () => {
        const dataInicio = new Date(filtroAnoInicio.value, filtroMesInicio.value, 1);
        const dataFim = new Date(filtroAnoFim.value, parseInt(filtroMesFim.value) + 1, 0);
        dataFim.setHours(23, 59, 59, 999);

        const agendamentosFiltrados = agendamentos.filter(ag => {
          if (!ag.horario || typeof ag.horario.toDate !== 'function') return false;
          const dataAgendamento = ag.horario.toDate();
          return dataAgendamento >= dataInicio && dataAgendamento <= dataFim;
        });

        const contagemMensal = {};
        agendamentosFiltrados.forEach(ag => {
          const data = ag.horario.toDate();
          const mesAno = data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
          contagemMensal[mesAno] = (contagemMensal[mesAno] || 0) + 1;
        });

        const labelsOrdenados = Object.keys(contagemMensal).sort((a, b) => {
          const meses = { 'jan.':0, 'fev.':1, 'mar.':2, 'abr.':3, 'mai.':4, 'jun.':5, 'jul.':6, 'ago.':7, 'set.':8, 'out.':9, 'nov.':10, 'dez.':11 };
          const [mesAStr, , anoA] = a.split(' ');
          const [mesBStr, , anoB] = b.split(' ');
          const dataA = new Date(anoA, meses[mesAStr.toLowerCase().replace('.', '')]);
          const dataB = new Date(anoB, meses[mesBStr.toLowerCase().replace('.', '')]);
          return dataA - dataB;
        });

        const dados = labelsOrdenados.map(label => contagemMensal[label]);

        if (graficoMensalInstance) graficoMensalInstance.destroy();

        const ctx = document.getElementById('graficoMensal').getContext('2d');
        graficoMensalInstance = new window.Chart(ctx, {
          type: 'bar',
          data: {
            labels: labelsOrdenados,
            datasets: [{
              label: 'Total de Agendamentos',
              data: dados,
              backgroundColor: 'rgba(75, 192, 192, 0.5)',
              borderColor: 'rgb(75, 192, 192)',
              borderWidth: 1
            }]
          },
          plugins: (typeof window.ChartDataLabels !== "undefined") ? [window.ChartDataLabels] : [],
          options: {
            scales: { 
              y: { beginAtZero: true, ticks: { stepSize: 1 } } 
            },
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'top',
                formatter: Math.round,
                font: { weight: 'bold' }
              }
            }
          }
        });
      };

      filtroMesInicio.addEventListener('change', atualizarGrafico);
      filtroAnoInicio.addEventListener('change', atualizarGrafico);
      filtroMesFim.addEventListener('change', atualizarGrafico);
      filtroAnoFim.addEventListener('change', atualizarGrafico);

      atualizarGrafico();
    }

    function gerarGraficoServicos(servicosMap, agendamentos) {
      const contagemServicos = {};
      agendamentos.forEach(ag => {
        const servicoId = ag.servicoId;
        contagemServicos[servicoId] = (contagemServicos[servicoId] || 0) + 1;
      });
      const labels = Object.keys(contagemServicos).map(id => servicosMap.get(id)?.nome || 'Desconhecido');
      const dados = Object.values(contagemServicos);
      const ctx = document.getElementById('graficoServicos').getContext('2d');
      new window.Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'NÂº de Agendamentos',
            data: dados,
            backgroundColor: 'rgba(13, 110, 253, 0.5)',
            borderColor: 'rgba(13, 110, 253, 1)',
            borderWidth: 1
          }]
        },
        options: { 
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
          responsive: true,
          plugins: { legend: { display: false } }
        }
      });
    }

    function gerarGraficoFaturamento(servicosMap, agendamentos) {
      const faturamentoServicos = {};
      agendamentos.forEach(ag => {
        const servico = servicosMap.get(ag.servicoId);
        if (servico && servico.preco !== undefined) {
          const precoNum = parseFloat(servico.preco);
          faturamentoServicos[ag.servicoId] = (faturamentoServicos[ag.servicoId] || 0) + precoNum;
        }
      });
      const labels = Object.keys(faturamentoServicos).map(id => servicosMap.get(id)?.nome || 'Desconhecido');
      const dados = Object.values(faturamentoServicos);
      const ctx = document.getElementById('graficoFaturamento').getContext('2d');
      new window.Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Faturamento (R$)',
            data: dados,
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)'
            ],
          }]
        },
        options: {
          indexAxis: 'y',
          scales: { x: { beginAtZero: true, title: { display: true, text: 'Faturamento (R$)' } } },
          responsive: true,
          plugins: { legend: { display: false } }
        }
      });
    }

    // Tornar as funÃ§Ãµes globais para debug
    window.carregarDadosTeste = carregarDadosTeste;
    window.carregarDashboard = carregarDashboard;
  </script>

</body>
</html>



