import { doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { db, auth } from "./firebase-config.js";

// Função para pegar o id do serviço da URL
function getIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
}

// Função para buscar empresa pelo dono
async function getEmpresaIdDoDono(uid) {
    if (!uid) return null;
    const q = query(collection(db, "empresarios"), where("donoId", "==", uid));
    const snapshot = await getDocs(q);
    if (snapshot.empty) return null;
    return snapshot.docs[0].id;
}

// Preencher o formulário com os dados do serviço
function preencherFormulario(servico) {
    document.getElementById('nome-servico').value = servico.nome || '';
    document.getElementById('descricao-servico').value = servico.descricao || '';
    document.getElementById('preco-servico').value = servico.preco || '';
    document.getElementById('duracao-servico').value = servico.duracao || '';
}

// Ao carregar a página, verifica se está em modo edição
document.addEventListener('DOMContentLoaded', () => {
    const idServico = getIdFromUrl();
    if (!idServico) return; // Cadastro novo

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        const empresaId = await getEmpresaIdDoDono(user.uid);
        if (!empresaId) return;

        const profissionalRef = doc(db, "empresarios", empresaId, "profissionais", user.uid);
        const docSnap = await getDoc(profissionalRef);
        if (!docSnap.exists()) return;

        const servicos = docSnap.data().servicos || [];
        // DEBUG: Veja no console os serviços, o ID e o que foi encontrado
        console.log("Servicos:", servicos);
        console.log("ID Serviço:", idServico);
        const servico = servicos.find(s => String(s.id) === idServico);
        console.log("Serviço encontrado:", servico);

        if (!servico) return;

        preencherFormulario(servico);
    });
});
