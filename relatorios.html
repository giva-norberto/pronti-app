<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatórios - Pronti</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
--cor-primaria: #4facfe;
--cor-sucesso: #34d399;
--cor-cinza: #6b7280;
--cor-texto-escuro: #22223b;
--cor-fundo-app: #f6f7fb;
--cor-azul-pronti: #4f46e5; /* azul padrão Pronti /
}
body {
margin: 0;
padding: 0;
font-family: 'Inter', Arial, sans-serif;
background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100% );
min-height: 100vh;
display: flex;
justify-content: center;
align-items: flex-start;
}
.main-relatorios {
max-width: 1100px;
width: 100%; / Garante que ocupe a largura disponível /
margin: 28px auto 0 auto;
padding: 0;
min-height: 90vh;
background: #fff;
border-radius: 18px;
box-shadow: 0 4px 28px #4f46e525;
overflow: hidden;
}
.top-actions {
display: flex;
justify-content: space-between;
align-items: center;
background: linear-gradient(90deg,#6366f1,#38bdf8 70%);
padding: 18px 18px 10px 18px;
border-radius: 18px 18px 0 0;
color: #fff;
}
.btn-voltar {
background: #fff;
color: #6366f1;
border: none;
padding: 6px 16px 6px 10px;
border-radius: 8px;
font-size: 0.96em;
font-weight: 600;
cursor: pointer;
box-shadow: 0 2px 8px #4f46e51c;
transition: background 0.17s, color 0.18s;
display: flex;
align-items: center;
gap: 7px;
min-height: 32px;
min-width: 64px;
}
.btn-voltar:hover {
background: #38bdf8;
color: #fff;
}
/ ABAS COMPACTAS /
.abas-container {
display: flex;
gap: 0;
overflow-x: auto;
border-bottom: 1.5px solid #e0e7ff;
background: transparent;
scrollbar-width: none;
align-items: flex-end;
flex: 1;
margin-left: 12px;
}
.abas-container::-webkit-scrollbar { display: none; }
.aba {
padding: 6px 14px;
font-size: 0.97em;
font-weight: 600;
border: none;
background: none;
color: #fff;
margin: 0;
border-radius: 7px 7px 0 0;
cursor: pointer;
transition: background 0.15s, color 0.15s;
min-width: 60px;
white-space: nowrap;
flex-shrink: 0;
opacity: 0.87;
outline: none;
display: flex;
align-items: center;
gap: 8px;
}
.aba:not(.active):hover {
background: #f1f4fa;
color: var(--cor-primaria);
opacity: 1;
}
.aba.active, .aba:focus {
background: #fff;
color: var(--cor-primaria);
font-weight: 800;
box-shadow: 0 -1px 9px #4f46e51a;
opacity: 1;
border-bottom: 2.5px solid var(--cor-primaria);
}
/ FILTROS COMPACTOS /
.filtros-relatorios {
display: flex;
gap: 12px;
align-items: center;
background: #f7fafd;
padding: 8px 14px;
border-radius: 0 0 13px 13px;
margin-bottom: 5px;
flex-wrap: wrap;
border-bottom: 1.3px solid #e0e7ff;
}
.filtros-relatorios label {
font-weight: 600;
color: var(--cor-primaria);
margin-right: 3px;
font-size: 0.96em;
}
.filtros-relatorios input,
.filtros-relatorios select {
padding: 5px 8px;
border-radius: 6px;
border: 1.1px solid #b3bcf7;
font-size: 0.95em;
outline: none;
min-width: 85px;
background: #fff;
color: #3730a3;
font-weight: 500;
transition: border 0.14s;
}
.filtros-relatorios input:focus,
.filtros-relatorios select:focus {
border: 1.3px solid var(--cor-primaria);
outline: none;
}
.filtros-relatorios button {
background: var(--cor-primaria);
color: #fff;
border: none;
padding: 6px 14px;
border-radius: 7px;
font-weight: bold;
cursor: pointer;
font-size: 0.95em;
display: flex;
align-items: center;
gap: 7px;
box-shadow: 0 1px 4px #38bdf812;
transition: background 0.18s;
min-height: 30px;
}
.filtros-relatorios button:hover {
background: #38bdf8;
}
.conteudo-abas {
margin-top: 0;
padding-bottom: 32px;
background: #f7f8fa;
border-radius: 0 0 18px 18px;
}
.aba-conteudo {
display: none;
animation: fadeIn .22s;
background: #fff;
border-radius: 14px;
margin: 24px 10px 0 10px;
padding: 22px 8px 18px 8px;
min-height: 240px;
box-shadow: 0 2px 10px #4f46e510;
border: 1.3px solid #e0e7ff;
}
.aba-conteudo.active {
display: block;
}
/ TABELA COMPACTA /
table {
width: 100%;
border-collapse: separate;
border-spacing: 0 5px;
background: transparent;
font-size: 0.98em;
}
th, td {
text-align: left;
padding: 7px 6px;
font-size: 0.98em;
border: none;
background: #f3f4fc;
}
th {
background: #e0e7ff;
color: var(--cor-primaria);
font-weight: 700;
font-size: 1em;
border-radius: 7px 7px 0 0;
border-bottom: 2px solid #c7d2fe;
}
tr {
border-radius: 5px;
box-shadow: 0 1.2px 4px #4f46e508;
}
tr:nth-child(even) td {
background: #f7f8fa;
}
@keyframes fadeIn {
from { opacity: 0;}
to { opacity: 1;}
}
/ ✅ INÍCIO DA ALTERAÇÃO: Estilos para o contêiner do gráfico /
.chart-container {
position: relative;
height: 350px;
width: 100%;
max-width: 95%;
margin: 30px auto 15px auto;
}
/ ✅ FIM DA ALTERAÇÃO */
@media (max-width: 900px) {
.main-relatorios {
margin: 10px 0 0 0;
padding: 0;
border-radius: 8px;
}
.top-actions, .filtros-relatorios {
padding: 7px 4px;
}
.conteudo-abas {
padding-bottom: 14px;
}
.aba-conteudo {
margin: 10px 2px 0 2px;
padding: 10px 2px;
border-radius: 8px;
}
.aba {
font-size: 0.94em;
padding: 4px 6px;
border-radius: 7px 7px 0 0;
min-width: 44px;
}
.filtros-relatorios {
gap: 5px;
font-size: 0.93em;
}
.filtros-relatorios label {
font-size: 0.93em;
}
.filtros-relatorios input,
.filtros-relatorios select {
padding: 3px 4px;
min-width: 55px;
font-size: 0.92em;
}
.filtros-relatorios button {
padding: 4px 9px;
font-size: 0.93em;
min-height: 24px;
}
}
</style>
</head>
<body>
<div id="page-content">
<main class="main-relatorios">
<div class="top-actions">
<button id="btn-voltar" class="btn-voltar"><i class="fa fa-arrow-left"></i> Voltar</button>
<nav class="abas-container">
<button class="aba active" data-aba="servicos"><i class="fa-solid fa-gears"></i> Serviços</button>
<button class="aba" data-aba="profissionais"><i class="fa-solid fa-user-tie"></i> Profissionais</button>
<button class="aba" data-aba="faturamento"><i class="fa-solid fa-coins"></i> Faturamento</button>
<button class="aba" data-aba="clientes"><i class="fa-solid fa-user-group"></i> Clientes</button>
<button class="aba" data-aba="agenda"><i class="fa-solid fa-calendar-days"></i> Agenda</button>
</nav>
</div>
<header class="filtros-relatorios">
<label for="filtro-data-inicio">Data Início:</label>
<input type="date" id="filtro-data-inicio">

    <label for="filtro-data-fim">Data Fim:</label>
    <input type="date" id="filtro-data-fim">

    <label for="filtro-profissional">Profissional:</label>
    <select id="filtro-profissional">
      <option value="todos">Todos</option>
    </select>

    <button id="btn-aplicar-filtro"><i class="fa-solid fa-filter"></i> Aplicar</button>
  </header>
  <section class="conteudo-abas">
    <div class="aba-conteudo active" id="servicos">
      <div class="chart-container">
        <canvas id="grafico-servicos"></canvas>
      </div>
    </div>
    <div class="aba-conteudo" id="profissionais">
      <div class="chart-container">
        <canvas id="grafico-profissionais"></canvas>
      </div>
    </div>
    <div class="aba-conteudo" id="faturamento">
      <div class="chart-container">
        <canvas id="grafico-faturamento"></canvas>
      </div>
    </div>
    <div class="aba-conteudo" id="clientes">
      <div class="chart-container">
        <canvas id="grafico-clientes"></canvas>
      </div>
    </div>
    <div class="aba-conteudo" id="agenda">
      <div class="chart-container">
        <canvas id="grafico-agenda"></canvas>
      </div>
    </div>
  </section>
   </main>
</div>

<script type="module">
import { verificarAcesso } from './userService.js';
import { db } from './firebase-config.js';
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

async function inicializarPagina( ) {
  try {
    const sessao = await verificarAcesso();
    if (!sessao || !sessao.user) {
      return; 
    }

    let papelUsuario = sessao.papeis || [];
    if (papelUsuario.length === 0) { 
      if(sessao.isAdmin) papelUsuario.push(&#39;admin&#39;);
      if(sessao.isOwner) papelUsuario.push(&#39;dono&#39;);
      if(papelUsuario.length === 0) papelUsuario.push(&#39;funcionario&#39;);
    }

    const permissoesRef = doc(db, &quot;configuracoesGlobais&quot;, &quot;permissoes&quot;);
    const permissoesSnap = await getDoc(permissoesRef);
    const regras = permissoesSnap.exists() ? permissoesSnap.data() : {};

    const podeVer = papelUsuario.some(function(papel) {
      return regras.relatorios &amp;&amp; regras.relatorios[papel] === true;
    });

    if (!podeVer) {
      document.getElementById(&#39;page-content&#39;).innerHTML = `
        &lt;div style=&quot;background: #fff; padding: 40px; border-radius: 12px; text-align: center; margin-top: 50px;&quot;&gt;
          &lt;h1&gt;Acesso Negado&lt;/h1&gt;
          &lt;p&gt;Você não tem permissão para acessar esta página.&lt;/p&gt;
          &lt;button onclick=&quot;window.history.back()&quot; style=&quot;margin-top: 20px; padding: 10px 20px; cursor: pointer;&quot;&gt;Voltar&lt;/button&gt;
        &lt;/div&gt;
      `;
      return;
    }

  } catch (error) {
    console.error(&quot;Erro crítico ao inicializar a página de relatórios:&quot;, error);
    document.getElementById(&#39;page-content&#39;).innerHTML = &#39;&lt;h1&gt;Ocorreu um erro&lt;/h1&gt;&lt;p&gt;Não foi possível carregar a página. Tente novamente.&lt;/p&gt;&#39;;
  }
}

inicializarPagina();
</script>

<script src="relatorios.js" type="module"></script>

<script>
const btnVoltar = document.getElementById("btn-voltar");
if (btnVoltar) {
btnVoltar.addEventListener("click", () => {
window.history.back();
});
}

if (window.history.state === null || window.history.state.page !== &quot;relatorios&quot;) {
    window.history.pushState({ &quot;page&quot;: &quot;relatorios&quot; }, &quot;&quot;);
}
window.addEventListener(&#39;popstate&#39;, function() {
  window.location.replace(&#39;index.html&#39;);
});
</script>

<script>
(function() {
// O código completo do gráfico é colocado dentro de uma string
const chartScriptCode = `
var activeCharts = {};

    function renderizarGrafico(canvasId, tipo, labels, data, label, titulo) {
      var canvasEl = document.getElementById(canvasId);
      if (!canvasEl) {
        console.error(&quot;Elemento canvas com id &#39;&quot; + canvasId + &quot;&#39; não foi encontrado.&quot;);
        return;
      }
      var ctx = canvasEl.getContext(&#39;2d&#39;);
      if (activeCharts[canvasId]) {
        activeCharts[canvasId].destroy();
      }
      activeCharts[canvasId] = new Chart(ctx, {
        type: tipo,
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: [&#39;rgba(79, 70, 229, 0.7)&#39;, &#39;rgba(99, 102, 241, 0.7)&#39;, &#39;rgba(56, 189, 248, 0.7)&#39;, &#39;rgba(34, 211, 238, 0.7)&#39;, &#39;rgba(165, 180, 252, 0.7)&#39;, &#39;rgba(191, 219, 254, 0.7)&#39;],
            borderColor: [&#39;#4F46E5&#39;, &#39;#6366F1&#39;, &#39;#38BDF8&#39;, &#39;#22D3EE&#39;, &#39;#A5B4FC&#39;, &#39;#BFDBFE&#39;],
            borderWidth: 1.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: &#39;top&#39; },
            title: { display: true, text: titulo, font: { size: 16 }, color: &#39;#3730a3&#39; }
          },
          scales: {
              y: { beginAtZero: true }
          }
        }
      });
    }

    function demonstrarGrafico() {
      var abaAtiva = document.querySelector(&#39;.aba-conteudo.active&#39;);
      if (!abaAtiva) return;
      var idAba = abaAtiva.id;
      var R = function() { return Math.random(); };
      switch (idAba) {
        case &#39;servicos&#39;:
          renderizarGrafico(&#39;grafico-servicos&#39;, &#39;bar&#39;, [&#39;Corte&#39;, &#39;Escova&#39;, &#39;Manicure&#39;, &#39;Pedicure&#39;, &#39;Hidratação&#39;], [Math.floor(R()*50), Math.floor(R()*40), Math.floor(R()*80), Math.floor(R()*70), Math.floor(R()*30)], &#39;Quantidade&#39;, &#39;Serviços Mais Realizados&#39;);
          break;
        case &#39;profissionais&#39;:
          renderizarGrafico(&#39;grafico-profissionais&#39;, &#39;pie&#39;, [&#39;Ana&#39;, &#39;Beatriz&#39;, &#39;Carla&#39;, &#39;Daniela&#39;], [Math.floor(R()*10), Math.floor(R()*15), Math.floor(R()*12), Math.floor(R()*20)], &#39;Nº de Atendimentos&#39;, &#39;Atendimentos por Profissional&#39;);
          break;
        case &#39;faturamento&#39;:
          renderizarGrafico(&#39;grafico-faturamento&#39;, &#39;line&#39;, [&#39;Seg&#39;, &#39;Ter&#39;, &#39;Qua&#39;, &#39;Qui&#39;, &#39;Sex&#39;, &#39;Sáb&#39;], [Math.floor(R()*500), Math.floor(R()*700), Math.floor(R()*600), Math.floor(R()*900), Math.floor(R()*1200), Math.floor(R()*1500)], &#39;Valor (R$)&#39;, &#39;Faturamento Diário&#39;);
          break;
        case &#39;clientes&#39;:
          renderizarGrafico(&#39;grafico-clientes&#39;, &#39;bar&#39;, [&#39;Novos Clientes&#39;, &#39;Clientes Recorrentes&#39;], [Math.floor(R()*30), Math.floor(R()*150)], &#39;Quantidade&#39;, &#39;Perfil de Clientes&#39;);
          break;
        case &#39;agenda&#39;:
          renderizarGrafico(&#39;grafico-agenda&#39;, &#39;doughnut&#39;, [&#39;Confirmados&#39;, &#39;Cancelados&#39;, &#39;Não Compareceu&#39;, &#39;Aguardando&#39;], [Math.floor(R()*100), Math.floor(R()*20), Math.floor(R()*10), Math.floor(R()*30)], &#39;Status&#39;, &#39;Status dos Agendamentos&#39;);
          break;
      }
    }

    document.getElementById(&#39;btn-aplicar-filtro&#39;).addEventListener(&#39;click&#39;, demonstrarGrafico);

    document.querySelectorAll(&#39;.aba&#39;).forEach(function(aba) {
      aba.addEventListener(&#39;click&#39;, function() {
        document.querySelector(&#39;.aba.active&#39;).classList.remove(&#39;active&#39;);
        this.classList.add(&#39;active&#39;);
        document.querySelector(&#39;.aba-conteudo.active&#39;).classList.remove(&#39;active&#39;);
        document.getElementById(this.dataset.aba).classList.add(&#39;active&#39;);
        demonstrarGrafico();
      });
    });

    window.addEventListener(&#39;load&#39;, function() {
      setTimeout(demonstrarGrafico, 500);
    });
  `;

  // Um novo elemento &lt;script&gt; é criado dinamicamente
  var scriptElement = document.createElement(&#39;script&#39;);
  // O conteúdo da string é inserido nele
  scriptElement.textContent = chartScriptCode;
  // O script é adicionado ao corpo do documento e executado com segurança
  document.body.appendChild(scriptElement);
})();
