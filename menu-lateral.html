<aside class="sidebar" id="sidebar">
  <a href="index.html" class="sidebar-brand">Pronti</a>
  <hr />
  <nav class="sidebar-links" id="sidebar-links">
    <!-- Funcionário -->
    <a href="index.html" class="menu-func"><span>🏠</span> Início</a>
    <a href="agenda.html" class="menu-func"><span>📅</span> Agenda</a>
    <a href="equipe.html" class="menu-func"><span>👥</span> Equipe</a>

    <!-- Dono -->
    <a href="dashboard.html" class="menu-dono" style="display:none;"><span>📊</span> Dashboard</a>
    <a href="servicos.html" class="menu-dono" style="display:none;"><span>🛠️</span> Serviços</a>
    <a href="clientes.html" class="menu-dono" style="display:none;"><span>👤</span> Clientes</a>
    <a href="perfil.html" class="menu-dono" style="display:none;"><span>🙍‍♂️</span> Meu Perfil</a>
    <a href="relatorios.html" class="menu-dono" style="display:none;"><span>📈</span> Relatórios</a>

    <!-- Admin -->
    <a href="admin-clientes.html" class="menu-admin" style="display:none;"><span>🔒</span> Administração</a>

    <!-- Novo Menu Permissões (apenas Admin) -->
    <a href="permissoes.html" class="menu-permissoes" style="display:none;"><span>⚙️</span> Permissões</a>
  </nav>

  <div class="sidebar-footer">
    <button id="btn-logout" class="btn-logout">Sair</button>
  </div>
</aside>

<style>
.sidebar { width: 240px; background: linear-gradient(180deg, #4f46e5 0%, #6366f1 100%); min-height: 100vh; color: #fff; position: fixed; top:0; left:0; bottom:0; display:flex; flex-direction:column; padding-top:20px; }
.sidebar-brand { font-size:1.8rem; font-weight:900; color:#fff; text-decoration:none; padding:0 24px 12px; display:block; }
.sidebar-links { display:flex; flex-direction:column; gap:8px; padding:0 16px; flex-grow:1; }
.sidebar-links a { display:flex; align-items:center; gap:10px; background:#fff; color:#4f46e5; font-weight:600; padding:12px 14px; border-radius:8px; text-decoration:none; transition:all 0.2s ease; }
.sidebar-links a.active { background:#4f46e5; color:#fff; }
.sidebar-links a:hover { background:#eef; }
.sidebar-footer { padding:16px; }
.btn-logout { width:100%; background:#fff; color:#4f46e5; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
.btn-logout:hover { background:#4f46e5; color:#fff; }
</style>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { verificarAcesso } from "./userService.js";

const ADMIN_UID = "BX6Q7HrVMrcCBqe72r7K76EBPkX2";

// --- Atualiza visibilidade do menu com permissões do Firestore ---
async function updateMenuComPermissoes(userSession) {
  let papel = "funcionario";
  if (userSession?.perfil && userSession?.user) {
    const { perfil, user } = userSession;
    if (user.uid === ADMIN_UID) papel = "admin";
    else if (perfil.ehDono === true) papel = "dono";
  }

  // Esconde todos
  document.querySelectorAll(".menu-func, .menu-dono, .menu-admin, .menu-permissoes").forEach(el => el.style.display="none");

  // Mostra menus básicos por papel
  if (papel === "funcionario") {
    document.querySelectorAll(".menu-func").forEach(el => el.style.display="flex");
  } else if (papel === "dono") {
    document.querySelectorAll(".menu-func, .menu-dono").forEach(el => el.style.display="flex");
  } else if (papel === "admin") {
    document.querySelectorAll(".menu-func, .menu-dono, .menu-admin, .menu-permissoes").forEach(el => el.style.display="flex");
  }

  // Busca permissões globais opcionais
  try {
    const cfgRef = doc(db, "configuracoesGlobais", "permissoes");
    const snap = await getDoc(cfgRef);
    if (snap.exists()) {
      const permissoesGlobais = snap.data();
      Object.entries(permissoesGlobais).forEach(([menu, roles]) => {
        if (roles[papel] === true) {
          const el = document.querySelector(`[data-menu="${menu}"]`);
          if (el) el.style.display = "flex";
        }
      });
    }
  } catch(e) {
    console.error("Erro ao buscar permissões globais:", e);
  }

  // Destaca link ativo
  const currentPage = window.location.pathname;
  document.querySelectorAll("#sidebar-links a").forEach(link => {
    const linkPage = new URL(link.href, window.location.origin).pathname;
    link.classList.toggle("active", linkPage === currentPage);
  });
}

// --- Configura botão logout ---
function setupLogout() {
  const btn = document.getElementById("btn-logout");
  if (!btn) return;
  if (!btn.dataset.listenerAttached) {
    btn.dataset.listenerAttached = "true";
    btn.addEventListener("click", () => {
      signOut(auth).then(() => {
        localStorage.clear();
        window.location.href = "login.html";
      }).catch(err => console.error("Erro ao deslogar:", err));
    });
  }
}

// --- Inicialização ---
(async function inicializarMenu() {
  setupLogout();
  try {
    const userSession = await verificarAcesso();
    const event = new CustomEvent("pronti:session-loaded", { detail:{ userSession } });
    document.dispatchEvent(event);
    await updateMenuComPermissoes(userSession);
  } catch(err) {
    console.error("Erro inicializando menu:", err);
  }
})();
</script>
