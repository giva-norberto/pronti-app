<aside class="sidebar sidebar-loading" id="sidebar">
    <a href="index.html" class="sidebar-brand">Pronti</a>
    <hr />
    <nav class="sidebar-links" id="sidebar-links">
        <!-- Funcionário / Geral -->
        <a href="index.html" data-menu-id="inicio">
            <span><i class="fa-solid fa-house"></i></span> Início
        </a>
        <a href="agenda.html" data-menu-id="agenda">
            <span><i class="fa-solid fa-calendar-days"></i></span> Agenda
        </a>
        <a href="equipe.html" data-menu-id="equipe">
            <span><i class="fa-solid fa-users"></i></span> Equipe
        </a>

        <!-- Dono -->
        <a href="servicos.html" data-menu-id="servicos">
            <span><i class="fa-solid fa-scissors"></i></span> Serviços
        </a>
        <a href="clientes.html" data-menu-id="clientes">
            <span><i class="fa-solid fa-user"></i></span> Clientes
        </a>
        <a href="perfil.html" data-menu-id="perfil">
            <span><i class="fa-solid fa-id-card"></i></span> Empresa
        </a>

        <!-- Relatórios (dono + admin) -->
        <a href="relatorios.html" data-menu-id="relatorios">
            <span><i class="fa-solid fa-chart-line"></i></span> Relatórios
        </a>

        <!-- Admin -->
        <a href="admin.html" data-menu-id="administracao">
            <span><i class="fa-solid fa-shield"></i></span> Administração
        </a>
        <a href="permissoes.html" data-menu-id="permissoes">
            <span><i class="fa-solid fa-sliders"></i></span> Permissões
        </a>
    </nav>
    <div class="sidebar-footer">
        <button id="btn-logout" class="btn-logout">Sair</button>
    </div>
</aside>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* Manter todo CSS do menu anterior (sidebar, links, hover, responsivo) */
.hidden { display: none !important; }
</style>

<script type="module">
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { db } from "./firebase-config.js";

const perfil = localStorage.getItem('perfil'); // "funcionario", "dono", "admin"

// Aplica permissões
async function aplicarPermissoesGlobaisMenu() {
  try {
    const docSnap = await db.collection("configuracoesGlobais").doc("permissoes").get();
    if (!docSnap.exists) return;
    const permissoes = docSnap.data();

    document.querySelectorAll('.sidebar-links a').forEach(a => {
      const menuId = a.dataset.menuId;
      const podeVer = permissoes[menuId]?.[perfil] ?? true;
      if (!podeVer) a.classList.add('hidden');
    });

    // Administração e Permissões só admin
    if (perfil !== 'admin') {
      ['administracao','permissoes'].forEach(id => {
        document.querySelector(`[data-menu-id="${id}"]`)?.classList.add('hidden');
      });
    }

    // Funcionário só vê itens básicos
    if (perfil === 'funcionario') {
      ['servicos','clientes','perfil','relatorios'].forEach(id => {
        document.querySelector(`[data-menu-id="${id}"]`)?.classList.add('hidden');
      });
    }

  } catch(e) {
    console.error("Erro ao aplicar permissões do menu:", e);
  }
}

// Marca link ativo
function marcarAtivo() {
  const urlAtual = window.location.pathname.split('/').pop();
  document.querySelectorAll('.sidebar-links a').forEach(link => {
    if (link.getAttribute('href') === urlAtual) link.classList.add('active');
  });
}

// Logout funcional
function configurarLogout() {
  const btn = document.getElementById("btn-logout");
  if (!btn) return;

  btn.addEventListener("click", async () => {
    try {
      await signOut(getAuth()); // Primeiro desloga do Firebase
      localStorage.clear();     // Depois limpa localStorage
      window.location.href = "login.html";
    } catch(e) {
      console.error("Erro ao sair:", e);
      alert("Erro ao sair: " + e.message);
    }
  });
}

// Inicializa menu
document.addEventListener("DOMContentLoaded", async () => {
  await aplicarPermissoesGlobaisMenu();
  marcarAtivo();
  configurarLogout();
});
</script>
