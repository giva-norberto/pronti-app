<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronti - Relatório de Horários Livres</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="style.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            background: #f5f7fb;
            font-family: 'Inter',sans-serif;
        }
        .main-content {
            margin-left: 270px;
            padding: 20px 8vw;
            max-width: 1080px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
            background: var(--card-bg,#fff);
            padding: 16px 20px;
            border-radius: 14px;
            box-shadow: var(--shadow,0 4px 20px rgba(0,0,0,0.06));
            margin-bottom: 30px;
        }
        .func-filtro-topo {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .func-filtro-topo label { font-weight: 600; }
        .func-filtro-select {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1.5px solid var(--border-color,#e2e8f0);
            background: #fff;
            font-weight: 600;
        }
        .card {
            background: var(--card-bg,#fff);
            border-radius: 12px;
            box-shadow: var(--shadow,0 4px 20px rgba(0,0,0,0.06));
            padding: 20px;
            margin-bottom: 24px;
        }
        .funcionario-card {
            background: var(--card-bg,#fff);
            border-radius: 12px;
            box-shadow: var(--shadow,0 2px 8px rgba(0,0,0,0.09));
            padding: 18px;
            margin-bottom: 18px;
        }
        .funcionario-nome {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color,#4f46e5);
            margin: 0 0 10px 0;
            border-bottom: 1px solid var(--border-color,#e2e8f0);
            padding-bottom: 8px;
        }
        .grade-horarios-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .slot-horario {
            padding: 10px 12px;
            border: 1.5px solid var(--border-color,#e2e8f0);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            cursor: not-allowed;
            background: #f8fafc;
            color: var(--text-main,#1e293b);
        }
        .slot-horario.livre {
             background: #dcfce7;
             color: #166534;
             border-color: #a7f3d0;
        }
        .aviso-horarios {
            grid-column: 1 / -1;
            color: var(--text-secondary,#64748b);
            text-align: center;
        }
        #relatorio-placeholder {
            color: #64748b;
            font-weight: 500;
            text-align: center;
            padding: 40px;
        }
        @media(max-width:900px) {
            .main-content { margin-left: 0; padding: 10px 2vw; }
            .page-header { flex-direction: column; gap: 10px; padding: 10px; }
            .card, .funcionario-card { padding: 12px; }
            .funcionario-nome { font-size:1rem; padding-bottom:5px;}
            .grade-horarios-container { grid-template-columns: repeat(auto-fill, minmax(70px,1fr)); gap:7px;}
        }
    </style>
</head>
<body>
    <div id="menu-container"></div>

    <main class="main-content">
        <div class="page-header">
            <h1>Relatório de Horários Livres</h1>
            <a href="agenda.html" class="btn">
                <i class="fa-solid fa-arrow-left"></i>
                Voltar para Agenda
            </a>
        </div>

        <!-- Filtro de profissionais -->
        <div class="func-filtro-topo">
            <label for="select-profissional"><i class="fa-solid fa-user"></i> Profissional:</label>
            <select id="select-profissional" class="func-filtro-select">
                <option value="todos">Todos os profissionais</option>
            </select>
        </div>
        <div class="card" style="margin-bottom: 24px;">
            <h3 style="margin: 0;">
                Exibindo horários disponíveis para: 
                <strong id="data-alvo-display" style="color: var(--primary-color);">--/--/----</strong>
            </h3>
        </div>

        <div id="relatorio-container">
            <p id="relatorio-placeholder">A carregar relatório...</p>
        </div>
    </main>
    
    <script type="module">
        import { verificarAcesso } from './userService.js';

        async function carregarMenu(papelUsuario) {
            try {
                const response = await fetch('menu-lateral.html');
                document.getElementById('menu-container').innerHTML = await response.text();
                const menuModule = await import('./menu-lateral.js');
                if (menuModule.ativarMenuLateral) {
                    await menuModule.ativarMenuLateral(papelUsuario);
                }
            } catch (error) {
                console.error("Falha ao carregar o menu lateral:", error);
            }
        }

        // --- RELATÓRIO REFINADO ---
        let dataAlvoEl = null;
        let relatorioContainerEl = null;
        let selectProfissionalEl = null;
        let clinicaIdGlobal = null;
        let profissionaisGlobal = [];
        let horariosPorProfGlobal = {};

        export async function iniciar(clinicaId) {
            clinicaIdGlobal = clinicaId;
            dataAlvoEl = document.getElementById('data-alvo-display');
            relatorioContainerEl = document.getElementById('relatorio-container');
            selectProfissionalEl = document.getElementById('select-profissional');
            selectProfissionalEl.addEventListener('change', renderizarRelatorioFiltrado);
            await carregarRelatorio();
        }

        function definirDataAlvo() {
            const agora = new Date();
            const HORA_CORTE = 17;
            if (agora.getHours() >= HORA_CORTE) agora.setDate(agora.getDate() + 1);
            const offset = agora.getTimezoneOffset();
            const dataFormatada = new Date(agora.getTime() - (offset * 60 * 1000));
            return dataFormatada.toISOString().split('T')[0];
        }

        async function carregarRelatorio() {
            const dataAlvo = definirDataAlvo();
            const [ano, mes, dia] = dataAlvo.split('-');
            dataAlvoEl.textContent = `${dia}/${mes}/${ano}`;

            try {
                const { getProfissionaisDaClinica } = await import('./firebaseService.js');
                const { getHorariosLivres } = await import('./horarioService.js');
                // 1. Buscar profissionais
                profissionaisGlobal = await getProfissionaisDaClinica(clinicaIdGlobal);

                if (!profissionaisGlobal || profissionaisGlobal.length === 0) {
                    relatorioContainerEl.innerHTML = '<p id="relatorio-placeholder">Nenhum profissional encontrado.</p>';
                    return;
                }

                // Preencher filtro
                selectProfissionalEl.innerHTML = '<option value="todos">Todos os profissionais</option>' +
                    profissionaisGlobal.map(prof => `<option value="${prof.id}">${prof.nome}</option>`).join('');

                // Buscar horários livres de TODOS em paralelo
                const promises = profissionaisGlobal.map(prof =>
                    getHorariosLivres(dataAlvo, prof.id, 30, clinicaIdGlobal)
                        .then(horarios => horariosPorProfGlobal[prof.id] = horarios)
                        .catch(() => horariosPorProfGlobal[prof.id] = null)
                );
                await Promise.all(promises);

                renderizarRelatorioFiltrado();
            } catch (error) {
                console.error("Erro ao gerar relatório:", error);
                relatorioContainerEl.innerHTML = '<p id="relatorio-placeholder" style="color: red;">Erro ao carregar dados.</p>';
            }
        }

        function renderizarRelatorioFiltrado() {
            const filtro = selectProfissionalEl.value;
            let profsMostrar = filtro === "todos" ? profissionaisGlobal : profissionaisGlobal.filter(p => p.id === filtro);

            if (!profsMostrar || profsMostrar.length === 0) {
                relatorioContainerEl.innerHTML = '<p id="relatorio-placeholder">Nenhum profissional encontrado.</p>';
                return;
            }

            relatorioContainerEl.innerHTML = '';
            profsMostrar.forEach(prof => {
                const card = document.createElement('div');
                card.className = 'funcionario-card';

                // nome
                const nomeEl = document.createElement('h3');
                nomeEl.className = 'funcionario-nome';
                nomeEl.textContent = prof.nome;
                card.appendChild(nomeEl);

                // horários
                const gradeEl = document.createElement('div');
                gradeEl.className = 'grade-horarios-container';
                card.appendChild(gradeEl);

                const horarios = horariosPorProfGlobal[prof.id];
                renderizarGradeInterna(gradeEl, horarios);

                relatorioContainerEl.appendChild(card);
            });
        }

        function renderizarGradeInterna(containerGrade, horarios) {
            if (!horarios || !horarios.length) {
                containerGrade.innerHTML = '<p class="aviso-horarios">Nenhum horário livre encontrado.</p>';
                return;
            }
            containerGrade.innerHTML = '';
            horarios.forEach(slot => {
                const div = document.createElement('div');
                div.className = 'slot-horario livre';
                div.textContent = slot.inicio;
                containerGrade.appendChild(div);
            });
        }

        async function inicializarPagina() {
            const sessao = await verificarAcesso();
            if (!sessao) return;

            let papelUsuario = sessao.papeis || [];
            if (papelUsuario.length === 0) papelUsuario.push('funcionario');

            await carregarMenu(papelUsuario);

            // Chama a lógica refinada do relatório
            iniciar(sessao.clinicaId); 
        }
        inicializarPagina();
    </script>
</body>
</html>
