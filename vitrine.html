<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minha Vitrine - Pronti IA</title>
  <link href="style.css" rel="stylesheet" />
</head>
<body>

  <main class="main-content">
    <h1>Minha Vitrine</h1>
    <div id="lista-servicos-vitrine">
      <p>Carregando serviços...</p>
    </div>
  </main>

  <script type="module">
    import { firestore } from './firebase-config.js';
    import { doc, collection, getDoc, getDocs } from 'firebase/firestore';

    // Função para pegar parâmetro da URL
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const listaServicosContainer = document.getElementById('lista-servicos-vitrine');

    async function carregarVitrine(userUid) {
      try {
        // 1. Pegar config da vitrine
        const configRef = doc(firestore, 'users', userUid, 'publicProfile', 'vitrineConfig');
        const configSnap = await getDoc(configRef);
        if (!configSnap.exists()) {
          listaServicosContainer.innerHTML = '<p>Usuário não configurou a vitrine ainda.</p>';
          return;
        }
        const { servicosVisiveis } = configSnap.data();

        if (!servicosVisiveis || servicosVisiveis.length === 0) {
          listaServicosContainer.innerHTML = '<p>Não há serviços visíveis na vitrine.</p>';
          return;
        }

        // 2. Buscar dados dos serviços selecionados
        const servicesRef = collection(firestore, 'users', userUid, 'services');
        const querySnapshot = await getDocs(servicesRef);

        // Filtrar só os serviços que estão na lista servicosVisiveis
        const servicos = [];
        querySnapshot.forEach(docSnap => {
          if (servicosVisiveis.includes(docSnap.id)) {
            servicos.push({ id: docSnap.id, ...docSnap.data() });
          }
        });

        if (servicos.length === 0) {
          listaServicosContainer.innerHTML = '<p>Nenhum serviço encontrado para exibir.</p>';
          return;
        }

        // 3. Renderizar os serviços na página
        const html = servicos.map(s => `
          <div class="info-card" style="margin-bottom: 16px;">
            <h3>${s.nome}</h3>
            <p>${s.descricao || ''}</p>
          </div>
        `).join('');
        listaServicosContainer.innerHTML = html;

      } catch (error) {
        console.error('Erro ao carregar vitrine:', error);
        listaServicosContainer.innerHTML = '<p>Erro ao carregar a vitrine.</p>';
      }
    }

    const userUid = getQueryParam('user');
    if (!userUid) {
      listaServicosContainer.innerHTML = '<p>Usuário não especificado na URL.</p>';
    } else {
      carregarVitrine(userUid);
    }
  </script>

</body>
</html>
