<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Agendamento Online</title>
    
    <link rel="stylesheet" href="vitrine.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      /* Pequenos estilos locais para bot√µes de hor√°rio (n√£o altera l√≥gica) */
      .horario-btn {
        display: inline-block;
        margin: 6px;
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid rgba(0,0,0,0.08);
        background: #fff;
        color: #374151;
        cursor: pointer;
      }
      .horario-btn.selected {
        background: linear-gradient(90deg,#6366f1,#4f46e5);
        color: #fff;
        border-color: rgba(0,0,0,0.12);
      }
    </style>
</head>
<body>
    <div id="vitrine-loader">
        <p style="text-align: center; width: 100%; margin-top: 50px;">A carregar informa√ß√µes do neg√≥cio...</p>
    </div>

    <div id="vitrine-content" class="vitrine-container" style="display: none;">
        <!-- Sidebar para desktop (desaparece no mobile) -->
        <aside class="sidebar-vitrine">
            <div class="header-vitrine">
                <img id="logo-publico" src="https://placehold.co/100x100/e0e7ff/6366f1?text=Logo" alt="Log√≥tipo do Neg√≥cio">
                <h1 id="nome-negocio-publico">Nome do Neg√≥cio</h1>
            </div>
            <nav class="sidebar-menu">
                <button class="menu-btn ativo" data-menu="agendamento">Agendar</button>
                <button class="menu-btn" data-menu="informacoes">Informa√ß√µes</button>
                <button class="menu-btn" data-menu="visualizacao">Reservas</button>
                <button class="menu-btn" data-menu="perfil">üë§ Perfil</button>
            </nav>
        </aside>

        <main class="main-content-vitrine">
            <!-- HEADER MOBILE: Logo + Nome aparecem no topo s√≥ no mobile -->
            <div class="header-vitrine-mobile" style="display: none;">
                <img id="logo-publico-mobile" src="https://placehold.co/100x100/e0e7ff/6366f1?text=Logo" alt="Log√≥tipo do Neg√≥cio" style="width:70px;height:70px;border-radius:50%;margin-bottom:10px;">
                <h1 id="nome-negocio-publico-mobile" style="font-size:1.1rem;font-weight:700;margin:0 0 12px 0;background:linear-gradient(135deg, #4F46E5, #7C3AED);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Nome do Neg√≥cio</h1>
            </div>
            <!-- TELA: Agendamento -->
            <div id="menu-agendamento" class="menu-content ativo">
                <div class="card">
                    <h2>Fa√ßa o seu Agendamento</h2>
                    <div id="agendamento-login-prompt" style="display: none;">
                        <p>Voc√™ precisa <a href="#" id="login-link-agendamento">fazer login</a> para agendar um hor√°rio.</p>
                    </div>
                    <div class="form-group">
                        <label>1. Escolha um profissional</label>
                        <div id="lista-profissionais" class="profissionais-container"></div>
                    </div>
                    
                    <div id="agendamento-form-container" style="display: none;">
                        <div class="form-group">
                            <label id="label-servicos">2. Escolha o(s) servi√ßo(s)</label>
                            <div id="lista-servicos" class="servicos-container-cards"></div>
                            
                            <!-- Container para o resumo e bot√£o de prosseguir (para m√∫ltiplos servi√ßos) -->
                            <div id="servicos-resumo-container" style="display: none; margin-top: 20px;">
                                <div class="servicos-resumo">
                                    <p id="resumo-texto"></p>
                                </div>
                                <button id="btn-prosseguir-data" class="btn-prosseguir">Escolher Data e Hor√°rio</button>
                            </div>
                        </div>
                        
                        <!-- Data, hor√°rio, resumo final e bot√£o confirmar -->
                        <div id="data-e-horario-container" style="display:none;">
                            <div class="form-group">
                                <label for="data-agendamento">3. Escolha uma data</label>
                                <input type="date" id="data-agendamento" required disabled>
                            </div>
                            <div class="form-group">
                                <label>4. Escolha um hor√°rio</label>
                                <div id="grade-horarios" class="horarios-container-grid">
                                    <p class="aviso-horarios">Selecione um profissional e um servi√ßo.</p>
                                </div>
                            </div>
                            <!-- RESUMO FINAL DO AGENDAMENTO -->
                            <div id="resumo-agendamento-final" style="margin: 24px 0 8px 0;"></div>
                            <button id="btn-confirmar-agendamento" disabled>Confirmar Agendamento</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TELA: Informa√ß√µes -->
            <div id="menu-informacoes" class="menu-content">
                <div class="card">
                    <h2>Sobre o Neg√≥cio</h2>
                    <div id="info-negocio"></div>
                </div>
                <div class="card">
                    <h2>Servi√ßos Oferecidos</h2>
                    <div id="info-servicos"></div>
                </div>
                <div class="card">
                    <h2>Contato e Localiza√ß√£o</h2>
                    <div id="info-contato"></div>
                </div>
            </div>
            
            <!-- TELA: Visualiza√ß√£o de Agendamentos -->
            <div id="menu-visualizacao" class="menu-content">
                <div class="card">
                    <h2>Reservas</h2>
                    <div id="agendamentos-login-prompt" style="display: none;">
                        <p>Voc√™ precisa <a href="#" id="login-link-visualizacao">fazer login</a> para ver seus agendamentos.</p>
                    </div>
                    <div id="botoes-agendamento" class="botoes-agendamento" style="display: none;">
                        <button id="btn-ver-ativos" class="btn-toggle ativo">Ver Ativos</button>
                        <button id="btn-ver-historico" class="btn-toggle">Ver Hist√≥rico</button>
                    </div>
                </div>
                <div id="lista-agendamentos-visualizacao" class="lista-agendamentos-resultado"></div>
            </div>
            
            <!-- TELA: Perfil -->
            <div id="menu-perfil" class="menu-content">
                <div class="card">
                    <h2>Meu Perfil</h2>
                    <div id="user-info" style="display: none;">
                        <img id="user-photo" src="" alt="Foto do Utilizador" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px;">
                        <p id="user-name" style="font-weight: 600; font-size: 1.2rem;"></p>
                        <button id="btn-logout" class="btn-secondary">Sair</button>
                    </div>
                    <div id="btn-login-container">
                        <button id="btn-login" class="btn-submit">Fazer Login com Google</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation para Mobile -->
    <nav class="bottom-nav-vitrine">
        <button class="ativo" data-menu="agendamento">üìÖ<span>Agendar</span></button>
        <button data-menu="informacoes">üìã<span>Info</span></button>
        <button data-menu="visualizacao">üìã<span>Meus</span></button>
        <button data-menu="perfil">üë§<span>Perfil</span></button>
    </nav>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="custom-confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-titulo">Confirmar A√ß√£o</h3>
            <p id="modal-mensagem">Tem a certeza que deseja prosseguir?</p>
            <div class="modal-botoes">
                <button id="modal-btn-cancelar">Cancelar</button>
                <button id="modal-btn-confirmar">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE AUTENTICA√á√ÉO -->
    <div id="modal-auth-janela" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
        <div style="background:white;padding:2rem 1.5rem;border-radius:8px;min-width:320px;max-width:95vw;box-shadow:0 2px 16px #0003;">
            <div id="modal-auth-loading" style="display:none;text-align:center;margin-bottom:1rem;">Carregando...</div>
            <div id="modal-auth-login" class="modal-auth-step">
                <h2>Entrar</h2>
                <button type="button" class="modal-auth-btn" id="modal-auth-btn-google" style="width:100%;margin-bottom:1em;">Entrar com Google</button>
                <div style="text-align:center;color:#888;margin:8px 0;">ou</div>
                <form id="modal-auth-form-login">
                    <input id="modal-auth-login-email" type="email" placeholder="Email" required style="width:100%;margin-bottom:6px;">
                    <input id="modal-auth-login-senha" type="password" placeholder="Senha" required style="width:100%;margin-bottom:10px;">
                    <button class="modal-auth-btn" style="width:100%;">Entrar</button>
                </form>
                <div style="text-align:center;margin-top:10px;">
                    <a href="#" id="modal-auth-btn-to-cadastro">Criar nova conta</a>
                </div>
            </div>
            <div id="modal-auth-cadastro" class="modal-auth-step" style="display:none;">
                <h2>Criar Conta</h2>
                <form id="modal-auth-form-cadastro">
                    <input id="modal-auth-cadastro-nome" type="text" placeholder="Nome completo" required style="width:100%;margin-bottom:6px;">
                    <input id="modal-auth-cadastro-email" type="email" placeholder="Email" required style="width:100%;margin-bottom:6px;">
                    <input id="modal-auth-cadastro-senha" type="password" placeholder="Senha" required style="width:100%;margin-bottom:6px;">
                    <input id="modal-auth-cadastro-telefone" type="tel" placeholder="Telefone (WhatsApp)" required style="width:100%;margin-bottom:10px;">
                    <button class="modal-auth-btn" style="width:100%;">Cadastrar</button>
                </form>
                <div style="text-align:center;margin-top:10px;">
                    <a href="#" id="modal-auth-btn-to-login">J√° tenho conta</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SCRIPTS -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Mostra logo e nome no topo do main-content no mobile
        function toggleMobileHeader() {
          if(window.innerWidth <= 900) {
            document.querySelector('.header-vitrine-mobile').style.display = "flex";
            // Sincroniza logo e nome (pode ser din√¢mico do Firebase)
            document.getElementById('logo-publico-mobile').src = document.getElementById('logo-publico').src;
            document.getElementById('nome-negocio-publico-mobile').textContent = document.getElementById('nome-negocio-publico').textContent;
          } else {
            document.querySelector('.header-vitrine-mobile').style.display = "none";
          }
        }
        toggleMobileHeader();
        window.addEventListener('resize', toggleMobileHeader);

        function showMenu(menu) {
          document.querySelectorAll('.sidebar-menu .menu-btn').forEach(b => b.classList.remove('ativo'));
          document.querySelectorAll('.bottom-nav-vitrine button').forEach(b => b.classList.remove('ativo'));
          document.querySelectorAll('.main-content-vitrine .menu-content').forEach(sec => sec.classList.remove('ativo'));
          let btnSide = document.querySelector('.sidebar-menu .menu-btn[data-menu="' + menu + '"]');
          let btnMob = document.querySelector('.bottom-nav-vitrine button[data-menu="' + menu + '"]');
          let tela = document.getElementById('menu-' + menu);
          if(btnSide) btnSide.classList.add('ativo');
          if(btnMob) btnMob.classList.add('ativo');
          if(tela) tela.classList.add('ativo');
          if(menu === "informacoes" && window.renderInformacoes) window.renderInformacoes();
          if(menu === "agendamento" && window.renderAgendamento) window.renderAgendamento();
          if(menu === "visualizacao" && window.renderVisualizacao) window.renderVisualizacao();
          if(menu === "perfil" && window.renderPerfil) window.renderPerfil();
        }
        // Sidebar navigation
        document.querySelectorAll('.sidebar-menu .menu-btn').forEach(btn => {
          btn.addEventListener('click', function() { showMenu(btn.dataset.menu); });
        });
        // Bottom navigation
        function toggleNavs() {
          if(window.innerWidth <= 900) {
            document.querySelector('.bottom-nav-vitrine').style.display = "flex";
            if(document.querySelector('.sidebar-vitrine')) document.querySelector('.sidebar-vitrine').style.display = "none";
          } else {
            document.querySelector('.bottom-nav-vitrine').style.display = "none";
            if(document.querySelector('.sidebar-vitrine')) document.querySelector('.sidebar-vitrine').style.display = "";
          }
        }
        toggleNavs();
        window.addEventListener('resize', toggleNavs);

        document.querySelectorAll('.bottom-nav-vitrine button').forEach(btn => {
          btn.addEventListener('click', function() { showMenu(btn.dataset.menu); window.scrollTo({ top: 0, behavior: 'smooth' }); });
        });

        // Sele√ß√£o de profissional visual (mobile e desktop)
        document.getElementById('lista-profissionais').addEventListener('click', function(e) {
          const card = e.target.closest('.card-profissional');
          if (!card) return;
          document.querySelectorAll('.card-profissional').forEach(c => c.classList.remove('selecionado'));
          card.classList.add('selecionado');
          window.state = window.state || {};
          window.state.agendamento = window.state.agendamento || {};
          window.state.agendamento.profissionalId = card.dataset.id;
          if(window.onProfissionalSelecionado) window.onProfissionalSelecionado(card.dataset.id);
        });
      });
    </script>

    <script type="module" src="./vitrini-firebase.js"></script>
    <script type="module" src="./vitrini-utils.js"></script>
    <script type="module" src="./vitrini-profissionais.js"></script>
    <script type="module" src="./vitrini-agendamento.js"></script>
    <script type="module" src="./vitrini-state.js"></script>
    <script type="module" src="./vitrini-ui.js"></script>
    <script type="module" src="./vitrini-auth.js"></script>
    <script type="module" src="./vitrine.js"></script>
    <script type="module" src="./vitrine-auth-modal.js"></script>

    <!-- ======= Integra√ß√£o m√≠nima para RESPEITAR a agenda/aus√™ncias do profissional
                  e tratar m√∫ltiplos servi√ßos (n√£o altera l√≥gica de servidor) ======= -->
    <script type="module">
      import { db } from './vitrini-firebase.js';
      // Este m√≥dulo intercepta o clique "Escolher Data e Hor√°rio" e:
      //  - calcula dura√ß√£o total dos servi√ßos selecionados,
      //  - garante que a busca de data/hor√°rios respeite aus√™ncias do profissional,
      //    usando profissional.ausencias se dispon√≠vel, ou tentando ler a subcole√ß√£o
      //    com tratamento silencioso para permission-denied,
      //  - chama as fun√ß√µes existentes de vitrini-agendamento.js (buscarAgendamentosDoDia,
      //    calcularSlotsDisponiveis, encontrarPrimeiraDataComSlots quando dispon√≠vel),
      //  - renderiza os hor√°rios dispon√≠veis no #grade-horarios e habilita o bot√£o confirmar.
      //
      // Razo√°vel, robusto e n√£o altera a l√≥gica de cria√ß√£o/cancelamento no servidor.

      document.addEventListener('DOMContentLoaded', () => {
        const btnProsseguir = document.getElementById('btn-prosseguir-data');
        if (!btnProsseguir) return;

        btnProsseguir.addEventListener('click', async (ev) => {
          ev.preventDefault();
          try {
            btnProsseguir.disabled = true;
            const originalText = btnProsseguir.textContent;
            btnProsseguir.textContent = 'Buscando datas...';

            const empresaId = localStorage.getItem('empresaAtivaId');
            if (!empresaId) throw new Error('Empresa n√£o encontrada.');

            // 1) calcula dura√ß√£o total dos servi√ßos selecionados a partir do estado (quando preenchido)
            const stateAg = (window.state && window.state.agendamento) ? window.state.agendamento : {};
            let servicos = Array.isArray(stateAg.servicos) ? stateAg.servicos.slice() : [];

            // Se n√£o houver servi√ßos no estado, tenta ler do DOM (cards marcados)
            if (!servicos || servicos.length === 0) {
              const selectedEls = document.querySelectorAll('.servico-card.selecionado, .servico-card.selected');
              selectedEls.forEach(el => {
                const dur = Number(el.dataset.duracao || el.getAttribute('data-duracao') || 0);
                const id = el.dataset.id || el.getAttribute('data-id') || null;
                servicos.push({ id, duracao: dur });
              });
            }

            // Dura√ß√£o total em minutos
            const totalDuration = servicos.reduce((acc, s) => acc + (Number(s.duracao) || 0), 0);
            if (!totalDuration || totalDuration <= 0) {
              // Pode ser que o seu fluxo espere um servi√ßo selecionado; n√£o altera l√≥gica do servidor
              throw new Error('Selecione um servi√ßo v√°lido antes de prosseguir.');
            }

            // 2) identifica profissional selecionado
            const profissionalId = stateAg.profissionalId || (document.querySelector('.card-profissional.selecionado')?.dataset?.id);
            if (!profissionalId) throw new Error('Selecione um profissional.');

            // 3) obt√©m objeto profissional (tenta usar caches/estado j√° existentes, sen√£o busca doc)
            let profissional = null;
            try {
              // tenta encontrar em state (vitrini-profissionais.js normalmente popula)
              if (window.state && Array.isArray(window.state.profissionais)) {
                profissional = window.state.profissionais.find(p => String(p.id) === String(profissionalId));
              }
              // mapa global se existir
              if (!profissional && window.profissionaisMap) profissional = window.profissionaisMap[profissionalId];

              // se ainda n√£o, tenta buscar doc direto (com tratamento silencioso)
              if (!profissional && empresaId) {
                try {
                  const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
                  const profRef = doc(db, 'empresarios', empresaId, 'profissionais', profissionalId);
                  const snap = await getDoc(profRef);
                  if (snap.exists()) profissional = { id: snap.id, ...snap.data() };
                } catch (errFetch) {
                  // se permiss√£o ou outro erro ao ler, n√£o interrompe; deixamos profissional nulo e tentamos seguir com o que houver
                  console.warn('N√£o foi poss√≠vel carregar profissional por fetch (segue com o que j√° houver):', errFetch && errFetch.message ? errFetch.message : errFetch);
                }
              }
            } catch (errProf) {
              console.warn('Erro ao obter objeto do profissional (continua tentativa):', errProf);
            }

            if (!profissional) {
              throw new Error('Dados do profissional n√£o dispon√≠veis no cliente. Recarregue a p√°gina e tente novamente.');
            }

            // 4) prepara o conjunto de aus√™ncias: usa profissional.ausencias se existir; caso contr√°rio,
            //    tenta ler a subcole√ß√£o 'ausencias' do profissional (com try/catch que silencia permission-denied)
            let ausenciasSet = new Set();
            if (Array.isArray(profissional.ausencias) && profissional.ausencias.length > 0) {
              profissional.ausencias.forEach(d => ausenciasSet.add(String(d)));
            } else {
              // tenta ler subcole√ß√£o (se permitido), sem poluir console em caso de permission-denied
              try {
                const { collection, query, getDocs } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
                const ausRef = collection(db, 'empresarios', empresaId, 'profissionais', profissionalId, 'ausencias');
                const q = query(ausRef);
                const snap = await getDocs(q);
                if (!snap.empty) {
                  snap.forEach(doc => {
                    const d = doc.data();
                    if (d && d.data) ausenciasSet.add(String(d.data));
                  });
                }
              } catch (errAus) {
                const code = errAus && (errAus.code || errAus.message || '').toString().toLowerCase();
                if (code.includes('permission') || code.includes('permission-denied')) {
                  // suprime ‚Äî comportamento intencional para n√£o quebrar UX
                } else {
                  console.warn('Aviso ao ler aus√™ncias do profissional (continua):', errAus);
                }
              }
            }

            // 5) busca primeira data com slots respeitando aus√™ncias e a agenda do profissional
            //    usamos a fun√ß√£o existente quando dispon√≠vel; caso contr√°rio, iteramos n√≥s mesmos
            const agModule = await import('./vitrini-agendamento.js'); // usa as fun√ß√µes j√° existentes (buscarAgendamentosDoDia, calcularSlotsDisponiveis)
            let primeiraData = null;

            // Se o m√≥dulo exportar encontrarPrimeiraDataComSlots e voc√™ confia nele, use-o,
            // caso contr√°rio, iteramos manualmente (mantendo comportamento compat√≠vel).
            if (typeof agModule.encontrarPrimeiraDataComSlots === 'function') {
              try {
                // Passamos totalDuration para a fun√ß√£o (ela espera duracaoServico)
                primeiraData = await agModule.encontrarPrimeiraDataComSlots(empresaId, { ...profissional, ausencias: Array.from(ausenciasSet) }, totalDuration);
              } catch (errUseModule) {
                // se por algum motivo o m√©todo do m√≥dulo falhar, ca√≠mos para implementa√ß√£o local abaixo
                console.warn('M√©todo built-in encontrarPrimeiraDataComSlots falhou, usando fallback local:', errUseModule);
                primeiraData = null;
              }
            }

            if (!primeiraData) {
              // fallback local: percorre 90 dias respeitando ausenciasSet e usando buscarAgendamentosDoDia + calcularSlotsDisponiveis
              const hoje = new Date();
              for (let i = 0; i < 90 && !primeiraData; i++) {
                const dataAtual = new Date(hoje);
                dataAtual.setDate(hoje.getDate() + i);
                const y = dataAtual.getFullYear();
                const m = String(dataAtual.getMonth() + 1).padStart(2, '0');
                const d = String(dataAtual.getDate()).padStart(2, '0');
                const dataString = `${y}-${m}-${d}`;

                if (ausenciasSet.size > 0 && ausenciasSet.has(dataString)) continue;

                // buscar agendamentos do dia usando fun√ß√£o do m√≥dulo
                const ags = await agModule.buscarAgendamentosDoDia(empresaId, dataString);
                const agsProf = ags.filter(a => String(a.profissionalId) === String(profissionalId));

                const slots = agModule.calcularSlotsDisponiveis(dataString, agsProf, profissional.horarios, totalDuration);
                if (slots && slots.length > 0) {
                  primeiraData = dataString;
                  break;
                }
              }
            }

            if (!primeiraData) {
              alert('N√£o h√° datas com slots dispon√≠veis nos pr√≥ximos 90 dias para este profissional.');
              btnProsseguir.disabled = false;
              btnProsseguir.textContent = originalText;
              return;
            }

            // 6) populate UI: coloca data no input, mostra container e renderiza hor√°rios dispon√≠veis
            const dateInput = document.getElementById('data-agendamento');
            dateInput.value = primeiraData;
            document.getElementById('data-e-horario-container').style.display = 'block';

            // busca agendamentos do dia e calcula slots com a dura√ß√£o total
            const agendamentosDia = await agModule.buscarAgendamentosDoDia(empresaId, primeiraData);
            const agsProfFinal = agendamentosDia.filter(a => String(a.profissionalId) === String(profissionalId));
            const slotsFinais = agModule.calcularSlotsDisponiveis(primeiraData, agsProfFinal, profissional.horarios, totalDuration);

            const grade = document.getElementById('grade-horarios');
            grade.innerHTML = '';
            if (!slotsFinais || slotsFinais.length === 0) {
              grade.innerHTML = '<p class="aviso-horarios">Nenhum hor√°rio dispon√≠vel nessa data.</p>';
            } else {
              slotsFinais.forEach(slot => {
                const b = document.createElement('button');
                b.type = 'button';
                b.className = 'horario-btn';
                b.textContent = slot;
                b.addEventListener('click', () => {
                  // seleciona visualmente e atualiza state
                  document.querySelectorAll('.horario-btn.selected').forEach(x => x.classList.remove('selected'));
                  b.classList.add('selected');

                  window.state = window.state || {};
                  window.state.agendamento = window.state.agendamento || {};
                  window.state.agendamento.data = primeiraData;
                  window.state.agendamento.horario = slot;
                  // atualiza servi√ßos no state tamb√©m (garante envio correto)
                  window.state.agendamento.servicos = servicos;
                  // habilita confirmar
                  const btnConfirm = document.getElementById('btn-confirmar-agendamento');
                  if (btnConfirm) btnConfirm.disabled = false;

                  // atualiza resumo final
                  const resumo = document.getElementById('resumo-agendamento-final');
                  if (resumo) {
                    const servText = servicos.map(s => (s.nome || s.servicoNome || s.id || 'Servi√ßo') + (s.duracao ? ` (${s.duracao}min)` : '')).join(', ');
                    resumo.innerHTML = `<strong>${(profissional.nome || 'Profissional')}</strong><br>${servText}<br>${primeiraData} √†s ${slot}`;
                  }
                });
                grade.appendChild(b);
              });
            }

            // scroll to horarios
            try { document.getElementById('data-e-horario-container').scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) {}

            btnProsseguir.disabled = false;
            btnProsseguir.textContent = originalText;

          } catch (err) {
            console.error('Erro no fluxo de pesquisa de datas/hor√°rios:', err);
            alert(err && err.message ? err.message : 'Erro ao buscar datas/hor√°rios. Tente novamente.');
            btnProsseguir.disabled = false;
            btnProsseguir.textContent = 'Escolher Data e Hor√°rio';
          }
        });
      });
    </script>
</body>
</html>
