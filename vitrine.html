<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>Agendamento Online</title>
Â  <style>
Â  Â  :root {
Â  Â  Â  --cor-fundo: #f5f7fa;
Â  Â  Â  --cor-primaria: #6366f1;
Â  Â  Â  --cor-primaria-leve: #a5b4fc;
Â  Â  Â  --cor-texto-leve: #4b5563;
Â  Â  Â  --cor-sucesso: #22c55e;
Â  Â  }
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
Â  Â  Â  background: var(--cor-fundo);
Â  Â  Â  color: #333;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  padding: 20px;
Â  Â  }
Â  Â  main.main-content {
Â  Â  Â  max-width: 700px;
Â  Â  Â  width: 100%;
Â  Â  Â  background: white;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 25px 30px;
Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .header-vitrine {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  padding-bottom: 20px;
Â  Â  }
Â  Â  .header-vitrine img {
Â  Â  Â  width: 100px;
Â  Â  Â  height: 100px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  object-fit: cover;
Â  Â  Â  border: 3px solid var(--cor-primaria-leve);
Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  .header-vitrine h1 {
Â  Â  Â  font-size: 2em;
Â  Â  Â  color: var(--cor-primaria);
Â  Â  Â  margin: 0;
Â  Â  }
Â  Â  .header-vitrine p {
Â  Â  Â  margin: 5px 0 0;
Â  Â  Â  color: var(--cor-texto-leve);
Â  Â  }
Â  Â  h2 {
Â  Â  Â  font-size: 1.3em;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  border-bottom: 2px solid var(--cor-primaria-leve);
Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  color: var(--cor-primaria);
Â  Â  }
Â  Â  .form-group {
Â  Â  Â  margin-bottom: 25px;
Â  Â  }
Â  Â  label {
Â  Â  Â  display: block;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  color: var(--cor-primaria);
Â  Â  }
Â  Â  #lista-servicos, #grade-horarios {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  .btn-servico, .btn-horario {
Â  Â  Â  background: #e0e7ff;
Â  Â  Â  border: 1px solid var(--cor-primaria-leve);
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 10px 15px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  color: var(--cor-primaria);
Â  Â  Â  font-weight: 600;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  .btn-servico.selecionado, .btn-horario.selecionado,
Â  Â  .btn-servico:hover, .btn-horario:hover {
Â  Â  Â  background: var(--cor-primaria);
Â  Â  Â  color: white;
Â  Â  Â  border-color: var(--cor-primaria);
Â  Â  }
Â  Â  .detalhes-servico {
Â  Â  Â  background-color: #f8f9fa;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 10px;
Â  Â  Â  margin-top: 5px;
Â  Â  Â  border-left: 3px solid var(--cor-primaria);
Â  Â  }
Â  Â  input[type="date"], input[type="text"], input[type="tel"] {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 10px 12px;
Â  Â  Â  font-size: 1em;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  button#btn-confirmar-agendamento {
Â  Â  Â  background: var(--cor-sucesso);
Â  Â  Â  border: none;
Â  Â  Â  padding: 12px 18px;
Â  Â  Â  color: white;
Â  Â  Â  font-size: 1.1em;
Â  Â  Â  font-weight: 700;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  width: 100%;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  }
Â  Â  button#btn-confirmar-agendamento:disabled {
Â  Â  Â  background: #a7f3d0;
Â  Â  Â  cursor: not-allowed;
Â  Â  }

Â  Â  /* --- ESTILOS DO NOVO FLUXO --- */
Â  Â  .btn-flutuante {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  background-color: var(--cor-primaria);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 50px;
Â  Â  Â  Â  padding: 15px 20px;
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  z-index: 1000;
Â  Â  }
Â  Â  .saudacao {
Â  Â  Â  Â  max-width: 700px;
Â  Â  Â  Â  margin: 0 auto 15px auto;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  background-color: #e7f3ff;
Â  Â  Â  Â  border: 1px solid #cce5ff;
Â  Â  Â  Â  color: #004085;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  font-weight: 500;
Â  Â  }
Â  Â  .modal {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  z-index: 1001;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  overflow: auto;
Â  Â  Â  Â  background-color: rgba(0,0,0,0.5);
Â  Â  Â  Â  display: none; /* ComeÃ§a escondido */
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  Â  background-color: #fefefe;
Â  Â  Â  Â  padding: 25px 30px;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
Â  Â  }
Â  Â  .modal-content h3 { color: var(--cor-primaria); }
Â  Â  .modal-content button {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  background: var(--cor-primaria);
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  .fechar-modal {
Â  Â  Â  Â  color: #aaa;
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 10px;
Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  cursor: pointer;
Â  Â  }
Â  Â  #agendamentos-cliente .agendamento-item {
Â  Â  Â  padding: 15px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  background: #f9f9f9;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .btn-cancelar {
Â  Â  Â  Â  background-color: #ef4444;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  padding: 5px 10px;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  }
Â  </style>
</head>
<body>

Â  <!-- BOTÃƒO FLUTUANTE E MODAL (HTML NOVO) -->
Â  <button id="btn-primeiro-acesso" class="btn-flutuante" style="display:none;">ðŸ‘¤ Primeiro Acesso</button>
Â  <div id="saudacao-cliente" class="saudacao" style="display:none;"></div>
Â  <div id="modal-primeiro-acesso" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <span class="fechar-modal">&times;</span>
Â  Â  Â  <h3>Identifique-se uma vez</h3>
Â  Â  Â  <p>Seus dados ficam salvos no seu navegador para facilitar seus prÃ³ximos agendamentos.</p>
Â  Â  Â  <input type="text" id="input-nome-modal" placeholder="Seu nome completo" required>
Â  Â  Â  <input type="tel" id="input-telefone-modal" placeholder="Seu WhatsApp (com DDD)" required style="margin-top: 10px;">
Â  Â  Â  <button id="btn-salvar-dados-cliente">Salvar e continuar</button>
Â  Â  </div>
Â  </div>

Â  <main class="main-content">
Â  Â  <div id="vitrine-loader">
Â  Â  Â  <p style="text-align: center;">A carregar informaÃ§Ãµes do profissional...</p>
Â  Â  </div>

Â  Â  <div id="vitrine-content" style="display: none;">
Â  Â  Â  <header class="header-vitrine">
Â  Â  Â  Â  <img id="logo-publico" src="https://placehold.co/100x100/e0e7ff/6366f1?text=Logo" alt="LogÃ³tipo do NegÃ³cio">
Â  Â  Â  Â  <h1 id="nome-negocio-publico">Nome do NegÃ³cio</h1>
Â  Â  Â  Â  <p id="data-atual"></p>
Â  Â  Â  </header>

Â  Â  Â  <!-- SEÃ‡ÃƒO PARA MOSTRAR OS AGENDAMENTOS DO CLIENTE -->
Â  Â  Â  <div id="agendamentos-cliente" style="display: none;">
Â  Â  Â  Â  <h2>Meus Agendamentos</h2>
Â  Â  Â  Â  <div id="lista-meus-agendamentos"></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="agendamento-container form-card">
Â  Â  Â  Â  <h2>FaÃ§a o seu Agendamento</h2>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label>1. Escolha um serviÃ§o</label>
Â  Â  Â  Â  Â  <div id="lista-servicos"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label for="data-agendamento">2. Escolha uma data e horÃ¡rio</label>
Â  Â  Â  Â  Â  <input type="date" id="data-agendamento" required>
Â  Â  Â  Â  Â  <div id="grade-horarios">
Â  Â  Â  Â  Â  Â  <p class="aviso-horarios">Selecione uma data para ver os horÃ¡rios.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label>3. Os seus dados</label>
Â  Â  Â  Â  Â  <input type="text" id="nome-cliente" placeholder="O seu nome completo" required>
Â  Â  Â  Â  Â  <input type="tel" id="telefone-cliente" placeholder="O seu telefone (WhatsApp)" required style="margin-top: 10px;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="btn-confirmar-agendamento" disabled>Confirmar Agendamento</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </main>

Â  <script type="module">
Â  Â  // ImportaÃ§Ãµes do Firebase SDK
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
Â  Â  import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, Timestamp, limit, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

Â  Â  // --- CONFIGURAÃ‡ÃƒO DO FIREBASE ---
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCnGK3j90_UpBdRpu5nhSs-nY84I_e0cAk",
Â  Â  Â  authDomain: "pronti-app-37c6e.firebaseapp.com",
Â  Â  Â  projectId: "pronti-app-37c6e",
Â  Â  Â  storageBucket: "pronti-app-37c6e.appspot.com",
Â  Â  Â  messagingSenderId: "736700619274",
Â  Â  Â  appId: "1:736700619274:web:557aa247905e56fa7e5df3"
Â  Â  };
Â  Â Â 
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getFirestore(app);

Â  Â  let profissionalUid = null;
Â  Â  let servicoSelecionado = null;
Â  Â  let horarioSelecionado = null;
Â  Â  let horariosConfig = {};

Â  Â  const loader = document.getElementById('vitrine-loader');
Â  Â  const content = document.getElementById('vitrine-content');
Â  Â  const nomeNegocioEl = document.getElementById('nome-negocio-publico');
Â  Â  const dataAtualEl = document.getElementById('data-atual');
Â  Â  const logoEl = document.getElementById('logo-publico');
Â  Â  const servicosContainer = document.getElementById('lista-servicos');
Â  Â  const dataInput = document.getElementById('data-agendamento');
Â  Â  const horariosContainer = document.getElementById('grade-horarios');
Â  Â  const nomeClienteInput = document.getElementById('nome-cliente');
Â  Â  const telefoneClienteInput = document.getElementById('telefone-cliente');
Â  Â  const btnConfirmar = document.getElementById('btn-confirmar-agendamento');
Â  Â  const btnPrimeiroAcesso = document.getElementById('btn-primeiro-acesso');
Â  Â  const saudacaoClienteEl = document.getElementById('saudacao-cliente');
Â  Â  const modalAcesso = document.getElementById('modal-primeiro-acesso');
Â  Â  const btnSalvarDadosModal = document.getElementById('btn-salvar-dados-cliente');
Â  Â  const btnFecharModal = modalAcesso.querySelector('.fechar-modal');
Â  Â  const inputNomeModal = document.getElementById('input-nome-modal');
Â  Â  const inputTelefoneModal = document.getElementById('input-telefone-modal');
Â  Â  const agendamentosClienteContainer = document.getElementById('agendamentos-cliente');
Â  Â  const listaMeusAgendamentosEl = document.getElementById('lista-meus-agendamentos');

Â  Â  async function inicializarVitrine() {
Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  const slug = urlParams.get('slug');

Â  Â  Â  Â  if (!slug) {
Â  Â  Â  Â  Â  Â  loader.innerHTML = `<p style="color:red; text-align:center;">Link invÃ¡lido. O profissional nÃ£o foi especificado.</p>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  profissionalUid = await encontrarUidPeloSlug(slug);
Â  Â  Â  Â  Â  Â  if (!profissionalUid) {
Â  Â  Â  Â  Â  Â  Â  Â  loader.innerHTML = `<p style="color:red; text-align:center;">Profissional nÃ£o encontrado. Verifique o link.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  carregarPerfilPublico(),
Â  Â  Â  Â  Â  Â  Â  Â  carregarConfiguracoesHorario(),
Â  Â  Â  Â  Â  Â  Â  Â  carregarServicos()
Â  Â  Â  Â  Â  Â  ]);

Â  Â  Â  Â  Â  Â  loader.style.display = 'none';
Â  Â  Â  Â  Â  Â  content.style.display = 'block';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  configurarEventosGerais();
Â  Â  Â  Â  Â  Â  gerenciarSessaoDoCliente();

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Erro ao inicializar a vitrine:", error);
Â  Â  Â  Â  Â  Â  loader.innerHTML = `<p style="color:red; text-align:center;">NÃ£o foi possÃ­vel carregar a pÃ¡gina deste profissional.</p>`;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function configurarEventosGerais() {
Â  Â  Â  Â  dataInput.value = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  dataInput.min = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  dataInput.addEventListener('change', gerarHorariosDisponiveis);
Â  Â  Â  Â  nomeClienteInput.addEventListener('input', verificarEstadoBotaoConfirmar);
Â  Â  Â  Â  telefoneClienteInput.addEventListener('input', verificarEstadoBotaoConfirmar);
Â  Â  Â  Â  btnConfirmar.addEventListener('click', salvarAgendamento);
Â  Â  Â  Â  gerarHorariosDisponiveis();
Â  Â  }

Â  Â  function limparTelefone(telefone) {
Â  Â  Â  Â  return telefone ? telefone.replace(/\D/g, '') : "";
Â  Â  }

Â  Â  function gerenciarSessaoDoCliente() {
Â  Â  Â  Â  const dadosCliente = JSON.parse(localStorage.getItem('dadosClientePronti'));
Â  Â  Â  Â  if (dadosCliente && dadosCliente.telefone) {
Â  Â  Â  Â  Â  Â  iniciarSessaoIdentificada(dadosCliente);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  configurarPrimeiroAcesso();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function iniciarSessaoIdentificada(dadosCliente) {
Â  Â  Â  Â  btnPrimeiroAcesso.style.display = 'none';
Â  Â  Â  Â  saudacaoClienteEl.innerHTML = `OlÃ¡, <strong>${dadosCliente.nome}</strong>! Bem-vindo(a) de volta.`;
Â  Â  Â  Â  saudacaoClienteEl.style.display = 'block';
Â  Â  Â  Â Â 
Â  Â  Â  Â  nomeClienteInput.value = dadosCliente.nome;
Â  Â  Â  Â  telefoneClienteInput.value = dadosCliente.telefone;

Â  Â  Â  Â  verificarEstadoBotaoConfirmar();
Â  Â  Â  Â  carregarAgendamentosCliente(dadosCliente.telefone);
Â  Â  }

Â  Â  function configurarPrimeiroAcesso() {
Â  Â  Â  Â  btnPrimeiroAcesso.style.display = 'block';
Â  Â  Â  Â  btnPrimeiroAcesso.addEventListener('click', () => modalAcesso.style.display = 'flex');
Â  Â  Â  Â  btnFecharModal.addEventListener('click', () => modalAcesso.style.display = 'none');

Â  Â  Â  Â  btnSalvarDadosModal.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const nome = inputNomeModal.value.trim();
Â  Â  Â  Â  Â  Â  const telefone = inputTelefoneModal.value;
Â  Â  Â  Â  Â  Â  const telefoneLimpo = limparTelefone(telefone);

Â  Â  Â  Â  Â  Â  if (nome && telefoneLimpo.length >= 10) {
Â  Â  Â  Â  Â  Â  Â  Â  const dadosCliente = { nome, telefone: telefoneLimpo };
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('dadosClientePronti', JSON.stringify(dadosCliente));
Â  Â  Â  Â  Â  Â  Â  Â  modalAcesso.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  iniciarSessaoIdentificada(dadosCliente);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Por favor, preencha seu nome e um telefone vÃ¡lido.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function encontrarUidPeloSlug(slug) {
Â  Â  Â  Â  const slugRef = doc(db, "slugs", slug);
Â  Â  Â  Â  const docSnap = await getDoc(slugRef);
Â  Â  Â  Â  return docSnap.exists() ? docSnap.data().uid : null;
Â  Â  }

Â  Â  async function carregarPerfilPublico() {
Â  Â  Â  Â  const perfilRef = doc(db, "users", profissionalUid, "publicProfile", "profile");
Â  Â  Â  Â  const docSnap = await getDoc(perfilRef);
Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  Â  nomeNegocioEl.textContent = data.nomeNegocio || "Nome nÃ£o definido";
Â  Â  Â  Â  Â  Â  if (data.logoUrl) logoEl.src = data.logoUrl;
Â  Â  Â  Â  Â  Â  dataAtualEl.textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function carregarConfiguracoesHorario() {
Â  Â  Â  Â  const horariosRef = doc(db, "users", profissionalUid, "configuracoes", "horarios");
Â  Â  Â  Â  const docSnap = await getDoc(horariosRef);
Â  Â  Â  Â  horariosConfig = docSnap.exists() ? docSnap.data() : { intervalo: 30 };
Â  Â  }

Â  Â  async function carregarServicos() {
Â  Â  Â  Â  servicosContainer.innerHTML = '';
Â  Â  Â  Â  const servicosRef = collection(db, "users", profissionalUid, "servicos");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // *** SUA LÃ“GICA ORIGINAL RESTAURADA ***
Â  Â  Â  Â  // Busca TODOS os serviÃ§os do Firebase.
Â  Â  Â  Â  const snapshot = await getDocs(servicosRef);

Â  Â  Â  Â  let servicosVisiveisEncontrados = 0;
Â  Â  Â  Â  snapshot.docs.forEach(doc => {
Â  Â  Â  Â  Â  Â  const servico = { id: doc.id, ...doc.data() };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // O tratamento/filtro Ã© feito AQUI, no aplicativo, como vocÃª pediu.
Â  Â  Â  Â  Â  Â  if (servico.visivelNaVitrine !== false) {
Â  Â  Â  Â  Â  Â  Â  Â  servicosVisiveisEncontrados++;
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  card.className = 'servico-card';

Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-servico" data-id="${servico.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="nome">${servico.nome}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="preco">R$ ${parseFloat(servico.preco).toFixed(2)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhes-servico" id="detalhes-${servico.id}" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>DescriÃ§Ã£o:</strong> ${servico.descricao || 'NÃ£o informada.'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>DuraÃ§Ã£o:</strong> ${servico.duracao || 'NÃ£o informada'} minutos</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  servicosContainer.appendChild(card);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (servicosVisiveisEncontrados === 0) {
Â  Â  Â  Â  Â  Â  servicosContainer.innerHTML = '<p>Nenhum serviÃ§o disponÃ­vel para agendamento online no momento.</p>';
Â  Â  Â  Â  }

Â  Â  Â  Â  document.querySelectorAll('.btn-servico').forEach(btnServico => {
Â  Â  Â  Â  Â  Â  btnServico.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const detalhesDiv = btnServico.nextElementSibling;
Â  Â  Â  Â  Â  Â  Â  Â  const isSelected = btnServico.classList.contains('selecionado');

Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.detalhes-servico').forEach(d => d.style.display = 'none');
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.btn-servico').forEach(b => b.classList.remove('selecionado'));

Â  Â  Â  Â  Â  Â  Â  Â  if (!isSelected) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const servicoId = btnServico.dataset.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const servicoNome = btnServico.querySelector('.nome').textContent;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  servicoSelecionado = { id: servicoId, nome: servicoNome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnServico.classList.add('selecionado');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  detalhesDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  servicoSelecionado = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  verificarEstadoBotaoConfirmar();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function gerarHorariosDisponiveis() {
Â  Â  Â  Â  horariosContainer.innerHTML = '<p class="aviso-horarios">A verificar...</p>';
Â  Â  Â  Â  horarioSelecionado = null;
Â  Â  Â  Â  verificarEstadoBotaoConfirmar();

Â  Â  Â  Â  const diaSelecionado = new Date(dataInput.value + "T12:00:00Z");
Â  Â  Â  Â  const diaDaSemana = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'][diaSelecionado.getUTCDay()];
Â  Â  Â  Â Â 
Â  Â  Â  Â  const configDia = horariosConfig[diaDaSemana];
Â  Â  Â  Â  if (!configDia || !configDia.ativo || !configDia.blocos || configDia.blocos.length === 0) {
Â  Â  Â  Â  Â  Â  horariosContainer.innerHTML = '<p class="aviso-horarios">NÃ£o hÃ¡ atendimento neste dia.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const inicioDoDia = new Date(dataInput.value + "T00:00:00Z");
Â  Â  Â  Â  const fimDoDia = new Date(dataInput.value + "T23:59:59Z");

Â  Â  Â  Â  const agendamentosRef = collection(db, "users", profissionalUid, "agendamentos");
Â  Â  Â  Â  const q = query(agendamentosRef, where("horario", ">=", inicioDoDia), where("horario", "<=", fimDoDia));
Â  Â  Â  Â  const snapshot = await getDocs(q);
Â  Â  Â  Â  const horariosOcupados = [];
Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  const horarioData = doc.data().horario;
Â  Â  Â  Â  Â  Â  if (horarioData && typeof horarioData.toDate === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  const dataAg = horarioData.toDate();
Â  Â  Â  Â  Â  Â  Â  Â  horariosOcupados.push(dataAg.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' }));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  horariosContainer.innerHTML = '';
Â  Â  Â  Â  let encontrouHorario = false;
Â  Â  Â  Â  const intervalo = parseInt(horariosConfig.intervalo, 10) || 30;

Â  Â  Â  Â  configDia.blocos.forEach(bloco => {
Â  Â  Â  Â  Â  Â  const [horaInicio, minInicio] = bloco.inicio.split(':').map(Number);
Â  Â  Â  Â  Â  Â  const [horaFim, minFim] = bloco.fim.split(':').map(Number);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (let h = horaInicio; h <= horaFim; h++) {
Â  Â  Â  Â  Â  Â  Â  Â  for (let m = (h === horaInicio ? minInicio : 0); m < (h === horaFim ? minFim : 60); m += intervalo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const horario = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!horariosOcupados.includes(horario)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  encontrouHorario = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.className = 'btn-horario';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = horario;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horarioSelecionado = horario;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.btn-horario').forEach(b => b.classList.remove('selecionado'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('selecionado');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  verificarEstadoBotaoConfirmar();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horariosContainer.appendChild(btn);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!encontrouHorario) {
Â  Â  Â  Â  Â  Â  horariosContainer.innerHTML = '<p class="aviso-horarios">Todos os horÃ¡rios para esta data foram preenchidos.</p>';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function verificarEstadoBotaoConfirmar() {
Â  Â  Â  Â  const nomeOk = nomeClienteInput.value.trim() !== '';
Â  Â  Â  Â  const telOk = limparTelefone(telefoneClienteInput.value).length >= 10;
Â  Â  Â  Â  btnConfirmar.disabled = !(servicoSelecionado && horarioSelecionado && nomeOk && telOk);
Â  Â  }

Â  Â  async function salvarAgendamento() {
Â  Â  Â  Â  btnConfirmar.disabled = true;
Â  Â  Â  Â  btnConfirmar.textContent = 'Agendando...';

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const [h, m] = horarioSelecionado.split(':');
Â  Â  Â  Â  Â  Â  const dataHora = new Date(dataInput.value + "T00:00:00Z");
Â  Â  Â  Â  Â  Â  dataHora.setUTCHours(h, m, 0, 0);

Â  Â  Â  Â  Â  Â  const nomeCliente = nomeClienteInput.value.trim();
Â  Â  Â  Â  Â  Â  const telefoneCliente = limparTelefone(telefoneClienteInput.value);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const agendamento = {
Â  Â  Â  Â  Â  Â  Â  Â  clienteNome: nomeCliente,
Â  Â  Â  Â  Â  Â  Â  Â  clienteTelefone: telefoneCliente,
Â  Â  Â  Â  Â  Â  Â  Â  servicoId: servicoSelecionado.id,
Â  Â  Â  Â  Â  Â  Â  Â  servicoNome: servicoSelecionado.nome,
Â  Â  Â  Â  Â  Â  Â  Â  horario: Timestamp.fromDate(dataHora),
Â  Â  Â  Â  Â  Â  Â  Â  criadoEm: Timestamp.now(),
Â  Â  Â  Â  Â  Â  Â  Â  profissionalUid: profissionalUid,
Â  Â  Â  Â  Â  Â  Â  Â  status: 'agendado'
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  await addDoc(collection(db, "users", profissionalUid, "agendamentos"), agendamento);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  localStorage.setItem('dadosClientePronti', JSON.stringify({ nome: nomeCliente, telefone: telefoneCliente }));

Â  Â  Â  Â  Â  Â  alert("Agendamento realizado com sucesso!");

Â  Â  Â  Â  Â  Â  servicoSelecionado = null;
Â  Â  Â  Â  Â  Â  horarioSelecionado = null;
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.btn-servico.selecionado').forEach(b => b.classList.remove('selecionado'));
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.detalhes-servico').forEach(d => d.style.display = 'none');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  gerarHorariosDisponiveis();
Â  Â  Â  Â  Â  Â  carregarAgendamentosCliente(telefoneCliente);

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Erro ao salvar agendamento:", error);
Â  Â  Â  Â  Â  Â  alert("NÃ£o foi possÃ­vel realizar o agendamento. Tente novamente.");
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  btnConfirmar.textContent = 'Confirmar Agendamento';
Â  Â  Â  Â  Â  Â  verificarEstadoBotaoConfirmar();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function carregarAgendamentosCliente(telefone) {
Â  Â  Â  Â  const telefoneLimpo = limparTelefone(telefone);
Â  Â  Â  Â  if (!telefoneLimpo) {
Â  Â  Â  Â  Â  Â  agendamentosClienteContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  agendamentosClienteContainer.style.display = 'block';
Â  Â  Â  Â  listaMeusAgendamentosEl.innerHTML = '<p>Carregando seus agendamentos...</p>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const agendamentosRef = collection(db, "users", profissionalUid, "agendamentos");
Â  Â  Â  Â  Â  Â  const q = query(agendamentosRef, where("clienteTelefone", "==", telefoneLimpo), orderBy("horario", "desc"), limit(10));
Â  Â  Â  Â  Â  Â  const snapshot = await getDocs(q);

Â  Â  Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  listaMeusAgendamentosEl.innerHTML = '<p>Nenhum agendamento encontrado para este telefone.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  listaMeusAgendamentosEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  snapshot.forEach(docSnap => {
Â  Â  Â  Â  Â  Â  Â  Â  const ag = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  const id = docSnap.id;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let horarioFormatado = 'Data invÃ¡lida';
Â  Â  Â  Â  Â  Â  Â  Â  const horarioData = ag.horario;
Â  Â  Â  Â  Â  Â  Â  Â  if (horarioData && typeof horarioData.toDate === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horarioFormatado = horarioData.toDate().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (typeof horarioData === 'string') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  horarioFormatado = new Date(horarioData).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  card.className = 'agendamento-item';Â 
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${ag.servicoNome}</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${horarioFormatado}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-cancelar" data-id="${id}">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  card.querySelector('.btn-cancelar').onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!confirm('Deseja realmente cancelar este agendamento?')) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, "users", profissionalUid, "agendamentos", id));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Agendamento cancelado com sucesso.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarAgendamentosCliente(telefoneLimpo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gerarHorariosDisponiveis();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao cancelar:', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('NÃ£o foi possÃ­vel cancelar o agendamento.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  listaMeusAgendamentosEl.appendChild(card);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch(error) {
Â  Â  Â  Â  Â  Â  console.error("Erro ao carregar agendamentos do cliente:", error);
Â  Â  Â  Â  Â  Â  listaMeusAgendamentosEl.innerHTML = '<p style="color:red;">Ocorreu um erro ao buscar seus agendamentos.</p>';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Inicia todo o processo
Â  Â  inicializarVitrine();
Â  </script>
</body>
</html>


Â  Â  // Inicia todo o processo
Â  Â  inicializarVitrine();
Â  </script>
</body>
</html>
