<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agendamento Online</title>
  <style>
    :root {
      --cor-fundo: #f5f7fa;
      --cor-primaria: #6366f1;
      --cor-primaria-leve: #a5b4fc;
      --cor-texto-leve: #4b5563;
      --cor-sucesso: #22c55e;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--cor-fundo);
      color: #333;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    main.main-content {
      max-width: 700px;
      width: 100%;
      background: white;
      border-radius: 12px;
      padding: 25px 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .header-vitrine {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid #eee;
      padding-bottom: 20px;
    }
    .header-vitrine img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--cor-primaria-leve);
      margin-bottom: 10px;
    }
    .header-vitrine h1 {
      font-size: 2em;
      color: var(--cor-primaria);
      margin: 0;
    }
    .header-vitrine p {
      margin: 5px 0 0;
      color: var(--cor-texto-leve);
    }
    h2 {
      font-size: 1.3em;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--cor-primaria-leve);
      padding-bottom: 10px;
      color: var(--cor-primaria);
    }
    .form-group {
      margin-bottom: 25px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--cor-primaria);
    }
    #lista-servicos, #grade-horarios {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .btn-servico, .btn-horario {
      background: #e0e7ff;
      border: 1px solid var(--cor-primaria-leve);
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      color: var(--cor-primaria);
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-servico.selecionado, .btn-horario.selecionado,
    .btn-servico:hover, .btn-horario:hover {
      background: var(--cor-primaria);
      color: white;
      border-color: var(--cor-primaria);
    }
    .detalhes-servico {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-top: 5px;
      border-left: 3px solid var(--cor-primaria);
    }
    input[type="date"], input[type="text"], input[type="tel"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button#btn-confirmar-agendamento {
      background: var(--cor-sucesso);
      border: none;
      padding: 12px 18px;
      color: white;
      font-size: 1.1em;
      font-weight: 700;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button#btn-confirmar-agendamento:disabled {
      background: #a7f3d0;
      cursor: not-allowed;
    }

    /* --- ESTILOS DO NOVO FLUXO --- */
    .btn-flutuante {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--cor-primaria);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 15px 20px;
        font-size: 16px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 1000;
    }
    .saudacao {
        max-width: 700px;
        margin: 0 auto 15px auto;
        text-align: center;
        padding: 10px;
        background-color: #e7f3ff;
        border: 1px solid #cce5ff;
        color: #004085;
        border-radius: 8px;
        font-weight: 500;
    }
    .modal {
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        display: none; /* Come√ßa escondido */
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: #fefefe;
        padding: 25px 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-content h3 { color: var(--cor-primaria); }
    .modal-content button {
        width: 100%;
        margin-top: 15px;
        background: var(--cor-primaria);
        border: none;
        padding: 12px;
        color: white;
        font-size: 1.1em;
        border-radius: 8px;
        cursor: pointer;
    }
    .fechar-modal {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    #agendamentos-cliente .agendamento-item {
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn-cancelar {
        background-color: #ef4444;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn-verificar-agendamentos {
        background: var(--cor-primaria);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
    }
    .aviso-seguranca {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-size: 0.9em;
    }
  </style>
</head>
<body>

  <!-- BOT√ÉO FLUTUANTE E MODAL (HTML NOVO) -->
  <button id="btn-primeiro-acesso" class="btn-flutuante" style="display:none;">üë§ Primeiro Acesso</button>
  <div id="saudacao-cliente" class="saudacao" style="display:none;"></div>
  <div id="modal-primeiro-acesso" class="modal">
    <div class="modal-content">
      <span class="fechar-modal">&times;</span>
      <h3>Identifique-se uma vez</h3>
      <p>Seus dados ficam salvos no seu navegador para facilitar seus pr√≥ximos agendamentos.</p>
      <input type="text" id="input-nome-modal" placeholder="Seu nome completo" required>
      <input type="tel" id="input-telefone-modal" placeholder="Seu WhatsApp (com DDD)" required style="margin-top: 10px;">
      <button id="btn-salvar-dados-cliente">Salvar e continuar</button>
    </div>
  </div>

  <main class="main-content">
    <div id="vitrine-loader">
      <p style="text-align: center;">A carregar informa√ß√µes do profissional...</p>
    </div>

    <div id="vitrine-content" style="display: none;">
      <header class="header-vitrine">
        <img id="logo-publico" src="https://placehold.co/100x100/e0e7ff/6366f1?text=Logo" alt="Log√≥tipo do Neg√≥cio">
        <h1 id="nome-negocio-publico">Nome do Neg√≥cio</h1>
        <p id="data-atual"></p>
      </header>

      <!-- AVISO DE SEGURAN√áA -->
      <div class="aviso-seguranca">
        <strong>‚ö†Ô∏è Aviso de Seguran√ßa:</strong> Esta implementa√ß√£o utiliza verifica√ß√£o de PIN no frontend. 
        Para maior seguran√ßa em produ√ß√£o, recomenda-se o uso de Cloud Functions para valida√ß√£o no backend.
      </div>

      <!-- SE√á√ÉO PARA MOSTRAR OS AGENDAMENTOS DO CLIENTE -->
      <div id="agendamentos-cliente" style="display: none;">
        <h2>Meus Agendamentos</h2>
        <div id="lista-meus-agendamentos"></div>
      </div>

      <div class="agendamento-container form-card">
        <h2>Fa√ßa o seu Agendamento</h2>
        <div class="form-group">
          <label>1. Escolha um servi√ßo</label>
          <div id="lista-servicos"></div>
        </div>
        <div class="form-group">
          <label for="data-agendamento">2. Escolha uma data e hor√°rio</label>
          <input type="date" id="data-agendamento" required>
          <div id="grade-horarios">
            <p class="aviso-horarios">Selecione uma data para ver os hor√°rios.</p>
          </div>
        </div>
        <div class="form-group">
          <label>3. Os seus dados</label>
          <input type="text" id="nome-cliente" placeholder="O seu nome completo" required>
          <input type="tel" id="telefone-cliente" placeholder="O seu telefone (WhatsApp)" required style="margin-top: 10px;">
        </div>
        <button id="btn-confirmar-agendamento" disabled>Confirmar Agendamento</button>
      </div>
    </div>
  </main>

  <script type="module">
    // Importa√ß√µes do Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

    // --- CONFIGURA√á√ÉO DO FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCnGK3j90_UpBdRpu5nhSs-nY84I_e0cAk",
      authDomain: "pronti-app-37c6e.firebaseapp.com",
      projectId: "pronti-app-37c6e",
      storageBucket: "pronti-app-37c6e.appspot.com",
      messagingSenderId: "736700619274",
      appId: "1:736700619274:web:557aa247905e5df3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let profissionalUid = null;
    let servicoSelecionado = null;
    let horarioSelecionado = null;
    let horariosConfig = {};

    const loader = document.getElementById('vitrine-loader');
    const content = document.getElementById('vitrine-content');
    const nomeNegocioEl = document.getElementById('nome-negocio-publico');
    const dataAtualEl = document.getElementById('data-atual');
    const logoEl = document.getElementById('logo-publico');
    const servicosContainer = document.getElementById('lista-servicos');
    const dataInput = document.getElementById('data-agendamento');
    const horariosContainer = document.getElementById('grade-horarios');
    const nomeClienteInput = document.getElementById('nome-cliente');
    const telefoneClienteInput = document.getElementById('telefone-cliente');
    const btnConfirmar = document.getElementById('btn-confirmar-agendamento');
    const btnPrimeiroAcesso = document.getElementById('btn-primeiro-acesso');
    const saudacaoClienteEl = document.getElementById('saudacao-cliente');
    const modalAcesso = document.getElementById('modal-primeiro-acesso');
    const btnSalvarDadosModal = document.getElementById('btn-salvar-dados-cliente');
    const btnFecharModal = modalAcesso.querySelector('.fechar-modal');
    const inputNomeModal = document.getElementById('input-nome-modal');
    const inputTelefoneModal = document.getElementById('input-telefone-modal');
    const agendamentosClienteContainer = document.getElementById('agendamentos-cliente');
    const listaMeusAgendamentosEl = document.getElementById('lista-meus-agendamentos');

    // *** FUN√á√ïES DE SEGURAN√áA COM PIN/SENHA (FRONTEND ONLY) ***

    // Fun√ß√£o para gerar hash SHA-256 no frontend
    async function gerarHashSHA256(texto) {
      const encoder = new TextEncoder();
      const data = encoder.encode(texto);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    // Fun√ß√£o para validar PIN
    function validarPIN(pin) {
      // PIN deve ter entre 4 e 6 d√≠gitos
      if (!/^\d{4,6}$/.test(pin)) {
        return { valido: false, erro: 'PIN deve conter entre 4 e 6 d√≠gitos.' };
      }
      
      // PIN n√£o deve ser sequencial ou muito simples
      const pinsProibidos = ['1234', '4321', '0000', '1111', '2222', '3333', '4444', '5555', '6666', '7777', '8888', '9999'];
      if (pinsProibidos.includes(pin)) {
        return { valido: false, erro: 'PIN muito simples. Escolha uma combina√ß√£o mais segura.' };
      }
      
      return { valido: true };
    }

    async function inicializarVitrine() {
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');

        if (!slug) {
            loader.innerHTML = `<p style="color:red; text-align:center;">Link inv√°lido. O profissional n√£o foi especificado.</p>`;
            return;
        }

        try {
            profissionalUid = await encontrarUidPeloSlug(slug);
            if (!profissionalUid) {
                loader.innerHTML = `<p style="color:red; text-align:center;">Profissional n√£o encontrado. Verifique o link.</p>`;
                return;
            }

            await Promise.all([
                carregarPerfilPublico(),
                carregarConfiguracoesHorario(),
                carregarServicos()
            ]);

            loader.style.display = 'none';
            content.style.display = 'block';

            configurarEventosGerais();
            gerenciarSessaoDoCliente();

        } catch (error) {
            console.error("Erro ao inicializar a vitrine:", error);
            loader.innerHTML = `<p style="color:red; text-align:center;">N√£o foi poss√≠vel carregar a p√°gina deste profissional.</p>`;
        }
    }

    function configurarEventosGerais() {
        dataInput.value = new Date().toISOString().split('T')[0];
        dataInput.min = new Date().toISOString().split('T')[0];
        dataInput.addEventListener('change', gerarHorariosDisponiveis);
        nomeClienteInput.addEventListener('input', verificarEstadoBotaoConfirmar);
        telefoneClienteInput.addEventListener('input', verificarEstadoBotaoConfirmar);
        btnConfirmar.addEventListener('click', salvarAgendamentoComPIN);
    }

    function limparTelefone(telefone) {
        return telefone ? telefone.replace(/\D/g, '') : "";
    }

    function gerenciarSessaoDoCliente() {
        const dadosCliente = JSON.parse(localStorage.getItem('dadosClientePronti'));
        if (dadosCliente && dadosCliente.telefone) {
            iniciarSessaoIdentificada(dadosCliente);
        } else {
            configurarPrimeiroAcesso();
        }
    }

    function iniciarSessaoIdentificada(dadosCliente) {
        btnPrimeiroAcesso.style.display = 'none';
        saudacaoClienteEl.innerHTML = `Ol√°, <strong>${dadosCliente.nome}</strong>! Bem-vindo(a) de volta.`;
        saudacaoClienteEl.style.display = 'block';

        nomeClienteInput.value = dadosCliente.nome;
        telefoneClienteInput.value = dadosCliente.telefone;

        verificarEstadoBotaoConfirmar();
        carregarAgendamentosClienteComPINFrontend(dadosCliente.telefone);
    }

    function configurarPrimeiroAcesso() {
        btnPrimeiroAcesso.style.display = 'block';
        btnPrimeiroAcesso.addEventListener('click', () => modalAcesso.style.display = 'flex');
        btnFecharModal.addEventListener('click', () => modalAcesso.style.display = 'none');

        btnSalvarDadosModal.addEventListener('click', () => {
            const nome = inputNomeModal.value.trim();
            const telefone = inputTelefoneModal.value;
            const telefoneLimpo = limparTelefone(telefone);

            if (nome && telefoneLimpo.length >= 10) {
                const dadosCliente = { nome, telefone: telefoneLimpo };
                localStorage.setItem('dadosClientePronti', JSON.stringify(dadosCliente));
                modalAcesso.style.display = 'none';
                iniciarSessaoIdentificada(dadosCliente);
            } else {
                alert("Por favor, preencha seu nome e um telefone v√°lido.");
            }
        });
    }

    async function encontrarUidPeloSlug(slug) {
        const slugRef = doc(db, "slugs", slug);
        const docSnap = await getDoc(slugRef);
        return docSnap.exists() ? docSnap.data().uid : null;
    }

    async function carregarPerfilPublico() {
        const perfilRef = doc(db, "users", profissionalUid, "publicProfile", "profile");
        const docSnap = await getDoc(perfilRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            nomeNegocioEl.textContent = data.nomeNegocio || "Nome n√£o definido";
            if (data.logoUrl) logoEl.src = data.logoUrl;
            dataAtualEl.textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
        }
    }

    async function carregarConfiguracoesHorario() {
        const horariosRef = doc(db, "users", profissionalUid, "configuracoes", "horarios");
        const docSnap = await getDoc(horariosRef);
        
        if (docSnap.exists()) {
            horariosConfig = docSnap.data();
        } else {
            // Configura√ß√£o padr√£o caso n√£o exista
            horariosConfig = {
                intervalo: 30,
                segunda: { ativo: true, inicio: "09:00", fim: "18:00" },
                terca: { ativo: true, inicio: "09:00", fim: "18:00" },
                quarta: { ativo: true, inicio: "09:00", fim: "18:00" },
                quinta: { ativo: true, inicio: "09:00", fim: "18:00" },
                sexta: { ativo: true, inicio: "09:00", fim: "18:00" },
                sabado: { ativo: false },
                domingo: { ativo: false }
            };
            console.warn('Configura√ß√µes de hor√°rio n√£o encontradas. Usando configura√ß√£o padr√£o.');
        }
        
        console.log('Configura√ß√µes de hor√°rio carregadas:', horariosConfig);
    }

    async function carregarServicos() {
        servicosContainer.innerHTML = '';
        const servicosRef = collection(db, "users", profissionalUid, "servicos");

        const snapshot = await getDocs(servicosRef);

        let servicosVisiveisEncontrados = 0;
        snapshot.docs.forEach(docSnapshot => {
            const servico = { id: docSnapshot.id, ...docSnapshot.data() };

            if (servico.visivelNaVitrine !== false) {
                servicosVisiveisEncontrados++;
                const card = document.createElement('div');
                card.className = 'servico-card';

                card.innerHTML = `
                    <button class="btn-servico" data-id="${servico.id}">
                        <span class="nome">${servico.nome}</span>
                        <span class="preco">R$ ${parseFloat(servico.preco).toFixed(2)}</span>
                    </button>
                    <div class="detalhes-servico" id="detalhes-${servico.id}" style="display: none;">
                        <p><strong>Descri√ß√£o:</strong> ${servico.descricao || 'N√£o informada.'}</p>
                        <p><strong>Dura√ß√£o:</strong> ${servico.duracao || 'N√£o informada'} minutos</p>
                    </div>
                `;
                servicosContainer.appendChild(card);

                const btnServico = card.querySelector('.btn-servico');
                btnServico.addEventListener('click', () => selecionarServico(servico, btnServico));
            }
        });

        if (servicosVisiveisEncontrados === 0) {
            servicosContainer.innerHTML = '<p style="color: #666;">Nenhum servi√ßo dispon√≠vel no momento.</p>';
        }
    }

    function selecionarServico(servico, btnElement) {
        document.querySelectorAll('.btn-servico').forEach(btn => btn.classList.remove('selecionado'));
        document.querySelectorAll('.detalhes-servico').forEach(det => det.style.display = 'none');

        btnElement.classList.add('selecionado');
        document.getElementById(`detalhes-${servico.id}`).style.display = 'block';

        servicoSelecionado = servico;
        verificarEstadoBotaoConfirmar();
        gerarHorariosDisponiveis();
    }

    async function gerarHorariosDisponiveis() {
        console.log('=== IN√çCIO gerarHorariosDisponiveis ===');
        console.log('servicoSelecionado:', servicoSelecionado);
        console.log('dataInput.value:', dataInput.value);
        console.log('horariosConfig:', horariosConfig);
        
        horariosContainer.innerHTML = '<p class="aviso-horarios">Carregando hor√°rios...</p>';

        if (!servicoSelecionado || !dataInput.value) {
            console.log('Condi√ß√£o n√£o atendida: servi√ßo ou data n√£o selecionados');
            horariosContainer.innerHTML = '<p class="aviso-horarios">Selecione um servi√ßo e uma data para ver os hor√°rios.</p>';
            return;
        }

        const dataSelecionada = new Date(dataInput.value + 'T00:00:00');
        const diaSemana = dataSelecionada.getDay();
        const nomesDias = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
        const nomeDia = nomesDias[diaSemana];
        const configDia = horariosConfig[nomeDia];
        
        console.log('dataSelecionada:', dataSelecionada);
        console.log('diaSemana:', diaSemana);
        console.log('nomeDia:', nomeDia);
        console.log('configDia:', configDia);

        if (!configDia || !configDia.ativo) {
            console.log('Dia n√£o ativo ou configura√ß√£o n√£o encontrada');
            horariosContainer.innerHTML = '<p class="aviso-horarios">N√£o h√° atendimento neste dia da semana.</p>';
            return;
        }

        try {
            const agendamentosExistentes = await buscarAgendamentosData(dataSelecionada);
            console.log('agendamentosExistentes:', agendamentosExistentes);
            
            const horariosOcupados = agendamentosExistentes.map(ag => ag.horario.toDate().toTimeString().slice(0, 5));
            console.log('horariosOcupados:', horariosOcupados);

            const horarios = gerarListaHorarios(configDia.inicio, configDia.fim, horariosConfig.intervalo || 30);
            console.log('horarios gerados:', horarios);
            
            const horariosDisponiveis = horarios.filter(h => !horariosOcupados.includes(h));
            console.log('horariosDisponiveis:', horariosDisponiveis);

            if (horariosDisponiveis.length === 0) {
                horariosContainer.innerHTML = '<p class="aviso-horarios">N√£o h√° hor√°rios dispon√≠veis para esta data.</p>';
                return;
            }

            horariosContainer.innerHTML = '';
            horariosDisponiveis.forEach(horario => {
                const btn = document.createElement('button');
                btn.className = 'btn-horario';
                btn.textContent = horario;
                btn.addEventListener('click', () => selecionarHorario(horario, btn));
                horariosContainer.appendChild(btn);
            });
            
            console.log('Hor√°rios exibidos com sucesso');
        } catch (error) {
            console.error('Erro ao gerar hor√°rios:', error);
            horariosContainer.innerHTML = '<p class="aviso-horarios">Erro ao carregar hor√°rios. Tente novamente.</p>';
        }
        
        console.log('=== FIM gerarHorariosDisponiveis ===');
    }

    function gerarListaHorarios(inicio, fim, intervalo) {
        const horarios = [];
        const [horaInicio, minInicio] = inicio.split(':').map(Number);
        const [horaFim, minFim] = fim.split(':').map(Number);

        let horaAtual = horaInicio;
        let minAtual = minInicio;

        while (horaAtual < horaFim || (horaAtual === horaFim && minAtual < minFim)) {
            horarios.push(`${horaAtual.toString().padStart(2, '0')}:${minAtual.toString().padStart(2, '0')}`);
            minAtual += intervalo;
            if (minAtual >= 60) {
                horaAtual += Math.floor(minAtual / 60);
                minAtual = minAtual % 60;
            }
        }

        return horarios;
    }

    async function buscarAgendamentosData(data) {
        try {
            const inicioData = new Date(data);
            inicioData.setHours(0, 0, 0, 0);
            const fimData = new Date(data);
            fimData.setHours(23, 59, 59, 999);

            console.log('Buscando agendamentos entre:', inicioData, 'e', fimData);

            const agendamentosRef = collection(db, "users", profissionalUid, "agendamentos");
            const q = query(
                agendamentosRef,
                where("horario", ">=", Timestamp.fromDate(inicioData)),
                where("horario", "<=", Timestamp.fromDate(fimData))
            );

            const snapshot = await getDocs(q);
            const agendamentos = snapshot.docs.map(docSnapshot => docSnapshot.data());
            
            console.log(`Encontrados ${agendamentos.length} agendamentos para a data`);
            return agendamentos;
        } catch (error) {
            console.error('Erro ao buscar agendamentos:', error);
            // Retornar array vazio em caso de erro para n√£o bloquear a gera√ß√£o de hor√°rios
            return [];
        }
    }

    function selecionarHorario(horario, btnElement) {
        document.querySelectorAll('.btn-horario').forEach(btn => btn.classList.remove('selecionado'));
        btnElement.classList.add('selecionado');
        horarioSelecionado = horario;
        verificarEstadoBotaoConfirmar();
    }

    function verificarEstadoBotaoConfirmar() {
        const nomePreenchido = nomeClienteInput.value.trim().length > 0;
        const telefonePreenchido = telefoneClienteInput.value.trim().length > 0;
        const servicoEscolhido = servicoSelecionado !== null;
        const horarioEscolhido = horarioSelecionado !== null;

        btnConfirmar.disabled = !(nomePreenchido && telefonePreenchido && servicoEscolhido && horarioEscolhido);
    }

    // *** FUN√á√ÉO MODIFICADA PARA INCLUIR PIN (FRONTEND ONLY) ***
    async function salvarAgendamentoComPIN() {
        if (!servicoSelecionado || !horarioSelecionado || !nomeClienteInput.value.trim() || !telefoneClienteInput.value.trim()) {
            alert('Por favor, preencha todos os campos obrigat√≥rios.');
            return;
        }

        // Solicitar PIN do cliente
        const pin = prompt('Crie um PIN de 4 a 6 d√≠gitos para cancelar este agendamento:');
        if (!pin) {
            alert('PIN √© obrigat√≥rio para criar o agendamento.');
            return;
        }

        // Validar PIN
        const validacao = validarPIN(pin);
        if (!validacao.valido) {
            alert(validacao.erro);
            return;
        }

        const telefoneLimpo = limparTelefone(telefoneClienteInput.value);
        if (telefoneLimpo.length < 10) {
            alert('Por favor, insira um telefone v√°lido.');
            return;
        }

        try {
            btnConfirmar.disabled = true;
            btnConfirmar.textContent = 'Salvando...';

            // Gerar hash do PIN
            const pinHash = await gerarHashSHA256(pin);

            const [hora, minuto] = horarioSelecionado.split(':').map(Number);
            const dataHorario = new Date(dataInput.value + 'T00:00:00');
            dataHorario.setHours(hora, minuto, 0, 0);

            const agendamento = {
                servicoId: servicoSelecionado.id,
                servicoNome: servicoSelecionado.nome,
                servicoPreco: servicoSelecionado.preco,
                servicoDuracao: servicoSelecionado.duracao,
                horario: Timestamp.fromDate(dataHorario),
                clienteNome: nomeClienteInput.value.trim(),
                clienteTelefone: telefoneLimpo,
                pinHash: pinHash, // Adicionar hash do PIN
                status: 'agendado',
                criadoEm: Timestamp.now()
            };

            const agendamentosRef = collection(db, "users", profissionalUid, "agendamentos");
            await addDoc(agendamentosRef, agendamento);

            // Mostrar PIN para o cliente
            alert(`Agendamento realizado com sucesso!\n\nSeu PIN para cancelamento: ${pin}\n\nGuarde este PIN com seguran√ßa. Voc√™ precisar√° dele para cancelar o agendamento.`);

            // Salvar dados do cliente no localStorage (sem o PIN)
            const dadosCliente = { nome: nomeClienteInput.value.trim(), telefone: telefoneLimpo };
            localStorage.setItem('dadosClientePronti', JSON.stringify(dadosCliente));

            // Resetar formul√°rio
            servicoSelecionado = null;
            horarioSelecionado = null;
            document.querySelectorAll('.btn-servico').forEach(btn => btn.classList.remove('selecionado'));
            document.querySelectorAll('.detalhes-servico').forEach(det => det.style.display = 'none');
            document.querySelectorAll('.btn-horario').forEach(btn => btn.classList.remove('selecionado'));

            gerarHorariosDisponiveis();
            carregarAgendamentosClienteComPINFrontend(telefoneLimpo);

        } catch (error) {
            console.error("Erro ao salvar agendamento:", error);
            alert('Ocorreu um erro ao salvar o agendamento. Tente novamente.');
        } finally {
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Agendamento';
            verificarEstadoBotaoConfirmar();
        }
    }

    // *** FUN√á√ÉO PARA CARREGAR AGENDAMENTOS COM PIN (FRONTEND ONLY) ***
    async function carregarAgendamentosClienteComPINFrontend(telefone) {
        const telefoneLimpo = limparTelefone(telefone);
        if (!telefoneLimpo) {
            agendamentosClienteContainer.style.display = 'none';
            return;
        }

        agendamentosClienteContainer.style.display = 'block';
        listaMeusAgendamentosEl.innerHTML = '<p>Para ver seus agendamentos, digite seu PIN...</p>';

        // Criar bot√£o para verificar agendamentos
        const btnVerificarAgendamentos = document.createElement('button');
        btnVerificarAgendamentos.textContent = 'Ver Meus Agendamentos';
        btnVerificarAgendamentos.className = 'btn-verificar-agendamentos';

        btnVerificarAgendamentos.onclick = async () => {
            const pin = prompt('Digite seu PIN para ver os agendamentos:');
            if (!pin) return;

            try {
                btnVerificarAgendamentos.disabled = true;
                btnVerificarAgendamentos.textContent = 'Verificando...';

                // Buscar agendamentos do cliente
                const agendamentosRef = collection(db, "users", profissionalUid, "agendamentos");
                const q = query(agendamentosRef, where("clienteTelefone", "==", telefoneLimpo));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    alert('Nenhum agendamento encontrado para este telefone.');
                    return;
                }

                // Verificar PIN para cada agendamento e filtrar os que correspondem
                const agendamentosValidos = [];
                const pinHash = await gerarHashSHA256(pin);
                let pinCorretoEncontrado = false;

                snapshot.forEach(docSnapshot => {
                    const agendamentoData = docSnapshot.data();
                    
                    // Verificar se o PIN hash corresponde
                    if (agendamentoData.pinHash === pinHash) {
                        pinCorretoEncontrado = true;
                        agendamentosValidos.push({
                            id: docSnapshot.id,
                            ...agendamentoData
                        });
                    }
                });

                if (!pinCorretoEncontrado) {
                    alert('PIN incorreto.');
                    return;
                }

                exibirAgendamentosFrontend(agendamentosValidos);

            } catch (error) {
                console.error('Erro ao verificar agendamentos:', error);
                alert('Erro ao verificar agendamentos: ' + error.message);
                listaMeusAgendamentosEl.innerHTML = '<p>Erro ao carregar agendamentos. Tente novamente.</p>';
            } finally {
                btnVerificarAgendamentos.disabled = false;
                btnVerificarAgendamentos.textContent = 'Ver Meus Agendamentos';
            }
        };

        listaMeusAgendamentosEl.innerHTML = '';
        listaMeusAgendamentosEl.appendChild(btnVerificarAgendamentos);
    }

    // *** FUN√á√ÉO PARA EXIBIR AGENDAMENTOS (FRONTEND ONLY) ***
    function exibirAgendamentosFrontend(agendamentos) {
        if (agendamentos.length === 0) {
            listaMeusAgendamentosEl.innerHTML = '<p>Nenhum agendamento encontrado.</p>';
            return;
        }

        listaMeusAgendamentosEl.innerHTML = '';
        
        agendamentos.forEach(ag => {
            let horarioFormatado = 'Data inv√°lida';
            const horarioData = ag.horario;
            
            if (horarioData && typeof horarioData.toDate === 'function') {
                horarioFormatado = horarioData.toDate().toLocaleString('pt-BR', { 
                    dateStyle: 'short', 
                    timeStyle: 'short' 
                });
            } else if (typeof horarioData === 'string') {
                horarioFormatado = new Date(horarioData).toLocaleString('pt-BR', { 
                    dateStyle: 'short', 
                    timeStyle: 'short' 
                });
            }

            const card = document.createElement('div');
            card.className = 'agendamento-item';
            card.innerHTML = `
                <div>
                    <strong>${ag.servicoNome}</strong><br>
                    <span>${horarioFormatado}</span><br>
                    <small>Status: ${ag.status || 'agendado'}</small>
                </div>
                <button class="btn-cancelar" data-id="${ag.id}">Cancelar</button>
            `;

            card.querySelector('.btn-cancelar').onclick = async () => {
                const pin = prompt('Digite seu PIN para cancelar este agendamento:');
                if (!pin) return;

                if (!confirm('Deseja realmente cancelar este agendamento?')) return;

                try {
                    // Verificar PIN antes de cancelar
                    const pinHash = await gerarHashSHA256(pin);
                    if (ag.pinHash !== pinHash) {
                        alert('PIN incorreto.');
                        return;
                    }

                    // Verificar se o agendamento pode ser cancelado (opcional: regra de tempo)
                    const agora = new Date();
                    const horarioAgendamento = ag.horario.toDate();
                    const diferencaHoras = (horarioAgendamento - agora) / (1000 * 60 * 60);

                    // Exemplo: n√£o permitir cancelamento com menos de 2 horas de anteced√™ncia
                    if (diferencaHoras < 2) {
                        alert('N√£o √© poss√≠vel cancelar agendamentos com menos de 2 horas de anteced√™ncia.');
                        return;
                    }

                    // Executar o cancelamento (exclus√£o do documento)
                    const agendamentoRef = doc(db, "users", profissionalUid, "agendamentos", ag.id);
                    await deleteDoc(agendamentoRef);

                    alert('Agendamento cancelado com sucesso.');
                    carregarAgendamentosClienteComPINFrontend(ag.clienteTelefone);
                    gerarHorariosDisponiveis();

                } catch (error) {
                    console.error('Erro ao cancelar agendamento:', error);
                    alert('Erro ao cancelar agendamento: ' + error.message);
                }
            };

            listaMeusAgendamentosEl.appendChild(card);
        });
    }

    // Inicializar a vitrine quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', inicializarVitrine);
  </script>
</body>
</html>
