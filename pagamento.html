<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Pagamento de Assinatura - Pronti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    .container-pagamento {
      background: #ffffff;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 550px;
    }
    h1 {
      color: #1e293b;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    #info-usuario {
      font-size: 1.1rem;
      color: #4f46e5;
      background-color: #eef2ff;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 30px;
      font-weight: 600;
    }
    .lista-planos {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    .card-plano {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    .card-plano:hover {
      border-color: #94a3b8;
      transform: translateY(-3px);
    }
    .card-plano.selecionado {
      border-color: #10b981;
      background-color: #f0fdf4;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
    }
    .card-plano.desabilitado {
      background-color: #f8fafc;
      color: #cbd5e1;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .card-plano.desabilitado:hover {
      border-color: #e2e8f0;
      transform: none;
    }
    .card-plano .titulo {
      font-size: 1.2rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0;
    }
    .card-plano.desabilitado .titulo {
      color: #94a3b8;
    }
    .card-plano .preco {
      font-size: 1.5rem;
      font-weight: 700;
      color: #10b981;
      margin: 10px 0 5px 0;
    }
    .card-plano .preco span {
      font-size: 1rem;
      font-weight: 400;
      color: #64748b;
    }
    .card-plano .descricao {
      font-size: 0.9rem;
      color: #64748b;
      margin: 0;
    }
    #erro-selecao {
      color: #dc2626;
      font-weight: 600;
      min-height: 24px;
      margin-top: 0;
    }
    .btn-pagar {
      width: 100%;
      background: #10b981;
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 15px 0;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 10px;
    }
    .btn-pagar:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container-pagamento">
    <h1>Renove a sua Assinatura</h1>
    <h2 id="info-usuario">A carregar dados da sua empresa...</h2>

    <div class="lista-planos"></div>

    <p id="erro-selecao"></p>
    <button id="btn-pagar" class="btn-pagar" disabled>Selecione um plano</button>
  </div>

  <script type="module">
    import { auth } from "./firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    // =========================================================================
    // CORREÇÃO FINAL: As URLs agora apontam para a região correta (southamerica-east1)
    // =========================================================================
    const getStatusUrl =
      "https://southamerica-east1-pronti-app-37c6e.cloudfunctions.net/verificarEmpresa";
    const createPreferenceUrl =
      "https://southamerica-east1-pronti-app-37c6e.cloudfunctions.net/createPreference";

    const infoUsuarioDiv = document.getElementById("info-usuario");
    const listaPlanosContainer = document.querySelector(".lista-planos");
    const btnPagar = document.getElementById("btn-pagar");
    const erroSelecao = document.getElementById("erro-selecao");

    let planoSelecionado = null;
    let licencasNecessarias = 0;

    const configuracaoPrecos = {
      precoBase: 59.90,
      funcionariosInclusos: 2,
      faixasDePrecoExtra: [
        { de: 3, ate: 10, valor: 29.90 },
        { de: 11, ate: 50, valor: 24.90 }
      ]
    };

    const planosParaExibir = [2, 3, 5, 10, 15, 20, 30, 50];

    // CORREÇÃO: Usando a mesma lógica de cálculo do backend para consistência.
    function calcularPreco(totalFuncionarios) {
      if (totalFuncionarios <= 0) return 0;
      if (totalFuncionarios <= configuracaoPrecos.funcionariosInclusos) return configuracaoPrecos.precoBase;
      let precoTotal = configuracaoPrecos.precoBase;
      const funcionariosExtras = totalFuncionarios - configuracaoPrecos.funcionariosInclusos;
      let funcionariosJaPrecificados = 0;
      for (const faixa of configuracaoPrecos.faixasDePrecoExtra) {
        const funcionariosNaFaixa = (faixa.ate - faixa.de) + 1;
        const extrasNestaFaixa = Math.min(funcionariosExtras - funcionariosJaPrecificados, funcionariosNaFaixa);
        if (extrasNestaFaixa > 0) {
          precoTotal += extrasNestaFaixa * faixa.valor;
          funcionariosJaPrecificados += extrasNestaFaixa;
        }
        if (funcionariosJaPrecificados >= funcionariosExtras) break;
      }
      return Number(precoTotal.toFixed(2));
    }

    function gerarCardsDePlano() {
      listaPlanosContainer.innerHTML = "";
      planosParaExibir.forEach((num) => {
        const preco = calcularPreco(num);
        const isDesabilitado = num < licencasNecessarias;
        const card = document.createElement("div");
        card.className = `card-plano ${isDesabilitado ? "desabilitado" : ""}`;
        card.dataset.funcionarios = num;
        card.innerHTML = `
          <h3 class="titulo">Plano para até ${num} Funcionários</h3>
          <p class="preco">${preco.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
          })}<span>/mês</span></p>
          <p class="descricao">${
            isDesabilitado
              ? "Este plano não comporta a sua equipa atual."
              : "Ideal para equipas em crescimento."
          }</p>
        `;
        card.addEventListener("click", () => {
          if (isDesabilitado) {
            erroSelecao.textContent = `Você precisa de um plano para no mínimo ${licencasNecessarias} funcionários.`;
            // DEBUG: clique em plano desabilitado
            console.debug("DEBUG: Plano desabilitado clicado", { num, licencasNecessarias });
            return;
          }
          document
            .querySelectorAll(".card-plano")
            .forEach((c) => c.classList.remove("selecionado"));
          card.classList.add("selecionado");
          planoSelecionado = { totalFuncionarios: num };
          btnPagar.disabled = false;
          btnPagar.textContent = `Pagar Assinatura (${preco.toLocaleString(
            "pt-BR",
            { style: "currency", currency: "BRL" }
          )})`;
          erroSelecao.textContent = "";
          // DEBUG: plano selecionado
          console.debug("DEBUG: Plano selecionado", planoSelecionado);
        });
        listaPlanosContainer.appendChild(card);
      });
      // DEBUG: Planos gerados
      console.debug("DEBUG: gerarCardsDePlano concluído", { licencasNecessarias, planosParaExibir });
    }

    async function inicializarPagina(user, empresaId) {
      try {
        console.debug("DEBUG: inicializarPagina chamada", { userUid: user.uid, empresaId });
        const response = await fetch(getStatusUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ empresaId: empresaId }),
        });

        // DEBUG: resposta do fetch verificarEmpresa
        console.debug("DEBUG: Response status verificarEmpresa", { status: response.status });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          // DEBUG: erro recebido do backend
          console.debug("DEBUG: Erro backend verificarEmpresa", errorData);
          throw new Error(
            errorData.error || "Não foi possível verificar os dados da empresa."
          );
        }

        const data = await response.json();
        // DEBUG: dados recebidos do backend
        console.debug("DEBUG: Dados recebidos verificarEmpresa", data);
        licencasNecessarias = data.licencasNecessarias;
        infoUsuarioDiv.textContent = `A sua empresa precisa de ${licencasNecessarias} licenças. Selecione um plano compatível.`;
        gerarCardsDePlano();
      } catch (error) {
        console.error("Erro ao inicializar página:", error);
        infoUsuarioDiv.textContent =
          error.message || "Ocorreu um erro. Tente novamente mais tarde.";
        infoUsuarioDiv.style.color = "#dc2626";
        sessionStorage.removeItem("empresaId");
        localStorage.removeItem("empresaAtivaId");
        setTimeout(() => {
          window.location.href = "selecionar-empresa.html";
        }, 3000);
        return;
      }
    }

    onAuthStateChanged(auth, (user) => {
      // DEBUG: onAuthStateChanged disparado
      console.debug("DEBUG: onAuthStateChanged", { user });

      if (user) {
        let empresaId =
          sessionStorage.getItem("empresaId") ||
          localStorage.getItem("empresaAtivaId");

        // DEBUG: empresaId antes de buscar em URL
        console.debug("DEBUG: empresaId buscado em storage", { empresaId });

        if (!empresaId) {
          const urlParams = new URLSearchParams(window.location.search);
          empresaId = urlParams.get("empresaId");
          // DEBUG: empresaId buscado em URL
          console.debug("DEBUG: empresaId buscado em URL", { empresaId });
          if (empresaId) {
            sessionStorage.setItem("empresaId", empresaId);
            localStorage.setItem("empresaAtivaId", empresaId);
          }
        }

        if (!empresaId) {
          infoUsuarioDiv.textContent =
            "Nenhuma empresa selecionada. A redirecionar...";
          infoUsuarioDiv.style.color = "#dc2626";
          // DEBUG: empresaId não encontrado
          console.debug("DEBUG: empresaId não encontrado, redirecionando");
          setTimeout(() => {
            window.location.href = "selecionar-empresa.html";
          }, 2500);
          return;
        }

        inicializarPagina(user, empresaId);
      } else {
        infoUsuarioDiv.textContent =
          "Você não está logado. A redirecionar para o login...";
        // DEBUG: usuário não logado
        console.debug("DEBUG: usuário não logado, redirecionando");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 2500);
      }
    });

    btnPagar.addEventListener("click", async () => {
      // DEBUG: clique no botão pagar
      console.debug("DEBUG: Clique no btnPagar", { planoSelecionado });

      if (!planoSelecionado) return;
      const user = auth.currentUser;
      const empresaId =
        sessionStorage.getItem("empresaId") ||
        localStorage.getItem("empresaAtivaId");
      // DEBUG: dados antes do pagamento
      console.debug("DEBUG: dados para pagamento", { user, empresaId, planoSelecionado });

      if (!user || !empresaId) {
        erroSelecao.textContent =
          "Erro: Utilizador ou empresa não identificados. Por favor, selecione a empresa novamente.";
        console.debug("DEBUG: Falha de identificação user ou empresaId");
        return;
      }

      btnPagar.disabled = true;
      btnPagar.textContent = "A criar link de pagamento...";

      try {
        const response = await fetch(createPreferenceUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // CORREÇÃO: Enviando o ID do usuário e da empresa separadamente.
          body: JSON.stringify({
            userId: user.uid, // O ID do usuário autenticado
            empresaId: empresaId, // O ID da empresa que está pagando
            planoEscolhido: { totalFuncionarios: planoSelecionado.totalFuncionarios },
          }),
        });

        // DEBUG: resposta do fetch createPreference
        console.debug("DEBUG: Response status createPreference", { status: response.status });

        if (!response.ok) {
          const err = await response.json();
          // DEBUG: erro recebido do backend createPreference
          console.debug("DEBUG: Erro backend createPreference", err);
          throw new Error(err.error || "Erro do servidor");
        }

        const preference = await response.json();
        // DEBUG: preference recebido
        console.debug("DEBUG: preference recebido", preference);

        if (preference.init_point) {
          window.location.href = preference.init_point;
        } else {
          throw new Error("Não foi possível gerar o link de pagamento.");
        }
      } catch (error) {
        console.error("Erro ao pagar:", error);
        erroSelecao.textContent = error.message;
        btnPagar.disabled = false;
        btnPagar.textContent = "Tentar Novamente";
      }
    });
  </script>
</body>
</html>
