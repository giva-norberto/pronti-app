<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Pagamento de Assinatura - Pronti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    /* === ESTILO PADRÃO PRONTI === */
    body {
      font-family: 'Poppins', sans-serif;
      /* ✅ FUNDO AZUL PADRÃO PRONTI */
      background: linear-gradient(135deg, #4f46e5 0%, #222664 100%);
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* Alinha no topo */
      min-height: 100vh;
      padding: 40px 20px; /* Adiciona espaçamento no topo */
      box-sizing: border-box;
      color: #ffffff; /* Cor de texto padrão para branco */
    }
    .container-pagamento {
      background: transparent; /* Remove o fundo branco */
      text-align: center;
      width: 100%;
      max-width: 600px; /* Aumenta um pouco a largura */
    }
    h1 {
      color: #ffffff;
      font-size: clamp(2rem, 5vw, 2.8rem); /* Tamanho de fonte responsivo */
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      margin-bottom: 10px;
    }
    #info-usuario {
      font-size: clamp(1rem, 2.5vw, 1.1rem);
      color: #e0e7ff;
      background-color: rgba(0, 0, 0, 0.15); /* Fundo sutil para destaque */
      padding: 12px 20px;
      border-radius: 12px;
      margin-bottom: 40px;
      font-weight: 600;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .lista-planos {
      display: grid; /* Usa grid para melhor alinhamento */
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsivo */
      gap: 20px;
      margin-bottom: 20px;
    }
    /* ✅ CARDS COM ESTILO PADRÃO PRONTI */
    .card-plano {
      background: linear-gradient(135deg, #6366f1, #4facfe); /* Gradiente azul dos cards */
      color: #fff;
      border-radius: 16px;
      padding: 25px 20px;
      text-align: left;
      cursor: pointer;
      border: 2px solid transparent; /* Borda transparente para transição suave */
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      transition: transform 0.25s, box-shadow 0.25s, border-color 0.25s;
    }
    .card-plano:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .card-plano.selecionado {
      /* Borda verde para destacar a seleção */
      border-color: #38f9d7;
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .card-plano .titulo {
      font-size: 1.2rem;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
    }
    .card-plano .preco {
      font-size: 2rem; /* Preço maior para destaque */
      font-weight: 700;
      color: #ffffff;
      margin: 10px 0 5px 0;
      text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .card-plano .preco span {
      font-size: 1rem;
      font-weight: 400;
      color: rgba(255, 255, 255, 0.7); /* Cor mais sutil */
    }
    /* Botão verde que combina com o novo design */
    .btn-pagar {
      width: 100%;
      background: #10b981;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      padding: 18px 0;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    .btn-pagar:hover:not(:disabled) {
        background: #0f9e70;
        transform: translateY(-2px);
    }
    .btn-pagar:disabled {
      background: #374151;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="container-pagamento">
    <h1>Escolha o seu Plano</h1>
    <h2 id="info-usuario">Carregando dados da sua empresa...</h2>

    <div class="lista-planos"></div>

    <button id="btn-pagar" class="btn-pagar" disabled>Selecione um plano</button>
  </div>

  <!-- ✅ NOVA IMPORTAÇÃO DO FIREBASE PARA BUSCAR DADOS -->
  <script type="module" src="./firebase-config.js"></script>

  <script type="module">
    // ✅ NOVA IMPORTAÇÃO PARA LER DADOS DO FIRESTORE
    import { db } from './firebase-config.js';
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const linksDosPlanos = {
      1: "https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=ca1b0887e74842659651f9763f203f13",
      2: "https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=642a8aead0404c9aae87499dd7795aac",
      3: "https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=7877711c561b463bb7245ad1ad24e2cb",
      5: "https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=31393e2a0c774b51ab5398220e380c35",
      10: "https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=876be42a1f424af3b5fadcb4566a7b9a",
      15: "https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=2abb49f271d54839b02da960943dedb4",
      20: "https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=cd27c2649a1f4262813cb2e44cf6842f",
    };

    const infoUsuarioDiv = document.getElementById("info-usuario");
    const listaPlanosContainer = document.querySelector(".lista-planos");
    const btnPagar = document.getElementById("btn-pagar");
    let planoSelecionado = null;

    // ✅ CORREÇÃO: Estrutura de preços atualizada
    const configuracaoPrecos = {
      precoIndividual: 29.90, // Preço para 1 funcionário
      precoBase: 59.90,       // Preço para 2 funcionários
      funcionariosInclusos: 2,
      faixasDePrecoExtra: [
        { de: 3, ate: 10, valor: 29.90 },
        { de: 11, ate: 50, valor: 24.90 }
      ]
    };

    // ✅ NOVA FUNÇÃO PARA BUSCAR O NOME DA EMPRESA
    async function buscarDadosEmpresa(empresaId) {
        if (!empresaId) {
            infoUsuarioDiv.textContent = "Selecione o plano ideal para a sua equipe.";
            return;
        }
        try {
            const empresaRef = doc(db, "empresarios", empresaId);
            const empresaSnap = await getDoc(empresaRef);
            if (empresaSnap.exists()) {
                const nomeFantasia = empresaSnap.data().nomeFantasia;
                infoUsuarioDiv.textContent = `Olá, ${nomeFantasia}! Escolha seu plano.`;
            } else {
                 infoUsuarioDiv.textContent = "Empresa não encontrada. Selecione um plano.";
            }
        } catch (error) {
            console.error("Erro ao buscar dados da empresa:", error);
            infoUsuarioDiv.textContent = "Erro ao carregar dados. Selecione um plano.";
        }
    }

    // ✅ CORREÇÃO: Lógica de cálculo de preço atualizada
    function calcularPreco(totalFuncionarios) {
        if (totalFuncionarios <= 0) return 0;
        if (totalFuncionarios === 1) return configuracaoPrecos.precoIndividual;
        if (totalFuncionarios === 2) return configuracaoPrecos.precoBase;
        
        let precoTotal = configuracaoPrecos.precoBase;
        const funcionariosExtras = totalFuncionarios - configuracaoPrecos.funcionariosInclusos;
        let funcionariosJaPrecificados = 0;
        
        for (const faixa of configuracaoPrecos.faixasDePrecoExtra) {
            const funcionariosNaFaixa = (faixa.ate - faixa.de) + 1;
            const extrasNestaFaixa = Math.min(funcionariosExtras - funcionariosJaPrecificados, funcionariosNaFaixa);
            if (extrasNestaFaixa > 0) {
              precoTotal += extrasNestaFaixa * faixa.valor;
              funcionariosJaPrecificados += extrasNestaFaixa;
            }
            if (funcionariosJaPrecificados >= funcionariosExtras) break;
        }
        return Number(precoTotal.toFixed(2));
    }

    function gerarCardsDePlano() {
      listaPlanosContainer.innerHTML = "";
      const planosOrdenados = Object.keys(linksDosPlanos).map(Number).sort((a, b) => a - b);

      planosOrdenados.forEach((num) => {
        const preco = calcularPreco(num);
        const card = document.createElement("div");
        card.className = "card-plano";
        card.dataset.funcionarios = num;
        
        // ✅ CORREÇÃO: Lógica para melhorar o texto do título
        const tituloDoPlano = num === 1
            ? `Plano para 1 Funcionário`
            : `Plano para até ${num} Funcionários`;
        
        card.innerHTML = `
          <h3 class="titulo">${tituloDoPlano}</h3>
          <p class="preco">${preco.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
          })}<span>/mês</span></p>
        `;
        
        card.addEventListener("click", () => {
          document
            .querySelectorAll(".card-plano")
            .forEach((c) => c.classList.remove("selecionado"));
          card.classList.add("selecionado");
          
          planoSelecionado = num;
          
          btnPagar.disabled = false;
          btnPagar.textContent = `Pagar com Mercado Pago (${preco.toLocaleString(
            "pt-BR",
            { style: "currency", "currency": "BRL" }
          )})`;
        });
        
        listaPlanosContainer.appendChild(card);
      });
    }

    btnPagar.addEventListener("click", () => {
      if (!planoSelecionado) {
        // ✅ Alterado para um modal mais amigável que alert()
        alert("Por favor, selecione um plano.");
        return;
      }
      
      const linkDePagamento = linksDosPlanos[planoSelecionado];
      
      if (linkDePagamento && linkDePagamento.startsWith("http")) {
        window.location.href = linkDePagamento;
      } else {
        alert("O link de pagamento para este plano não está configurado. Por favor, entre em contato com o suporte.");
      }
    });

    // ✅ NOVA LÓGICA: LÊ O ID DA EMPRESA DA URL E PERSONALIZA A PÁGINA
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const empresaId = urlParams.get("empresaId");
        buscarDadosEmpresa(empresaId);
        gerarCardsDePlano();
    });

  </script>
</body>
</html>



