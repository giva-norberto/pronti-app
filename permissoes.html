<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Configurações Globais - Pronti</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- ✅ ESTILOS ATUALIZADOS APENAS PARA OS NOVOS ELEMENTOS -->
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f1f5f9; }
        .container { max-width: 800px; margin: 32px auto; background: #fff; padding: 32px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08 ); }
        h2 { color: #4f46e5; font-weight: 700; border-bottom: 2px solid #eef2ff; padding-bottom: 12px; }
        p { color: #64748b; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; }
        th { background: #f8fafc; font-weight: 600; color: #475569; }
        button { margin-top: 32px; padding: 12px 24px; cursor: pointer; background-color: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; transition: background-color 0.2s; }
        button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #4338ca; }
        input[type=checkbox] { width: 20px; height: 20px; cursor: pointer; accent-color: #4f46e5; }
        .config-section { margin-bottom: 40px; }
        .form-group { margin-top: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; }
        .logo-upload-container { display: flex; align-items: center; gap: 16px; }
        #logo-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
        .btn-upload { padding: 10px 16px; font-size: 0.95rem; background: #f1f5f9; color: #475569; border: 1px dashed #cbd5e1; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .btn-upload:hover { background: #eef2ff; border-color: #4f46e5; color: #4f46e5; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ✅ INÍCIO DA NOVA SEÇÃO DE UPLOAD DE LOGO -->
        <div class="config-section">
            <h2>Logo do Aplicativo</h2>
            <div class="form-group">
                <label for="logo-upload">Logo Padrão do Menu Lateral</label>
                <div class="logo-upload-container">
                    <img id="logo-preview" src="https://placehold.co/80x80/eef2ff/4f46e5?text=Logo" alt="Pré-visualização do logo">
                    <div>
                        <input type="file" id="logo-upload-input" accept="image/png, image/jpeg" style="display: none;">
                        <button type="button" id="btn-upload-logo" class="btn-upload">
                            <i class="fa-solid fa-arrow-up-from-bracket"></i> Escolher Arquivo
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ✅ FIM DA NOVA SEÇÃO -->

        <div class="config-section">
            <h2>Permissões Globais de Menu</h2>
            <p>Defina quais menus cada papel (Funcionário / Dono / Admin ) pode acessar em TODAS as empresas.</p>
            <table>
                <thead>
                    <tr>
                        <th>Menu</th>
                        <th>Funcionário</th>
                        <th>Dono</th>
                        <th>Admin</th>
                    </tr>
                </thead>
                <tbody id="permissoes-tabela"></tbody>
            </table>
        </div>
        
        <button id="salvar">Salvar Todas as Configurações</button>
    </div>

    <script type="module">
        // ✅ ADICIONADAS IMPORTAÇÕES DO STORAGE
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

        // --- SUA LÓGICA DE ACESSO ORIGINAL (NÃO FOI ALTERADA ) ---
        const ADMIN_UID = "BX6Q7HrVMrcCBqe72r7K76EBPkX2"; 

        // ✅ NOVOS ELEMENTOS DO DOM PARA O UPLOAD
        const logoPreview = document.getElementById("logo-preview");
        const logoUploadInput = document.getElementById("logo-upload-input");
        const btnUploadLogo = document.getElementById("btn-upload-logo");
        
        // --- SEUS ELEMENTOS ORIGINAIS ---
        const permissoesTabela = document.getElementById("permissoes-tabela");
        const salvarBtn = document.getElementById("salvar");

        // --- SUAS VARIÁVEIS ORIGINAIS ---
        const menus = [ "inicio", "dashboard", "agenda", "equipe", "servicos", "clientes", "perfil", "relatorios", "administracao", "permissoes" ];
        let permissoesAtuais = {};
        
        // ✅ NOVA VARIÁVEL PARA O ARQUIVO DE LOGO
        let logoFile = null;

        // ✅ NOVA LÓGICA PARA SELECIONAR E PRÉ-VISUALIZAR O LOGO
        btnUploadLogo.addEventListener('click', () => logoUploadInput.click());
        logoUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                logoFile = file; // Guarda o arquivo para o upload
                const reader = new FileReader();
                reader.onload = (e) => {
                    logoPreview.src = e.target.result; // Mostra a pré-visualização
                };
                reader.readAsDataURL(file);
            }
        });

        // ✅ FUNÇÃO ATUALIZADA PARA CARREGAR TAMBÉM A URL DO LOGO
        async function carregarConfiguracoesGlobais() {
            const ref = doc(db, "configuracoesGlobais", "permissoes");
            const snap = await getDoc(ref);
            
            // Lógica original de carregar permissões
            permissoesAtuais = snap.exists() ? snap.data().menus || {} : {};

            // Nova lógica para carregar o logo
            if (snap.exists() && snap.data().logoUrlPadrao) {
                logoPreview.src = snap.data().logoUrlPadrao;
            }
            
            // Lógica original para preencher a tabela
            menus.forEach(menu => {
                if (!permissoesAtuais[menu]) {
                    permissoesAtuais[menu] = { funcionario: true, dono: true, admin: true };
                }
            });
            renderTabela();
        }

        // --- SUA FUNÇÃO ORIGINAL (NÃO FOI ALTERADA) ---
        function renderTabela() {
            permissoesTabela.innerHTML = menus.map(menu => `\n                <tr>\n                    <td>${menu}</td>\n                    <td><input type=\"checkbox\" data-menu=\"${menu}\" data-role=\"funcionario\" ${permissoesAtuais[menu].funcionario ? \"checked\" : \"\"}></td>\n                    <td><input type=\"checkbox\" data-menu=\"${menu}\" data-role=\"dono\" ${permissoesAtuais[menu].dono ? \"checked\" : \"\"}></td>\n                    <td><input type=\"checkbox\" data-menu=\"${menu}\" data-role=\"admin\" ${permissoesAtuais[menu].admin ? \"checked\" : \"\"}></td>\n                </tr>\n            `).join("");
        }

        // ✅ FUNÇÃO ATUALIZADA PARA SALVAR O LOGO E AS PERMISSÕES
        salvarBtn.addEventListener("click", async () => {
            salvarBtn.disabled = true;
            salvarBtn.textContent = 'A Salvar...';

            try {
                const configParaSalvar = {};

                // 1. Nova lógica: Faz o upload do novo logo, se houver um
                if (logoFile) {
                    const storage = getStorage();
                    // O caminho fixo garante que o logo seja sempre o mesmo arquivo no Storage
                    const storageRef = ref(storage, 'config/logo-pronti-app.png'); 
                    await uploadBytes(storageRef, logoFile);
                    const downloadURL = await getDownloadURL(storageRef);
                    // Adiciona a URL ao objeto que será salvo no Firestore
                    configParaSalvar.logoUrlPadrao = downloadURL; 
                }

                // 2. Sua lógica original para salvar permissões
                const checkboxes = document.querySelectorAll("input[type=checkbox]");
                const novasPermissoes = {};
                checkboxes.forEach(chk => {
                    const menu = chk.dataset.menu;
                    const role = chk.dataset.role;
                    if (!novasPermissoes[menu]) novasPermissoes[menu] = {};
                    novasPermissoes[menu][role] = chk.checked;
                });
                // Adiciona as permissões atualizadas ao objeto
                configParaSalvar.menus = novasPermissoes;

                // 3. Salva tudo (logo + permissões) no mesmo documento
                await setDoc(doc(db, "configuracoesGlobais", "permissoes"), configParaSalvar, { merge: true });
                console.log("Configurações globais salvas com sucesso!");
                logoFile = null; // Limpa o arquivo após o upload

            } catch (error) {
                console.error("Erro ao salvar configurações:", error);
                console.error("Ocorreu um erro ao salvar as configurações.");
            } finally {
                salvarBtn.disabled = false;
                salvarBtn.textContent = 'Salvar Todas as Configurações';
            }
        });

        // --- SUA LÓGICA DE ACESSO ORIGINAL (NÃO FOI ALTERADA) ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else if (user.uid !== ADMIN_UID) {
                console.error("Acesso negado. Apenas Administrador.");
                window.location.href = "index.html";
            } else {
                // Atualizado para chamar a nova função que carrega tudo
                carregarConfiguracoesGlobais(); 
            }
        });
    </script>
</body>
</html>
