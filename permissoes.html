<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Configurações Globais - Pronti</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f1f5f9; }
        .container { max-width: 800px; margin: 32px auto; background: #fff; padding: 32px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08 ); }
        h2 { color: #4f46e5; font-weight: 700; border-bottom: 2px solid #eef2ff; padding-bottom: 12px; }
        p { color: #64748b; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; }
        th { background: #f8fafc; font-weight: 600; color: #475569; }
        button { margin-top: 32px; padding: 12px 24px; cursor: pointer; background-color: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; transition: background-color 0.2s; }
        button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #4338ca; }
        input[type=checkbox] { width: 20px; height: 20px; cursor: pointer; accent-color: #4f46e5; }
        .config-section { margin-bottom: 40px; }
        .form-group { margin-top: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; }
        .logo-upload-container { display: flex; align-items: center; gap: 16px; }
        #logo-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
        .btn-upload { padding: 10px 16px; font-size: 0.95rem; background: #f1f5f9; color: #475569; border: 1px dashed #cbd5e1; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .btn-upload:hover { background: #eef2ff; border-color: #4f46e5; color: #4f46e5; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Seção de upload de logo -->
        <div class="config-section">
            <h2>Logo do Aplicativo</h2>
            <div class="form-group">
                <label for="logo-upload">Logo Padrão do Menu Lateral</label>
                <div class="logo-upload-container">
                    <img id="logo-preview" src="https://placehold.co/80x80/eef2ff/4f46e5?text=Logo" alt="Pré-visualização do logo">
                    <div>
                        <input type="file" id="logo-upload-input" accept="image/png, image/jpeg" style="display: none;">
                        <button type="button" id="btn-upload-logo" class="btn-upload">
                            <i class="fa-solid fa-arrow-up-from-bracket"></i> Escolher Arquivo
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fim da seção de upload de logo -->

        <div class="config-section">
            <h2>Permissões Globais de Menu</h2>
            <p>Defina quais menus cada papel (Funcionário / Dono / Admin) pode acessar em TODAS as empresas.</p>
            <table>
                <thead>
                    <tr>
                        <th>Menu</th>
                        <th>Funcionário</th>
                        <th>Dono</th>
                        <th>Admin</th>
                    </tr>
                </thead>
                <tbody id="permissoes-tabela"></tbody>
            </table>
        </div>
        
        <button id="salvar">Salvar Todas as Configurações</button>
    </div>

    <script type="module">
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

        // Lista de UIDs de administradores permitidos
        const ADMIN_UIDS = [ "BX6Q7HrVMrcCBqe72r7K76EBPkX2" ]; // Adicione mais UIDs se necessário

        // Elementos DOM
        const logoPreview = document.getElementById("logo-preview");
        const logoUploadInput = document.getElementById("logo-upload-input");
        const btnUploadLogo = document.getElementById("btn-upload-logo");
        const permissoesTabela = document.getElementById("permissoes-tabela");
        const salvarBtn = document.getElementById("salvar");

        // Menus e permissões
        const menus = [ "inicio", "dashboard", "agenda", "equipe", "servicos", "clientes", "perfil", "relatorios", "administracao", "permissoes" ];
        let permissoesAtuais = {};
        let logoFile = null;

        // Função auxiliar para checar permissão para 1 ou mais papéis (igual menu lateral/index)
        function temPermissao(menus, id, papelUsuario) {
            if (!menus[id]) return false;
            if (Array.isArray(papelUsuario)) {
                return papelUsuario.some(papel => menus[id][papel] === true);
            } else {
                return menus[id][papelUsuario] === true;
            }
        }

        // Função para obter os papéis do usuário igual index/menu lateral
        async function obterPapeisUsuario(user) {
            const perfilSnap = await getDoc(doc(db, "usuarios", user.uid));
            let perfil = perfilSnap.exists() ? perfilSnap.data() : {};
            let papeisUsuario = [];
            if (perfil.papeis && Array.isArray(perfil.papeis) && perfil.papeis.length > 0) {
                papeisUsuario = perfil.papeis;
            } else {
                if (perfil.isAdmin) papeisUsuario.push('admin');
                if (perfil.isOwner) papeisUsuario.push('dono');
                if (perfil.papel && papeisUsuario.length === 0) papeisUsuario.push(perfil.papel);
            }
            return papeisUsuario;
        }

        // Checagem de permissão de acesso à página
        async function checarPermissaoAcesso(user) {
            if (!user) {
                window.location.href = "login.html";
                return false;
            }
            // Permite se UID está na lista OU se tem papel 'admin'
            const perfilSnap = await getDoc(doc(db, "usuarios", user.uid));
            const perfil = perfilSnap.exists() ? perfilSnap.data() : {};
            const isAdminUid = ADMIN_UIDS.includes(user.uid);
            const isAdminPapel = perfil.isAdmin === true || (perfil.papeis && perfil.papeis.includes("admin"));
            if (!isAdminUid && !isAdminPapel) {
                alert("Acesso restrito apenas a administradores.");
                window.location.href = "index.html";
                return false;
            }

            // Busca permissões globais
            const refDoc = doc(db, "configuracoesGlobais", "permissoes");
            const snap = await getDoc(refDoc);
            const regras = snap.exists() ? snap.data() : {};
            const menusGlobais = regras.menus || {};
            const papeisUsuario = await obterPapeisUsuario(user);

            if (!temPermissao(menusGlobais, "administracao", papeisUsuario)) {
                alert("Você não tem permissão para acessar esta página.");
                window.location.href = "index.html";
                return false;
            }
            return true;
        }

        // Upload e preview logo
        btnUploadLogo.addEventListener('click', () => logoUploadInput.click());
        logoUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                logoFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    logoPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Carrega configurações globais do Firestore
        async function carregarConfiguracoesGlobais() {
            const refDoc = doc(db, "configuracoesGlobais", "permissoes");
            const snap = await getDoc(refDoc);

            permissoesAtuais = snap.exists() ? snap.data().menus || {} : {};
            if (snap.exists() && snap.data().logoUrlPadrao) {
                logoPreview.src = snap.data().logoUrlPadrao;
            }
            menus.forEach(menu => {
                if (!permissoesAtuais[menu]) {
                    permissoesAtuais[menu] = { funcionario: true, dono: true, admin: true };
                }
            });
            renderTabela();
        }

        // Renderiza a tabela de permissões
        function renderTabela() {
            permissoesTabela.innerHTML = menus.map(menu => `
                <tr>
                    <td>${menu}</td>
                    <td><input type="checkbox" data-menu="${menu}" data-role="funcionario" ${permissoesAtuais[menu].funcionario ? "checked" : ""}></td>
                    <td><input type="checkbox" data-menu="${menu}" data-role="dono" ${permissoesAtuais[menu].dono ? "checked" : ""}></td>
                    <td><input type="checkbox" data-menu="${menu}" data-role="admin" ${permissoesAtuais[menu].admin ? "checked" : ""}></td>
                </tr>
            `).join("");
        }

        // Salva as configurações no Firestore
        salvarBtn.addEventListener("click", async () => {
            salvarBtn.disabled = true;
            salvarBtn.textContent = 'A Salvar...';

            try {
                const configParaSalvar = {};

                if (logoFile) {
                    const storage = getStorage();
                    const storageRef = ref(storage, 'config/logo-pronti-app.png'); 
                    await uploadBytes(storageRef, logoFile);
                    const downloadURL = await getDownloadURL(storageRef);
                    configParaSalvar.logoUrlPadrao = downloadURL; 
                }
                const checkboxes = document.querySelectorAll("input[type=checkbox]");
                const novasPermissoes = {};
                checkboxes.forEach(chk => {
                    const menu = chk.dataset.menu;
                    const role = chk.dataset.role;
                    if (!novasPermissoes[menu]) novasPermissoes[menu] = {};
                    novasPermissoes[menu][role] = chk.checked;
                });
                configParaSalvar.menus = novasPermissoes;
                await setDoc(doc(db, "configuracoesGlobais", "permissoes"), configParaSalvar, { merge: true });
                logoFile = null;
            } catch (error) {
                console.error("Erro ao salvar configurações:", error);
            } finally {
                salvarBtn.disabled = false;
                salvarBtn.textContent = 'Salvar Todas as Configurações';
            }
        });

        // Permissão de acesso por UID OU por papel de admin
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                // Checa permissão global antes de liberar
                if (await checarPermissaoAcesso(user)) {
                    carregarConfiguracoesGlobais();
                }
            }
        });
    </script>
</body>
</html>
