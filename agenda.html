<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronti - Minha Agenda</title>
    <!-- Google Fonts e Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSS do Pronti -->
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div id="sidebar-placeholder"></div>
    <script>
        // Inclusão dinâmica do menu lateral e destaque do menu de agenda
        document.addEventListener("DOMContentLoaded", function() {
            fetch('menu-lateral.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('sidebar-placeholder').innerHTML = html;
                    // Destaca o item de agenda após inclusão do menu
                    const links = document.querySelectorAll('.sidebar-links a');
                    links.forEach(link => link.classList.remove('active'));
                    const agendaLink = document.querySelector('.sidebar-links a[href="agenda.html"]');
                    if (agendaLink) {
                        agendaLink.classList.add('active');
                    }
                    // Ativar botão sair, se necessário (caso menu-lateral.html não ative internamente)
                    if (window.ativarLogout) window.ativarLogout();
                });
        });
    </script>
    <main class="main-content">
        <!-- Cabeçalho da página -->
        <div class="page-header">
            <h1>Minha Agenda</h1>
            <a href="novo-agendamento.html" class="btn btn-primary" id="btn-novo-agendamento">
                <i class="fa-solid fa-plus"></i>
                Novo Agendamento
            </a>
        </div>

        <!-- Filtros principais REVISADOS -->
        <div class="filtros-agenda" id="filtros-agenda">
            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap: wrap;">
                
                <!-- Botões de Modo -->
                <button id="btn-agenda-semana" class="btn btn-outline active">
                    <i class="fa-solid fa-calendar-week"></i> Agenda da Semana
                </button>
                <button id="btn-historico" class="btn btn-outline">
                    <i class="fa-solid fa-clock-rotate-left"></i> Histórico
                </button>

                <!-- Filtros da Semana (agora junto aos botões ) -->
                <div id="filtros-semana-container" style="display:flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                    <div class="filtro-item">
                        <label for="data-semana">Data</label>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="date" id="data-semana" class="filtro-input">
                            <button id="btn-semana-proxima" class="btn btn-light" title="Próxima semana">
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filtro de Profissional -->
                <div class="filtro-item" id="filtro-profissional-item">
                    <label for="filtro-profissional">Profissional</label>
                    <select id="filtro-profissional" class="filtro-select"></select>
                </div>
            </div>
        </div>

        <!-- Legenda da semana -->
        <div id="legenda-container" style="margin: 8px 0; font-size: 0.9em; color: #555;">
             <small id="legenda-semana">
                Mostrando agendamentos de <span id="semana-inicio"></span> a <span id="semana-fim"></span>
            </small>
        </div>

        <!-- Filtros de data para histórico (continua escondido por padrão) -->
        <div id="filtros-historico" style="display:none; margin: 16px 0; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
            <div class="filtro-item">
                <label for="data-inicial">De:</label>
                <input type="date" id="data-inicial" class="filtro-input">
            </div>
            <div class="filtro-item">
                <label for="data-final">Até:</label>
                <input type="date" id="data-final" class="filtro-input">
            </div>
            <button id="btn-aplicar-historico" class="btn btn-secondary">
                <i class="fa-solid fa-filter"></i> Aplicar
            </button>
            <button id="btn-mes-atual" class="btn btn-light">
                <i class="fa-solid fa-calendar"></i> Mês Atual
            </button>
        </div>
        
        <!-- Lista de agendamentos -->
        <div id="lista-agendamentos" class="dashboard-cards">
            <p id="agendamentos-placeholder">A carregar agendamentos...</p>
        </div>
    </main>

    <!-- MODAL DE CONFIRMAÇÃO -->
    <div id="modal-confirmacao" class="modal-overlay">
        <div class="modal-card">
            <h3 id="modal-titulo">Confirmar Ação</h3>
            <p id="modal-mensagem">Você tem certeza que deseja continuar?</p>
            <div class="modal-botoes">
                <button id="btn-modal-cancelar" class="btn">Cancelar</button>
                <button id="btn-modal-confirmar" class="btn btn-remove">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- MENU LATERAL DINÂMICO -->
    <script type="module" src="menu-loader.js"></script>
    
    <!-- SCRIPT PRINCIPAL DA AGENDA (agenda.js) -->
    <script type="module">
        /**
         * agenda.js - Pronti (Versão Final Revisada)
         * - Filtra APENAS agendamentos com status 'ativo' para a data atual e futuras.
         * - O modo Histórico continua mostrando todos os status.
         * - Layout dos filtros foi limpo e reorganizado.
         */

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";

        // Firebase
        const app = initializeApp(firebaseConfig );
        const db = getFirestore(app);
        const auth = getAuth(app);

        // DOM Elements
        const listaAgendamentosDiv = document.getElementById("lista-agendamentos");
        const filtroProfissionalEl = document.getElementById("filtro-profissional");
        const btnAgendaSemana = document.getElementById("btn-agenda-semana");
        const btnHistorico = document.getElementById("btn-historico");
        const filtrosSemanaContainer = document.getElementById("filtros-semana-container");
        const inputDataSemana = document.getElementById("data-semana");
        const semanaInicioEl = document.getElementById("semana-inicio");
        const semanaFimEl = document.getElementById("semana-fim");
        const btnSemanaProxima = document.getElementById('btn-semana-proxima');
        const legendaContainer = document.getElementById("legenda-container");
        const filtrosHistoricoDiv = document.getElementById("filtros-historico");
        const dataInicialEl = document.getElementById("data-inicial");
        const dataFinalEl = document.getElementById("data-final");
        const btnAplicarHistorico = document.getElementById("btn-aplicar-historico");
        const btnMesAtual = document.getElementById("btn-mes-atual");

        let empresaId = null;
        let perfilUsuario = "dono";
        let meuUid = null;
        let modoAgenda = "semana";

        // ----------- UTILITÁRIOS -----------
        function mostrarToast(texto, cor = '#38bdf8') {
            if (typeof Toastify !== "undefined") {
                Toastify({ text: texto, duration: 4000, gravity: "top", position: "center", style: { background: cor, color: "white", borderRadius: "8px" } }).showToast();
            } else {
                alert(texto);
            }
        }
        function formatarDataISO(data) { return data.toISOString().split('T')[0]; }
        function formatarDataBrasileira(dataISO) {
            if (!dataISO || dataISO.length !== 10) return dataISO;
            const [ano, mes, dia] = dataISO.split("-");
            return `${dia}/${mes}/${ano}`;
        }

        // ----------- LÓGICA DE DATAS -----------
        function getPeriodoSemana(dataBaseStr) {
            const inicio = new Date(dataBaseStr + 'T00:00:00Z');
            const fim = new Date(inicio);
            const diaDaSemana = inicio.getUTCDay();
            const diasAteSabado = 6 - diaDaSemana;
            fim.setUTCDate(inicio.getUTCDate() + diasAteSabado);
            return { inicioISO: formatarDataISO(inicio), fimISO: formatarDataISO(fim) };
        }

        function atualizarLegendaSemana() {
            if (inputDataSemana.value && semanaInicioEl && semanaFimEl) {
                const { inicioISO, fimISO } = getPeriodoSemana(inputDataSemana.value);
                semanaInicioEl.textContent = formatarDataBrasileira(inicioISO);
                semanaFimEl.textContent = formatarDataBrasileira(fimISO);
            }
        }

        // ----------- AUTENTICAÇÃO E PERFIL -----------
        onAuthStateChanged(auth, async (user) => {
            if (!user) return window.location.href = "login.html";
            meuUid = user.uid;
            try {
                empresaId = await getEmpresaIdDoDonoOuFuncionario(user.uid);
                if (empresaId) {
                    perfilUsuario = await checarTipoUsuario(user.uid, empresaId);
                    await inicializarPaginaAgenda();
                } else {
                    exibirMensagemDeErro("Empresa não encontrada.");
                }
            } catch (error) {
                exibirMensagemDeErro("Ocorreu um erro ao iniciar a página.");
                console.error("Erro na inicialização:", error);
            }
        });

        async function getEmpresaIdDoDonoOuFuncionario(uid) {
            let q = query(collection(db, "empresarios"), where("donoId", "==", uid));
            let snapshot = await getDocs(q);
            if (!snapshot.empty) return snapshot.docs[0].id;
            q = query(collection(db, "empresarios"));
            snapshot = await getDocs(q);
            for (const docEmp of snapshot.docs) {
                const profSnap = await getDocs(query(collection(db, "empresarios", docEmp.id, "profissionais"), where("__name__", "==", uid)));
                if (!profSnap.empty) return docEmp.id;
            }
            return null;
        }

        async function checarTipoUsuario(uid, empresaId) {
            const docEmp = await getDocs(query(collection(db, "empresarios"), where("donoId", "==", uid), where("__name__", "==", empresaId)));
            return docEmp.empty ? "funcionario" : "dono";
        }

        // ----------- INICIALIZAÇÃO DA PÁGINA -----------
        async function inicializarPaginaAgenda() {
            if (perfilUsuario === "dono") {
                await popularFiltroProfissionais();
            } else {
                document.getElementById("filtro-profissional-item").style.display = "none";
            }
            inputDataSemana.value = formatarDataISO(new Date());
            configurarListeners();
            ativarModoAgenda('semana');
        }

        function configurarListeners() {
            btnAgendaSemana.addEventListener("click", () => ativarModoAgenda("semana"));
            btnHistorico.addEventListener("click", () => ativarModoAgenda("historico"));
            filtroProfissionalEl.addEventListener("change", carregarAgendamentosConformeModo);
            inputDataSemana.addEventListener("change", carregarAgendamentosConformeModo);
            btnSemanaProxima.addEventListener("click", () => {
                const dataAtual = new Date(inputDataSemana.value + 'T00:00:00Z');
                dataAtual.setUTCDate(dataAtual.getUTCDate() + 7);
                inputDataSemana.value = formatarDataISO(dataAtual);
                carregarAgendamentosConformeModo();
            });
            btnAplicarHistorico.addEventListener("click", carregarAgendamentosHistorico);
            btnMesAtual.addEventListener("click", () => {
                preencherCamposMesAtual();
                carregarAgendamentosHistorico();
            });
        }

        function carregarAgendamentosConformeModo() {
            if (modoAgenda === 'semana') {
                carregarAgendamentosSemana();
            } else if (modoAgenda === 'historico') {
                // Não faz nada, espera o botão aplicar
            }
        }

        function ativarModoAgenda(modo) {
            modoAgenda = modo;
            filtrosSemanaContainer.style.display = (modo === 'semana') ? 'flex' : 'none';
            legendaContainer.style.display = (modo === 'semana') ? 'block' : 'none';
            filtrosHistoricoDiv.style.display = (modo === 'historico') ? 'flex' : 'none';
            btnAgendaSemana.classList.toggle("active", modo === "semana");
            btnHistorico.classList.toggle("active", modo === "historico");
            
            if (modo === 'semana') {
                carregarAgendamentosSemana();
            } else {
                listaAgendamentosDiv.innerHTML = `<p>Selecione um período e clique em "Aplicar" para ver o histórico.</p>`;
            }
        }

        // ----------- FILTRO PROFISSIONAL -----------
        async function popularFiltroProfissionais() {
            try {
                const snapshot = await getDocs(collection(db, "empresarios", empresaId, "profissionais"));
                filtroProfissionalEl.innerHTML = '<option value="todos">Todos os Profissionais</option>';
                snapshot.forEach(doc => {
                    filtroProfissionalEl.appendChild(new Option(doc.data().nome, doc.id));
                });
            } catch (error) {
                mostrarToast("Erro ao buscar profissionais.", "#ef4444");
            }
        }

        // ----------- CARREGAMENTO DE AGENDAMENTOS -----------
        async function buscarEExibirAgendamentos(constraints, mensagemVazio, isHistorico = false) {
            listaAgendamentosDiv.innerHTML = `<p>Carregando agendamentos...</p>`;
            try {
                const ref = collection(db, "empresarios", empresaId, "agendamentos");
                
                // Adiciona o filtro de status 'ativo' se não for histórico
                if (!isHistorico) {
                    constraints.push(where("status", "==", "ativo"));
                }

                const q = query(ref, ...constraints, orderBy("data"), orderBy("horario"));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    listaAgendamentosDiv.innerHTML = `<p>${mensagemVazio}</p>`;
                    return;
                }
                exibirCardsAgendamento(snapshot.docs, isHistorico);
            } catch (error) {
                exibirMensagemDeErro("Ocorreu um erro ao carregar os agendamentos.");
                console.error(error);
            }
        }

        function exibirCardsAgendamento(docs, isHistorico) {
            listaAgendamentosDiv.innerHTML = '';
            docs.forEach(doc => {
                const ag = { id: doc.id, ...doc.data() };

                let statusLabel = "<span class='status-label status-ativo'>Ativo</span>";
                if (isHistorico) { // Só mostra outros status se for histórico
                    if (ag.status === "cancelado_pelo_gestor" || ag.status === "cancelado") statusLabel = "<span class='status-label status-cancelado'>Cancelado</span>";
                    else if (ag.status === "nao_compareceu") statusLabel = "<span class='status-label status-falta'>Falta</span>";
                    else if (ag.status === "realizado") statusLabel = "<span class='status-label status-realizado'>Realizado</span>";
                }
                
                const cardElement = document.createElement('div');
                cardElement.className = 'card card--agenda';
                cardElement.innerHTML = `
                    <div class="card-title">${ag.servicoNome || 'Serviço não informado'}</div>
                    <div class="card-info">
                        <p><b>Cliente:</b> ${ag.clienteNome || "Não informado"}</p>
                        <p><b>Profissional:</b> ${ag.profissionalNome || "Não informado"}</p>
                        <p>
                            <i class="fa-solid fa-calendar-day"></i>
                            <span class="card-agenda-dia">${formatarDataBrasileira(ag.data)}</span>
                            <i class="fa-solid fa-clock"></i>
                            <span class="card-agenda-hora">${ag.horario || "Não informada"}</span>
                        </p>
                        <p><b>Status:</b> ${statusLabel}</p>
                    </div>`;
                listaAgendamentosDiv.appendChild(cardElement);
            });
            if (listaAgendamentosDiv.childElementCount === 0) {
                listaAgendamentosDiv.innerHTML = `<p>Nenhum agendamento encontrado para os critérios selecionados.</p>`;
            }
        }

        // ----------- MODOS DE CARREGAMENTO ESPECÍFICOS -----------
        function carregarAgendamentosSemana() {
            atualizarLegendaSemana();
            const { inicioISO, fimISO } = getPeriodoSemana(inputDataSemana.value);
            const constraints = [where("data", ">=", inicioISO), where("data", "<=", fimISO)];
            const profissionalId = perfilUsuario === "dono" ? filtroProfissionalEl.value : meuUid;
            if (profissionalId !== 'todos') {
                constraints.push(where("profissionalId", "==", profissionalId));
            }
            buscarEExibirAgendamentos(constraints, "Nenhum agendamento ativo para esta semana.");
        }

        function carregarAgendamentosHistorico() {
            const dataIni = dataInicialEl.value;
            const dataFim = dataFinalEl.value;
            if (!dataIni || !dataFim) {
                mostrarToast("Por favor, selecione as datas de início e fim.", "#ef4444");
                return;
            }
            const constraints = [where("data", ">=", dataIni), where("data", "<=", dataFim)];
            const profissionalId = perfilUsuario === "dono" ? filtroProfissionalEl.value : meuUid;
            if (profissionalId !== 'todos') {
                constraints.push(where("profissionalId", "==", profissionalId));
            }
            buscarEExibirAgendamentos(constraints, "Nenhum agendamento encontrado no histórico para este período.", true);
        }

        // ----------- FUNÇÕES AUXILIARES -----------
        function preencherCamposMesAtual() {
            const hoje = new Date();
            const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            if(dataInicialEl) dataInicialEl.value = formatarDataISO(primeiroDia);
            if(dataFinalEl) dataFinalEl.value = formatarDataISO(ultimoDia);
        }

        function exibirMensagemDeErro(mensagem) {
            if (listaAgendamentosDiv) {
                listaAgendamentosDiv.innerHTML = `<p style='color: #ef4444; text-align: center;'>${mensagem}</p>`;
            }
        }
    </script>
</body>
</html>
