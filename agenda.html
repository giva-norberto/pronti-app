/**
 * agenda-livre.js - Módulo NÃO DESTRUTIVO para a Agenda Livre.
 * Este script é carregado DEPOIS do agenda.js principal e 
 * "ouve" os botões e filtros existentes sem modificar a lógica original.
 * * Ele usa exatamente a lógica do 'vitrini-agendamento.js' que você forneceu.
 */

// Importa as funções do Firebase que você já usa
import { db } from "./firebase-config.js";
import {
  collection,
  getDocs,
  query,
  where,
  doc,
  getDoc,
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// Pega a empresaId do localStorage, assim como seu script principal
let empresaId = localStorage.getItem("empresaAtivaId");

// Cache local de profissionais (para evitar buscar toda hora)
let allProfissionaisCache = null;

// ======================================================================
// 1. FUNÇÕES DE LÓGICA (Exatamente como você pediu, do vitrini-agendamento.js)
// ======================================================================

function timeStringToMinutes(timeStr) {
    if (!timeStr) return 0;
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
}

function minutesToTimeString(totalMinutes) {
    const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
    const minutes = (totalMinutes % 60).toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}

function getLocalYYYYMMDD(dateObj = new Date()) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

async function profissionalTemAusencia(empresaId, profissionalId, dataYYYYMMDD) {
    try {
        if (!empresaId || !profissionalId || !dataYYYYMMDD) return false;
        const ausRef = collection(db, 'empresarios', empresaId, 'profissionais', profissionalId, 'ausencias');
        const q = query(ausRef, where('data', '==', dataYYYYMMDD));
        const snap = await getDocs(q);
        return !snap.empty;
    } catch (err) {
        console.warn('Erro ao verificar ausência do profissional:', err);
        return false;
    }
}

async function buscarAgendamentosDoDia(empresaId, data) {
    try {
        const agendamentosRef = collection(db, 'empresarios', empresaId, 'agendamentos');
        const q = query(
            agendamentosRef,
            where("data", "==", data),
            where("status", "==", "ativo")
        );
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
        console.error("Erro ao buscar agendamentos do dia:", error);
        return [];
    }
}

function calcularSlotsDisponiveis(data, agendamentosDoDia, horariosTrabalho, duracaoSlot) {
    const diaDaSemana = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
    const [year, month, day] = data.split('-').map(Number);
    const dataObj = new Date(year, month - 1, day); 
    const nomeDia = diaDaSemana[dataObj.getDay()];

    const diaDeTrabalho = horariosTrabalho?.[nomeDia];
    if (!diaDeTrabalho || !diaDeTrabalho.ativo || !diaDeTrabalho.blocos || diaDeTrabalho.blocos.length === 0) {
        return [];
    }

    // Garante que o intervalo seja um número e tenha um padrão
    const intervaloEntreSessoes = Number(horariosTrabalho.intervalo) || Number(duracaoSlot) || 30;
    const slotsDisponiveis = [];

    const horariosOcupados = agendamentosDoDia.map(ag => {
        const inicio = timeStringToMinutes(ag.horario);
        const fim = inicio + (Number(ag.servicoDuracao) || 30); // Padrão de 30min se duração não estiver definida
        return { inicio, fim };
    });

    const hoje = new Date();
    const ehHoje = getLocalYYYYMMDD(hoje) === data;
    const minutosAgora = timeStringToMinutes(
        `${hoje.getHours().toString().padStart(2, '0')}:${hoje.getMinutes().toString().padStart(2, '0')}`
    );

    for (const bloco of diaDeTrabalho.blocos) {
        let slotAtualEmMinutos = timeStringToMinutes(bloco.inicio);
        const fimDoBlocoEmMinutos = timeStringToMinutes(bloco.fim);

        // A "duração" do slot é o próprio intervalo do profissional
        const duracaoSlotReal = intervaloEntreSessoes;

        while (slotAtualEmMinutos + duracaoSlotReal <= fimDoBlocoEmMinutos) {
            const fimDoSlotProposto = slotAtualEmMinutos + duracaoSlotReal;
            
            let temConflito = horariosOcupados.some(ocupado =>
                (slotAtualEmMinutos < ocupado.fim && fimDoSlotProposto > ocupado.inicio)
            );

            if (!temConflito && (!ehHoje || slotAtualEmMinutos > minutosAgora)) {
                slotsDisponiveis.push(minutesToTimeString(slotAtualEmMinutos));
            }
            slotAtualEmMinutos += intervaloEntreSessoes;
        }
    }
    return slotsDisponiveis;
}

// ======================================================================
// 2. FUNÇÕES DA "AGENDA LIVRE"
// ======================================================================

/**
 * Pega os 7 dias da semana a partir da data de início.
 */
function getWeekDays(startDate) {
    const dates = [];
    const [year, month, day] = startDate.split('-').map(Number);
    const start = new Date(year, month - 1, day);

    for (let i = 0; i < 7; i++) {
        const newDate = new Date(start);
        newDate.setDate(start.getDate() + i);
        dates.push(getLocalYYYYMMDD(newDate));
    }
    return dates;
}

/**
 * Busca e armazena em cache os profissionais (evita rodar a lógica do agenda.js)
 */
async function getAllProfissionais() {
    if (allProfissionaisCache) {
        return allProfissionaisCache;
    }
    
    // Seu agenda.js já popula o select, este script vai apenas ler os dados
    // Esta é uma forma mais segura de pegar os dados sem re-buscar
    const filtroProfissionalEl = document.getElementById("filtro-profissional");
    if (!filtroProfissionalEl || filtroProfissionalEl.options.length <= 1) {
        // Se o agenda.js ainda não populou, esperamos e tentamos de novo
        await new Promise(resolve => setTimeout(resolve, 500)); 
        // Se ainda assim não houver, buscamos manualmente
        if (filtroProfissionalEl.options.length <= 1) {
             console.warn("agenda-livre.js: Buscando profissionais manualmente...");
             const snapshot = await getDocs(collection(db, "empresarios", empresaId, "profissionais"));
             allProfissionaisCache = await Promise.all(snapshot.docs.map(async (docSnap) => {
                const horariosRef = doc(db, "empresarios", empresaId, "profissionais", docSnap.id, "configuracoes", "horarios");
                const horariosSnap = await getDoc(horariosRef);
                return { id: docSnap.id, ...docSnap.data(), horarios: horariosSnap.exists() ? horariosSnap.data() : null };
             }));
             return allProfissionaisCache;
        }
    }

    // Se o agenda.js JÁ populou, lemos do <select> e buscamos os horários
    allProfissionaisCache = [];
    for (const option of filtroProfissionalEl.options) {
        if (option.value && option.value !== 'todos') {
             const profId = option.value;
             const horariosRef = doc(db, "empresarios", empresaId, "profissionais", profId, "configuracoes", "horarios");
             const horariosSnap = await getDoc(horariosRef);
             allProfissionaisCache.push({
                id: profId,
                nome: option.text,
                horarios: horariosSnap.exists() ? horariosSnap.data() : null
             });
        }
    }
    return allProfissionaisCache;
}

/**
 * Renderiza o HTML para um único dia de horários livres.
 */
function renderizarDiaLivre(data, slots, estaAusente) {
    const [year, month, day] = data.split('-').map(Number);
    const dataObj = new Date(year, month - 1, day);
    const diaSemana = dataObj.toLocaleDateString('pt-BR', { weekday: 'long' });
    const diaMes = dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });

    let slotsHtml = '';
    if (estaAusente) {
        slotsHtml = '<span class="slot-ausente">Ausente</span>';
    } else if (slots && slots.length > 0) {
        slotsHtml = slots.map(slot => `<span class="slot-livre">${slot}</span>`).join('');
    } else {
        slotsHtml = '<span class="slot-ocupado">Sem horários livres</span>';
    }

    return `
        <div class="dia-livre-card"> 
            <div class="dia-header">
                <h3>${diaSemana.charAt(0).toUpperCase() + diaSemana.slice(1)}</h3>
                <span>${diaMes}</span>
            </div>
            <div class="slots-container">
                ${slotsHtml}
            </div>
        </div>
    `;
}

/**
 * Função principal para buscar e exibir a agenda livre.
 */
async function carregarAgendaLivre(filtroProfissionalEl, dataSemanaInput, listaAgendamentosDiv) {
    const profissionalId = filtroProfissionalEl.value;
    const dataSelecionada = dataSemanaInput.value;
    
    if (!empresaId) {
        console.error("Agenda Livre: ID da empresa não encontrado.");
        listaAgendamentosDiv.innerHTML = '<p id="agendamentos-placeholder">Erro: ID da empresa não encontrado.</p>';
        return;
    }
    
    if (!profissionalId || profissionalId === 'todos') {
        listaAgendamentosDiv.innerHTML = '<p id="agendamentos-placeholder">Por favor, selecione um profissional específico para ver os horários livres.</p>';
        return;
    }

    // Busca os profissionais (do cache ou do FB)
    const allProfissionais = await getAllProfissionais();
    const profissional = allProfissionais.find(p => p.id === profissionalId);

    if (!profissional || !profissional.horarios) {
        listaAgendamentosDiv.innerHTML = '<p id="agendamentos-placeholder">Não foi possível carregar os horários deste profissional (horários não configurados).</p>';
        return;
    }

    listaAgendamentosDiv.innerHTML = '<p id="agendamentos-placeholder">Buscando horários disponíveis...</p>';
    
    const datasDaSemana = getWeekDays(dataSelecionada);
    let htmlOutput = '';
    const duracaoSlot = Number(profissional.horarios.intervalo) || 30;

    for (const dataString of datasDaSemana) {
        const estaAusente = await profissionalTemAusencia(empresaId, profissionalId, dataString);
        
        if (estaAusente) {
            htmlOutput += renderizarDiaLivre(dataString, null, true);
            continue;
        }

        const agendamentos = await buscarAgendamentosDoDia(empresaId, dataString);
        const agendamentosProfissional = agendamentos.filter(ag => ag.profissionalId === profissionalId);
        
        const slots = calcularSlotsDisponiveis(
            dataString,
            agendamentosProfissional,
            profissional.horarios,
            duracaoSlot
        );
        
        htmlOutput += renderizarDiaLivre(dataString, slots, false);
    }
    
    listaAgendamentosDiv.innerHTML = htmlOutput || '<p id="agendamentos-placeholder">Nenhum horário encontrado para esta semana.</p>';
}

// ======================================================================
// 3. EVENT LISTENERS (Conecta-se à página sem alterar agenda.js)
// ======================================================================

// Espera o DOM estar pronto (garante que agenda.js já rodou)
document.addEventListener("DOMContentLoaded", () => {
    // Pega os elementos que o agenda.js já usa
    const btnAgendaDia = document.getElementById("btn-agenda-dia");
    const btnAgendaSemana = document.getElementById("btn-agenda-semana");
    const btnHistorico = document.getElementById("btn-historico");
    const btnAgendaLivre = document.getElementById("btn-agenda-livre");
    
    const filtroProfissionalEl = document.getElementById("filtro-profissional");
    const dataSemanaInput = document.getElementById("data-semana");
    const listaAgendamentosDiv = document.getElementById("lista-agendamentos");
    const filtrosSemana = document.getElementById("filtros-semana-container");
    const filtrosHistoricoDiv = document.getElementById("filtros-historico");
    const legendaContainer = document.getElementById("legenda-container");

    if (!btnAgendaLivre) return; // Sai se o botão não existir

    const allBtns = [btnAgendaDia, btnAgendaSemana, btnHistorico, btnAgendaLivre];

    // Adiciona o clique ao NOVO botão
    btnAgendaLivre.addEventListener('click', (e) => {
        // 1. Ativa o botão
        allBtns.forEach(btn => btn?.classList.remove('active'));
        btnAgendaLivre.classList.add('active');
        
        // 2. Mostra os filtros corretos (os mesmos da "Agenda da Semana")
        if (filtrosHistoricoDiv) filtrosHistoricoDiv.style.display = 'none';
        if (filtrosSemana) filtrosSemana.style.display = 'flex';
        if (legendaContainer) legendaContainer.style.display = 'block';
        
        // 3. Chama a nova função
        carregarAgendaLivre(filtroProfissionalEl, dataSemanaInput, listaAgendamentosDiv);
    });

    // Adiciona "ouvintes" aos filtros, que SÓ rodam se a aba "Agenda Livre" estiver ativa
    filtroProfissionalEl?.addEventListener('change', () => {
        if (btnAgendaLivre.classList.contains('active')) {
            carregarAgendaLivre(filtroProfissionalEl, dataSemanaInput, listaAgendamentosDiv);
        }
    });

    dataSemanaInput?.addEventListener('change', () => {
        if (btnAgendaLivre.classList.contains('active')) {
            carregarAgendaLivre(filtroProfissionalEl, dataSemanaInput, listaAgendamentosDiv);
        }
    });

    // Faz os botões ORIGINAIS desativarem o botão "Agenda Livre"
    // Isso garante que o estado do seu agenda.js original comande
    btnAgendaDia?.addEventListener('click', () => btnAgendaLivre.classList.remove('active'));
    btnAgendaSemana?.addEventListener('click', () => btnAgendaLivre.classList.remove('active'));
    btnHistorico?.addEventListener('click', () => btnAgendaLivre.classList.remove('active'));
});
