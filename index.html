<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronti - In√≠cio</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <!-- FontAwesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CORRE√á√ÉO DE SEGURAN√áA APLICADA -->
    <style>
        body.is-loading {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
    <!-- FIM SEGURAN√áA -->
</head>
<body class="dashboard-body is-loading">

<!-- Sidebar (menu lateral) incluso dinamicamente -->
<div id="sidebar-placeholder"></div>

<main class="main-content">
 <!-- CABE√áALHO DE BOAS-VINDAS CENTRALIZADO -->
 <div class="dashboard-welcome-center">
   <h1>Bom dia, <span id="nome-usuario">Usu√°rio</span>!</h1>
   <p>Pronto para gerenciar seu dia?</p>
 </div>

 <!-- A√á√ïES PRINCIPAIS -->
 <div class="dashboard-main-actions">
   <a href="dashboard.html" class="action-card">
       <i class="fa-solid fa-chart-line"></i>
       <span>Painel Inteligente</span>
   </a>
   <a href="agenda.html" class="action-card">
       <i class="fa-solid fa-calendar-check"></i>
       <span>Agenda</span>
   </a>
   <a href="servicos.html" class="action-card" id="acao-servicos">
       <i class="fa-solid fa-scissors"></i>
       <span>Servi√ßos</span>
   </a>
 </div>

 <!-- BOT√ÉO DE STATUS -->
 <button class="status-button">Ver status de hoje</button>
</main>

<!-- SCRIPT PRINCIPAL UNIFICADO -->
<script type="module">
    // 1. Importa√ß√µes dos m√≥dulos Firebase
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { auth } from "./vitrini-firebase.js";
    import { verificarAcesso } from "./userService.js";

    const nomeUsuarioSpan = document.getElementById("nome-usuario");

    // Fun√ß√£o para gerar o menu HTML conforme o tipo de usu√°rio
    function gerarMenuLateral(tipoUsuario) {
        if (tipoUsuario === "dono") {
            return `
                <aside class="sidebar" id="sidebar">
                    <a href="index.html" class="sidebar-brand">Pronti</a>
                    <hr />
                    <nav class="sidebar-links">
                        <a href="index.html"><span>üè†</span> In√≠cio</a>
                        <a href="dashboard.html"><span>üìä</span> Dashboard</a>
                        <a href="servicos.html"><span>üõ†Ô∏è</span> Servi√ßos</a>
                        <a href="agenda.html"><span>üìÖ</span> Agenda</a>
                        <a href="clientes.html"><span>üë§</span> Clientes</a>
                        <a href="equipe.html"><span>üë•</span> Equipe</a>
                        <a href="perfil.html"><span>üôç‚Äç‚ôÇÔ∏è</span> Meu Perfil</a>
                    </nav>
                    <div class="sidebar-footer">
                        <button id="btn-logout" class="btn-logout">Sair</button>
                    </div>
                </aside>
            `;
        } else if (tipoUsuario === "funcionario") {
            return `
                <aside class="sidebar" id="sidebar">
                    <a href="index.html" class="sidebar-brand">Pronti</a>
                    <hr />
                    <nav class="sidebar-links">
                        <a href="agenda.html"><span>üìÖ</span> Agenda</a>
                        <a href="perfil.html"><span>üôç‚Äç‚ôÇÔ∏è</span> Meu Perfil</a>
                    </nav>
                    <div class="sidebar-footer">
                        <button id="btn-logout" class="btn-logout">Sair</button>
                    </div>
                </aside>
            `;
        } else {
            // fallback para seguran√ßa: n√£o mostra nada
            return "";
        }
    }

    // Fun√ß√£o para destacar o link ativo
    function destacarLinkAtivo() {
        const links = document.querySelectorAll('.sidebar-links a');
        let current = window.location.pathname.split('/').pop().toLowerCase();
        links.forEach(link => link.classList.remove('active'));
        links.forEach(link => {
            let href = link.getAttribute('href').split('?')[0].toLowerCase();
            if (
                href === current ||
                (href.replace('.html', '') === current.replace('.html', '')) ||
                (href === 'index.html' && (current === '' || current === 'index.html'))
            ) {
                link.classList.add('active');
            }
        });
    }

    // Fun√ß√£o para ativar o logout
    function ativarLogout() {
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
            btnLogout.addEventListener('click', () => {
                signOut(auth).then(() => {
                    window.location.replace('login.html');
                }).catch((error) => {
                    console.error('Erro ao fazer logout:', error);
                });
            });
        }
    }

    // 2. L√≥gica de Autentica√ß√£o e Roteamento por Permiss√£o
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                // Chama o "porteiro" para saber quem est√° logado.
                const { perfil, isOwner } = await verificarAcesso();

                // Define o tipo de usu√°rio
                const tipoUsuario = isOwner ? 'dono' : 'funcionario';

                // Redirecionamento seguro: funcion√°rio n√£o acessa tela do dono (index)
                if (!isOwner) {
                    window.location.replace('agenda.html');
                    return;
                }

                // Sauda√ß√£o personalizada
                const primeiroNome = perfil.nome ? perfil.nome.split(' ')[0] : 'Usu√°rio';
                if (nomeUsuarioSpan) {
                    nomeUsuarioSpan.textContent = primeiroNome;
                }

                // Carrega o menu lateral correto
                document.getElementById('sidebar-placeholder').innerHTML = gerarMenuLateral(tipoUsuario);

                // Destaca o link ativo no menu lateral
                destacarLinkAtivo();

                // Ativa o logout
                ativarLogout();

                // Exibe a p√°gina
                document.body.classList.remove('is-loading');
            } catch (error) {
                console.log("Verifica√ß√£o de acesso interrompida:", error.message);
            }
        } else {
            // Usu√°rio n√£o est√° logado, redireciona para o login.
            window.location.replace('login.html');
        }
    });
</script>

</body>
</html>
