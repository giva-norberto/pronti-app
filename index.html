<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Pronti - Início</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos principais da página */
        .dashboard-body { display: flex; }
        .main-content {
            margin-left: 240px; /* Deixa espaço para o sidebar que será carregado */
            flex-grow: 1;
            padding: 20px;
            color: #333; /* Cor de texto padrão */
        }
        /* Estilos para o card de primeiro acesso */
        .primeiro-acesso-card {
            max-width: 400px; margin: 80px auto; padding: 36px 28px; border-radius: 22px;
            background: linear-gradient(135deg, #e3ecfa 0%, #f7fafd 100% );
            text-align: center;
        }
        .primeiro-acesso-card h2 { color: #2563eb; }
        .primeiro-acesso-card p { color: #6b7a90; }
        .primeiro-btn { display: block; width: 100%; background: linear-gradient(90deg, #2563eb 0%, #5b9eff 100%); color: #fff; font-weight: 600; border: none; border-radius: 8px; padding: 13px 0; font-size: 1rem; cursor: pointer; }
    </style>
</head>
<body class="dashboard-body">

    <!-- O placeholder para o menu lateral, como você projetou -->
    <div id="sidebar-placeholder"></div>

    <main class="main-content" id="main-content">
        <h1>Carregando...</h1>
    </main>

    <!-- Script para carregar o menu lateral -->
    <script>
    document.addEventListener("DOMContentLoaded", function() {
      fetch('menu-lateral.html')
        .then(res => {
            if (!res.ok) { throw new Error('Erro ao carregar o menu.'); }
            return res.text();
        })
        .then(html => {
          document.getElementById('sidebar-placeholder').innerHTML = html;
          // Ativa o link correto no menu
          const links = document.querySelectorAll('.sidebar-links a');
          links.forEach(link => link.classList.remove('active'));
          const homeLink = document.querySelector('.sidebar-links a[href="index.html"]');
          if (homeLink) homeLink.classList.add('active');
        })
        .catch(error => {
            console.error("Falha ao carregar menu-lateral.html:", error);
            // Opcional: Mostrar uma mensagem de erro no lugar do menu
        });
    });
    </script>

    <!-- Script principal da página -->
    <script type="module">
        import { auth } from "./vitrini-firebase.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { verificarAcesso } from "./userService.js"; // Usando a versão ESTÁVEL do userService

        const mainContent = document.getElementById("main-content" );

        function mostrarPrimeiroAcessoCard() {
            mainContent.innerHTML = `
                <div class="primeiro-acesso-card">
                    <h2>Seja bem-vindo ao Pronti!</h2>
                    <p>O próximo passo é cadastrar sua empresa.</p>
                    <a href="perfil.html" class="primeiro-btn">Cadastrar Minha Empresa</a>
                </div>
            `;
        }

        function mostrarDashboard(perfil) {
            mainContent.innerHTML = `
                <h1>Bem-vindo de volta, ${perfil.nomeFantasia || 'Usuário'}!</h1>
                <p>Seu dashboard está pronto.</p>
            `;
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usamos o setTimeout para dar tempo do menu carregar e da conexão estabilizar
                setTimeout(async () => {
                    try {
                        const userSession = await verificarAcesso();
                        mostrarDashboard(userSession.perfil);
                    } catch (error) {
                        if (error.message === "primeiro_acesso") {
                            mostrarPrimeiroAcessoCard();
                        } else {
                            mainContent.innerHTML = `<h1>Erro: ${error.message}</h1>`;
                        }
                    }
                }, 200);
            } else {
                window.location.replace('login.html');
            }
        });
    </script>

</body>
</html>
