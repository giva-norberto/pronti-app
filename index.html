<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronti - Início</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <!-- FontAwesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ====================================================================== -->
    <!--                      CORREÇÃO DE SEGURANÇA APLICADA                      -->
    <!-- ====================================================================== -->
    <!-- Este estilo esconde a página até que o script verifique quem é o usuário,
         impedindo que um funcionário veja a tela do dono por um instante. -->
    <style>
        body.is-loading {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
    <!-- ====================================================================== -->
</head>
<!-- A página começa com a classe 'is-loading' para ficar oculta -->
<body class="dashboard-body is-loading">

<!-- Sidebar (menu lateral) incluso dinamicamente -->
<div id="sidebar-placeholder"></div>

<main class="main-content">
 <!-- CABEÇALHO DE BOAS-VINDAS CENTRALIZADO -->
 <div class="dashboard-welcome-center">
   <h1>Bom dia, <span id="nome-usuario">Usuário</span>!</h1>
   <p>Pronto para gerenciar seu dia?</p>
 </div>

 <!-- AÇÕES PRINCIPAIS -->
 <div class="dashboard-main-actions">
   <a href="dashboard.html" class="action-card">
       <i class="fa-solid fa-chart-line"></i>
       <span>Painel Inteligente</span>
   </a>
   <a href="agenda.html" class="action-card">
       <i class="fa-solid fa-calendar-check"></i>
       <span>Agenda</span>
   </a>
   <a href="servicos.html" class="action-card" id="acao-servicos">
       <i class="fa-solid fa-scissors"></i>
       <span>Serviços</span>
   </a>
 </div>

 <!-- BOTÃO DE STATUS -->
 <button class="status-button">Ver status de hoje</button>
</main>

<!-- SCRIPT PRINCIPAL UNIFICADO -->
<script type="module">
    // 1. Importações dos módulos Firebase
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { auth } from "./vitrini-firebase.js"; 
    // A verificação de acesso foi restaurada para esta página ser o "porteiro".
    import { verificarAcesso } from "./userService.js";

    const nomeUsuarioSpan = document.getElementById("nome-usuario");

    // 2. Lógica de Autenticação e Roteamento por Permissão
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                // Chama o "porteiro" para saber quem está logado.
                const { perfil, isOwner } = await verificarAcesso();

                // Se o usuário NÃO for o dono, redireciona para a agenda.
                if (!isOwner) {
                    window.location.replace('agenda.html'); // .replace() é melhor para não criar histórico
                    return; // Impede que o resto do script desta página seja executado.
                }
                
                // Se for o dono, a página continua a carregar normalmente.
                const primeiroNome = perfil.nome ? perfil.nome.split(' ')[0] : 'Usuário';
                if (nomeUsuarioSpan) {
                    nomeUsuarioSpan.textContent = primeiroNome;
                }

                // Carrega o menu do dono.
                await carregarMenuEControlarAcesso();

                // Apenas depois de confirmar que é o dono, a página se torna visível.
                document.body.classList.remove('is-loading');

            } catch (error) {
                // Se verificarAcesso rejeitar (ex: durante um redirecionamento do login),
                // o erro é capturado aqui e a página não continua a carregar.
                console.log("Verificação de acesso interrompida:", error.message);
            }
        } else {
            // Usuário não está logado, redireciona para o login.
            window.location.replace('login.html');
        }
    });

    // 3. Carregamento Dinâmico do Menu Lateral (agora apenas para o dono)
    async function carregarMenuEControlarAcesso() {
        try {
            const response = await fetch('menu-lateral.html');
            if (!response.ok) throw new Error('Erro ao carregar menu.');
            
            const html = await response.text();
            document.getElementById('sidebar-placeholder').innerHTML = html;
            
            // --- DESTAQUE DO LINK ATIVO ---
            const homeLink = document.querySelector('.sidebar-links a[href="index.html"]');
            if (homeLink) {
                document.querySelectorAll('.sidebar-links a.active').forEach(link => link.classList.remove('active'));
                homeLink.classList.add('active');
            }

            // --- LÓGICA DE LOGOUT ---
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) {
                btnLogout.addEventListener('click', () => {
                    signOut(auth).then(() => {
                        window.location.replace('login.html');
                    }).catch((error) => {
                        console.error('Erro ao fazer logout:', error);
                    });
                });
            }
        } catch (error) {
            console.error(error);
        }
    }
</script>

</body>
</html>
