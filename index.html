<!-- ... (todo o seu HTML e <head> do index.html permanecem inalterados) ... -->

<script type="module">
    // ======================================================================
    //                      SCRIPT DE DIAGNÓSTICO FINAL
    // ======================================================================
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { auth } from "./vitrini-firebase.js";
    import { verificarAcesso, ensureUserAndTrialDoc } from "./userService.js";

    // Seleciona os elementos da página
    const nomeUsuarioSpan = document.getElementById("nome-usuario" );
    const saudacaoSpan = document.getElementById("saudacao");
    const mainContent = document.getElementById("main-content");
    const nomeEmpresaSpan = document.getElementById("nome-empresa-ativa");

    // Função para mostrar os dados de diagnóstico na tela
    function displayDebugInfo(title, data) {
        const debugBox = document.createElement('div');
        debugBox.style.position = 'fixed';
        debugBox.style.bottom = '10px';
        debugBox.style.left = '10px';
        debugBox.style.background = 'rgba(0, 0, 0, 0.8)';
        debugBox.style.color = '#00ff00';
        debugBox.style.padding = '15px';
        debugBox.style.borderRadius = '8px';
        debugBox.style.zIndex = '9999';
        debugBox.style.fontFamily = 'monospace';
        debugBox.style.fontSize = '14px';
        debugBox.innerHTML = `
            <h3>${title}</h3>
            <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
        document.body.appendChild(debugBox);
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                // 1. Chama a função de verificação como sempre
                const userSession = await verificarAcesso();

                // 2. MOSTRA NA TELA O QUE FOI RECEBIDO
                // Esta é a parte mais importante. Vamos ver o que o index.html realmente recebeu.
                displayDebugInfo("Resultado do verificarAcesso()", userSession);

                // 3. Pega os dados recebidos para usar
                const { perfil, role } = userSession;

                // 4. Lógica de redirecionamento baseada nos dados recebidos
                if (role === 'funcionario') {
                    displayDebugInfo("DECISÃO:", { motivo: "role é 'funcionario'", redirecionando_para: "agenda.html" });
                    // window.location.replace('agenda.html'); // Temporariamente desativado para podermos ver o debug
                    alert("Redirecionamento para AGENDA foi bloqueado para depuração. Verifique o console e a caixa de diagnóstico.");
                    return;
                }

                // Se não redirecionou, continua a carregar a página
                const primeiroNome = perfil.nome ? perfil.nome.split(' ')[0] : 'Usuário';
                if (nomeUsuarioSpan) nomeUsuarioSpan.textContent = primeiroNome;
                // ... (resto da sua lógica para carregar o nome, saudação, etc.)

                document.body.classList.remove('is-loading'); // Mostra a página

            } catch (error) {
                // Se o verificarAcesso() falhar, mostra o erro na tela
                displayDebugInfo("ERRO no verificarAcesso()", { mensagem: error.message });
            }
        } else {
            // Se não houver usuário, mostra isso também
            displayDebugInfo("ERRO", { motivo: "Nenhum usuário logado", redirecionando_para: "login.html" });
            // window.location.replace('login.html');
        }
    });
</script>

</body>
</html>
