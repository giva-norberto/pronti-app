<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Administração de Clientes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Estilos globais da sua aplicação -->
    <link href="style.css" rel="stylesheet" type="text/css" />
    
    <!-- Estilos específicos para esta página de administração -->
    <style>
        body { font-family: Arial, sans-serif; background-color: #f6f7fb; }
        .container { max-width: 800px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); padding: 32px; }
        h2 { font-size: 1.7em; margin-bottom: 24px; color: #1a202c; }
        .empresa { border: 1px solid #e2e8f0; margin-bottom: 32px; border-radius: 8px; padding: 16px; background: #f7fafc; }
        .empresa-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .empresa-status { font-weight: bold; }
        .btn-block { background: #e53e3e; color: #fff; border: none; border-radius: 4px; padding: 6px 18px; cursor: pointer; transition: background 0.2s; }
        .btn-block:hover { background: #c53030; }
        .btn-unblock { background: #38a169; color: #fff; border: none; border-radius: 4px; padding: 6px 18px; cursor: pointer; transition: background 0.2s; }
        .btn-unblock:hover { background: #2f855a; }
        table { width: 100%; margin-top: 16px; border-collapse: collapse; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        thead tr { background: #f7fafc; }
        tbody tr.blocked { background: #fed7d7; }
        .loading, .restricted { padding: 32px; text-align: center; font-size: 1.1em; color: #4a5568; }
        .btn-delete { background: #718096; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.9em; transition: background 0.2s; }
        .btn-delete:hover { background: #4a5568; }
        .button-group { display: flex; gap: 8px; align-items: center; }
        .trial-management { margin-top: 12px; display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
        .trial-input { width: 60px; padding: 4px 6px; border: 1px solid #cbd5e0; border-radius: 4px; }
        .btn-save-trial { background: #4299e1; color: white; padding: 4px 10px; border-radius: 4px; border: none; cursor: pointer; transition: background 0.2s; }
        .btn-save-trial:hover { background: #2b6cb0; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>

    <!-- O menu lateral é carregado aqui para garantir consistência -->
    <div id="sidebar-container"></div>

    <div class="main-content">
      <div id="conteudo-admin" class="container">
        <!-- O conteúdo da administração será renderizado aqui pelo script -->
      </div>
    </div>

    <!-- Scripts do Firebase (versão modular moderna para consistência) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js'; // Corrigido: só importe se exportar mesmo assim em firebase-config.js

        // Se o erro persistir, altere para:
        // import firebaseConfig from './firebase-config.js';
        // e exporte como default no arquivo firebase-config.js:
        // export default firebaseConfig;

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- LÓGICA DESTA PÁGINA DE ADMIN ---
        const ADMIN_UID = "BX6Q7HrVMrcCBqe72r7K76EBPkX2";
        const conteudoDiv = document.getElementById('conteudo-admin');
        let currentData = [];

        function render(html) {
            conteudoDiv.innerHTML = html;
        }

        function renderizarDados(empresas) {
            currentData = empresas;
            let htmlFinal = '<h2>Gestão de Empresas</h2>';
            if (empresas.length === 0) {
                htmlFinal += '<p>Nenhuma empresa encontrada.</p>';
            } else {
                htmlFinal += empresas.map(empresa => `
                    <div class="empresa" id="empresa-${empresa.uid}">
                        <div class="empresa-header">
                            <div>
                                <div><strong>Empresa:</strong> ${empresa.nome || empresa.email || empresa.uid}</div>
                                <div><strong>Status:</strong> <span style="color: ${empresa.bloqueado ? '#e53e3e' : '#38a169'}">${empresa.bloqueado ? 'Bloqueada' : 'Ativa'}</span></div>
                            </div>
                            <div class="button-group">
                                <button data-id="${empresa.uid}" class="btn-delete">Excluir</button>
                                <button data-id="${empresa.uid}" class="${empresa.bloqueado ? 'btn-unblock' : 'btn-block'}">
                                    ${empresa.bloqueado ? 'Desbloquear' : 'Bloquear'}
                                </button>
                            </div>
                        </div>
                        <div class="trial-management">
                            <strong>Dias de Teste:</strong>
                            <input type="number" class="trial-input" id="trial-input-${empresa.uid}" value="${empresa.freeEmDias === undefined ? 15 : empresa.freeEmDias}">
                            <button data-id="${empresa.uid}" class="btn-save-trial">Salvar</button>
                        </div>
                        <div style="margin-top: 16px;">
                            <strong>Funcionários:</strong>
                            <table>
                                <thead><tr><th>Nome</th><th>Email</th><th>Status</th></tr></thead>
                                <tbody>
                                    ${(empresa.funcionarios && empresa.funcionarios.length > 0)
                                        ? empresa.funcionarios.map(f => `
                                            <tr class="${f.bloqueado ? 'blocked' : ''}">
                                                <td>${f.nome || '-'}</td>
                                                <td>${f.email || '-'}</td>
                                                <td><span style="color: ${f.bloqueado ? '#e53e3e' : '#38a169'}">${f.bloqueado ? 'Bloqueado' : 'Ativo'}</span></td>
                                            </tr>
                                        `).join('')
                                        : '<tr><td colspan="3" style="text-align: center; color: #a0aec0;">Nenhum funcionário</td></tr>'
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            }
            render(htmlFinal);
        }

        async function carregarDados() {
            render('<div class="loading">A carregar dados das empresas...</div>');
            try {
                const snap = await getDocs(collection(db, "empresarios"));
                const empresasComFuncionarios = await Promise.all(snap.docs.map(async (empresaDoc) => {
                    const empresa = { uid: empresaDoc.id, ...empresaDoc.data() };
                    const profSnap = await getDocs(collection(doc(db, "empresarios", empresa.uid), "profissionais"));
                    empresa.funcionarios = profSnap.docs.map(p => ({ id: p.id, ...p.data() }));
                    return empresa;
                }));
                renderizarDados(empresasComFuncionarios);
            } catch (error) {
                render(`<div class="restricted" style="color: red;"><strong>Erro ao carregar dados:</strong> ${error.message}</div>`);
                console.error("Erro detalhado:", error);
            }
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === ADMIN_UID) {
                carregarDados();
            } else {
                render(`<div class="restricted">Acesso restrito a administradores. A redirecionar...</div>`);
                setTimeout(() => { window.location.href = 'index.html'; }, 3000);
            }
        });

        // --- FUNÇÕES DE AÇÃO DOS BOTÕES (AGORA COMPLETAS) ---

        async function toggleBloqueio(empresaId, novoStatus, button) {
            const acao = novoStatus ? 'bloquear' : 'desbloquear';
            if (!confirm(`Tem a certeza de que deseja ${acao} esta empresa e todos os seus funcionários?`)) return;
            
            button.disabled = true;
            button.textContent = 'Aguarde...';

            try {
                const empresaRef = doc(db, "empresarios", empresaId);
                await updateDoc(empresaRef, { bloqueado: novoStatus });

                const profCollectionRef = collection(empresaRef, "profissionais");
                const profSnap = await getDocs(profCollectionRef);
                const updates = profSnap.docs.map(p => updateDoc(p.ref, { bloqueado: novoStatus }));
                await Promise.all(updates);

                // Atualiza a UI sem recarregar a página
                const empresaIndex = currentData.findIndex(e => e.uid === empresaId);
                if (empresaIndex > -1) {
                    currentData[empresaIndex].bloqueado = novoStatus;
                    currentData[empresaIndex].funcionarios.forEach(f => f.bloqueado = novoStatus);
                    renderizarDados(currentData);
                }
            } catch (error) {
                alert(`Erro ao ${acao} a empresa.`);
                console.error(error);
                // Reverte o estado do botão em caso de erro
                button.disabled = false;
                button.textContent = novoStatus ? 'Bloquear' : 'Desbloquear';
            }
        }

        async function excluirEmpresa(empresaId, button) {
            if (!confirm("ATENÇÃO: Esta ação é irreversível. Deseja realmente EXCLUIR esta empresa e todos os seus funcionários?")) return;
            
            button.disabled = true;
            button.textContent = 'A excluir...';

            try {
                const empresaRef = doc(db, "empresarios", empresaId);
                const profCollectionRef = collection(empresaRef, "profissionais");
                const profSnap = await getDocs(profCollectionRef);
                const deletes = profSnap.docs.map(p => deleteDoc(p.ref));
                await Promise.all(deletes);
                await deleteDoc(empresaRef);
                
                alert('Empresa excluída com sucesso!');
                document.getElementById(`empresa-${empresaId}`).remove();
            } catch (error) {
                alert("Erro ao excluir a empresa.");
                console.error(error);
                button.disabled = false;
                button.textContent = 'Excluir';
            }
        }

        async function salvarDiasTeste(empresaId, button) {
            const input = document.getElementById(`trial-input-${empresaId}`);
            const novoValor = parseInt(input.value, 10);
            if (isNaN(novoValor) || novoValor < 0) {
                return alert("Por favor, insira um número válido de dias.");
            }

            button.disabled = true;
            button.textContent = '...';

            try {
                const empresaRef = doc(db, "empresarios", empresaId);
                await updateDoc(empresaRef, { freeEmDias: novoValor });
                alert('Dias de teste atualizados com sucesso!');
            } catch (error) {
                alert("Erro ao salvar os dias de teste.");
                console.error(error);
            } finally {
                button.disabled = false;
                button.textContent = 'Salvar';
            }
        }

        // Delegação de eventos para os botões
        conteudoDiv.addEventListener('click', async (event) => {
            const target = event.target;
            const empresaId = target.dataset.id;
            if (!empresaId || target.disabled) return;

            if (target.matches('.btn-block, .btn-unblock')) {
                const novoStatus = target.classList.contains('btn-block');
                toggleBloqueio(empresaId, novoStatus, target);
            } else if (target.matches('.btn-delete')) {
                excluirEmpresa(empresaId, target);
            } else if (target.matches('.btn-save-trial')) {
                salvarDiasTeste(empresaId, target);
            }
        });

        // Script para carregar o menu lateral reutilizável
        fetch('menu-lateral.html')
            .then(response => {
                if (!response.ok) throw new Error("menu-lateral.html não encontrado.");
                return response.text();
            })
            .then(data => {
                document.getElementById('sidebar-container').innerHTML = data;
            })
            .catch(error => {
                console.error("Erro ao carregar o menu lateral:", error);
                document.getElementById('sidebar-container').innerHTML = "<p style='color:red; text-align:center;'>Erro ao carregar menu.</p>";
            });
    </script>

</body>
</html>
